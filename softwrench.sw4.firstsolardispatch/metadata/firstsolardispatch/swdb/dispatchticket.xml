<?xml version="1.0" encoding="utf-8" ?>
<metadata xmlns="http://www.controltechnologysolutions.com/metadata">

  <templates>
    <template path="swdb/inverter.xml"/>
    <template path="@doclink.xml"/>
  </templates>

  <entities>
    <entity name="DispatchTicket" idAttribute="id">
      <relationships>
        <relationship to="Inverter_" qualifier="inverters" collection="true">
          <relationshipAttribute from="id" to="ticketid" primary="true"/>
        </relationship>

        <relationship to="GfedSite_" qualifier="site">
          <relationshipAttribute from="gfedid" to="gfedid" primary="true"/>
        </relationship>
      </relationships>
    </entity>

  </entities>

  <applications>

    <application entity="DispatchTicket" name="DispatchTicket" title="Dispatch Ticket">
      <properties>
        <property key="application.maindetailschema" value="editdetail"/>
        <property key="application.mainlistschema" value="list"/>
      </properties>

      <schemas>
        <list title="Dispatch Tickets Grid" platform="web">

          <filters>
            <optionfilter attribute="status" displaycode="false" style="width:300px" whereclause="status in (!@#value)" >
              <option xmlns="http://www.controltechnologysolutions.com/filters" label="Draft" value="DRAFT"/>
              <option xmlns="http://www.controltechnologysolutions.com/filters" label="Scheduled" value="SCHEDULED"/>
              <option xmlns="http://www.controltechnologysolutions.com/filters" label="Dispatched" value="DISPATCHED"/>
              <option xmlns="http://www.controltechnologysolutions.com/filters" label="Accepted" value="ACCEPTED"/>
              <option xmlns="http://www.controltechnologysolutions.com/filters" label="Rejected" value="REJECTED"/>
              <option xmlns="http://www.controltechnologysolutions.com/filters" label="Arrived" value="ARRIVED"/>
              <option xmlns="http://www.controltechnologysolutions.com/filters" label="Resolved" value="RESOLVED"/>
            </optionfilter>
            <optionfilter attribute="#worktype" provider="#workorder_.worktype_.wtypedesc" displaycode="true" style="width:300px" whereclause="worktype in (!@#value)" />
            <filter attribute="#description" style="width:300px" whereclause="description like !@#value" />
            <booleanfilter attribute="#outreq" whereclause="outreq = !@#value" />
          </filters>


          <field attribute="id" label="Ticket#"/>
          <field attribute="site_.facilitytitlewithvalue" label="Site Name"/>
          <field attribute="createddate" label="Created Date">
            <renderer type="datetime" params="format=MM/dd/yyyy HH:mm"/>
          </field>

          <field attribute="statusdate" label="Status Change Date"/>
          <field attribute="reportedby_.username" label="Reported By"/>
          <field attribute="status" label="Status"/>

        </list>


        <schema id="adetail" abstract="true" stereotype="detail">
          <field attribute="id" hidden="true"/>
          <field attribute="site_.siteid" hidden="true"/>
          <field attribute="site_.locationprefix" hidden="true"/>
          <field attribute="site_.wherehouseaddress" hidden="true"/>

          <section orientation="horizontal" showexpression="@id != null">
            <header displacement="ontop" label="Ticket Information" params="fieldset=true" />
            <field attribute="id" label="Ticket#" readonly="true"/>
            <field attribute="#originalstatus" hidden="true"/>
            <optionfield label="Status" attribute="status">
              <filter clientfunction="fsdTicketService.filterStatus"/>
              <option label="Draft" value="DRAFT"/>
              <option label="Scheduled" value="SCHEDULED"/>
              <option label="Dispatched" value="DISPATCHED"/>
              <option label="Accepted" value="ACCEPTED"/>
              <option label="Rejected" value="REJECTED"/>
              <option label="Arrived" value="ARRIVED"/>
              <option label="Resolved" value="RESOLVED"/>
            </optionfield>
            <field attribute="reportedby_.username" label="Reported By" readonly="true"/>
          </section>

          <section>
            <header displacement="ontop" label="Site Information" params="fieldset=true" />

            <section orientation="horizontal" parameters="">
              <section id="gfed">
                <association label="Site" target="gfedid" labelfield="site_.facilitytitlewithvalue" requiredexpression="true" 
                             extraprojectionvalues="facilityname,facilitytitle,address,city,state,postalcode,singlelineaddress,gpslatitude,gpslongitude,sitecontact,sitecontactphone,supportphone,supportemail,facilitytitlewithvalue,primarycontact,primarycontactphone,primarycontactemail,escalationcontact,escalationcontactphone,escalationcontactemail,siteid,locationprefix,maintenaceprovider,wherehouseaddress">
                  <renderer type="lookup" params="application=_GfedSite;schemaId=ticketLookupList;hidevalue=true"/>
                  <event type="afterchange" service="fsdTicketService" method="siteSelected"/>
                </association>
              </section>
              <field attribute="siteaddress" label="Site Address" enableexpression="@gfedid != null"/>
              <section>
                <field attribute="gpslatitude" label="GPS Coordinates" enableexpression="@gfedid != null"/>
                <field attribute="gpslongitude" enableexpression="@gfedid != null"/>
              </section>
            </section>
            <section orientation="horizontal" parameters="">
              <renderer type="default" params="childinputsize=medium" />
              <field attribute="maintenaceprovider" label="Maintenance Provider" enableexpression="@gfedid != null"/>
              <section>
                <field attribute="sitecontact" label="Site Contact" enableexpression="@gfedid != null"/>
                <field attribute="sitecontactphone" enableexpression="@gfedid != null"/>
              </section>
              <section>
                <field attribute="supportphone" label="24/7 Technical Support #" enableexpression="@gfedid != null"/>
                <field attribute="supportemail" label="" enableexpression="@gfedid != null"/>
              </section>
            </section>

            <field attribute="comments" label="Comments">
              <renderer type="richtext"/>
            </field>

            <composition inline="true" relationship="attachments" label="Attachments" detailschema="" fetchtype="lazy">
              <renderer type="fileexplorer" params="acceptedFileExtensions=sw_all_types;"/>
            </composition>

          </section>

          <section>
            <header displacement="ontop" label="First Solar Contacts" params="fieldset=true" />

            <section orientation="horizontal" parameters="">
              <renderer type="default" params="childinputsize=medium" />
              <section>
                <field attribute="primarycontact" label="Primary Contact" enableexpression="@gfedid != null"/>
                <field attribute="primarycontactphone" label="" enableexpression="@gfedid != null"/>
                <field attribute="primarycontactemail" label="" enableexpression="@gfedid != null">
                  <renderer type="email"/>
                </field>
              </section>              
              <section>
                <field attribute="escalationcontact" label="Escalation Contact" enableexpression="@gfedid != null"/>
                <field attribute="escalationcontactphone" enableexpression="@gfedid != null"/>
                <field attribute="escalationcontactemail" enableexpression="@gfedid != null">
                  <renderer type="email"/>
                </field>
              </section>
            </section>
          </section>

          <section showexpression="@gfedid != null">
            <header displacement="ontop" label="Inverter Information" params="fieldset=true" />
            <composition inline="true" relationship="inverters" label="" detailschema="detailview" printschema="" fetchtype="eager">
              <collectionproperties listschema="inverterline" autocommit="false" allowremoval="true"/>
              <renderer type="TABLE" params="mode=batch;composition.inline.addfunction=fsdInverterService.openModalNew;composition.inline.expandreadonly=true;composition.inline.editfunction=fsdInverterService.openModalEdit;composition.inline.deletefunction=fsdInverterService.deleteRow;composition.inline.forceshowremove=true;composition.inline.addTitle=Inverter"/>
            </composition>
          </section>

          <section showexpression="@gfedid != null &amp;&amp; (@status == 'DRAFT' || @status == 'SCHEDULED')">
            <header displacement="ontop" label="Dispatch" params="fieldset=true" />
            <!--            <field label="Choose the desired Dispatch Response Time">-->
            <!--              <renderer type="label"/>-->
            <!--            </field>-->
            <section orientation="horizontal">

              <section>
                <renderer type="default" params="class=col-md-3"/>
                <optionfield attribute="immediatedispatch" label="Choose the desired Dispatch Response Time" default="true">
                  <renderer type="radio" params="vertical=true"/>
                  <option label="Immediate" value="true"/>
                  <option label="Delayed" value="false"/>
                </optionfield>
              </section>

              <section orientation="horizontal">
                <renderer type="default" params="class=col-md-4 verticaloffset"/>
                <field attribute="dispatchexpecteddate" label="Enter Date &amp; Time" enableexpression="@immediatedispatch === 'false'" requiredexpression="@immediatedispatch === 'false'">
                  <renderer type="datetime" params="position=top;allowpast=false;showtime=true;class=innerverticaloffset"/>
                </field>
                <section resourcepath="/Content/Customers/firstsolardispatch/htmls/templates/dispatchbutton.html"/>
              </section>
            </section>


          </section>



          <tab label="Status History" id="statushistory" icon="fa fa-history">
            <composition detailschema="" fetchtype="lazy"  relationship="#statushistory"  printschema="" inline="true" label="">
              <collectionproperties allowcreation="false" listschema="statusrepresentation"/>
            </composition>
          </tab>


        </schema>

        <schema id="statusrepresentation" stereotype="list">
          <field attribute="status" label="Status"/>
          <field attribute="changedate" label="Change Date">
            <renderer type="datetime"/>
          </field>
          <field attribute="changeby" label="Changed by"/>
          <properties>
            <property key="list.paginationsize" value="10"/>
            <property key="list.paginationoptions" value="10"/>
          </properties>
        </schema>


        <schema id="newdetail" parentschema="adetail" title="Dispatch Ticket" platform="web" stereotype="detailnew">

        </schema>

        <schema id="editdetail" parentschema="adetail" title="Dispatch Ticket" platform="web" stereotype="detail">
          <section id="gfed">
            <field attribute="gfedid" hidden="true"/>
            <field attribute="site_.facilitytitlewithvalue" label="Site" readonly="true"/>
          </section>

          <commandbars>
            <commandgroup position="actions">
              <command id="createwo" icon="fa-refresh" label="Create Work Order" service="fsdTicketService" method="createWorkOrder" cssclasses="large-button" showexpression="service:fsdTicketService.shouldShowCreateCommand"/>
            </commandgroup>
          </commandbars>
          
        </schema>

      </schemas>
    </application>



  </applications>

</metadata>
