<project name="Softwrench" default="build" basedir="." xmlns="http://nant.sf.net/release/0.92/nant.xsd" >

  <description>Softwrench</description>
  <property name="debug" value="true" overwrite="false" />


  <property name="MSBuildPath" value="c:\Windows\Microsoft.NET\Framework64\v4.0.30319\MSBuild.exe" />
  <property name="MSDeployPath" value="C:\Program Files (x86)\IIS\Microsoft Web Deploy V3\msdeploy.exe" />
<!--   <property name="MSTestPath" value="c:\Windows\Microsoft.NET\Framework64\v4.0.30319\MSTest.exe" />-->
  <property name="SolutionFile" value="../softWrench.sW4.sln" />
  <property name="TestSettingsPath" value="../TestSettings1.testsettings" />
  <property name="TestPath" value="../softwrench.sW4.test/bin/Debug/softwrench.sW4.test.dll" />
  <if test="${environment::variable-exists('outputdir')}">
    <property name="OutputDir" value="${environment::get-variable('outputdir')}" />
  </if>

  <ifnot test="${environment::variable-exists('outputdir')}">
    <property name="OutputDir" value="c:\" />
  </ifnot>

  <tstamp property="build.date" pattern="yyyy_MM_dd_hh_mm_ss" verbose="true" />
  
  <property name="deploypath" value="${OutputDir}/deploy/${build.date}"></property>


  <!--These will come from jenkins-->
  <if test="${environment::variable-exists('clientsw4')}">
    <property name="client" value="${environment::get-variable('clientsw4')}" />
  </if>
  <if test="${environment::variable-exists('environmentsw4')}">
    <property name="profile" value="${environment::get-variable('environmentsw4')}" />
  </if>
  <if test="${environment::variable-exists('tag')}">
    <property name="version" value="${environment::get-variable('tag')}" />
  </if>

  <target name="fulldeploy" depends="compile,copydlls,deploy"/>

  <target name="fullbuildlocal" depends="compile,zip"/>

  <target name="compile">
    <exec program="${MSBuildPath}">
      <arg line='"${SolutionFile}"' />
      <arg line="/property:Configuration=Debug" />
      <arg value="/target:Rebuild" />
      <arg value="/verbosity:normal" />
      <arg value="/nologo" />
    </exec>
  </target>

  <target name="test">
    <delete dir="${OutputDir}/testresults" failonerror="false"/>
    <delete file="TestResults.trx"/>

    <if propertyexists="MsTestPath">
      <echo message="MSTestPath found at ${MsTestPath}"></echo>
      <exec program="${MsTestPath}">
        <arg line="/testcontainer:${TestPath}" />
        <arg line="/testsettings:${TestSettingsPath}" />
        <arg line="/resultsfile:TestResults.trx" />
      </exec>
    </if>
    <ifnot propertyexists="MsTestPath">
      <echo message="MSTestPath not found at"></echo>
      <exec program="MsTest.exe">
        <arg line="/testcontainer:${TestPath}" />
        <arg line="/testsettings:${TestSettingsPath}" />
        <arg line="/resultsfile:TestResults.trx" />
      </exec>
    </ifnot>

    <exec program="karma.cmd" workingdir="../softwrench.sw4.jstest">
      <arg line="start" />
      <arg value="--browsers=PhantomJS"/>
      <arg value="--singleRun=true"/>
    </exec>

  </target>

  <target name="mkdir">
    <!--    <delete includeemptydirs="true">-->
    <!--      <fileset basedir="${OutputDir}/deploy">-->
    <!--        <include name="**\*" />-->
    <!--      </fileset>-->
    <!--    </delete>-->

    <mkdir dir="${deploypath}"/>
    <mkdir dir="${deploypath}/bin"/>

  </target>

  <target name="copydlls" depends="mkdir">
    <copy todir="${deploypath}" includeemptydirs="false">
      <fileset basedir="../softWrench.sW4.Web/">
        <include name="**/*" />
        <exclude name="**/*.cs"/>
        <exclude name="*.dll"/>
        <exclude name="*.suo"/>
        <exclude name="*.csproj"/>
        <exclude name="App_Data/client/**"/>
        <exclude name="**.csproj.*"/>
        <exclude name=".nuget/**"/>
        <exclude name="Dependencies/**"/>
        <exclude name="bin/Dependencies/**"/>
        <exclude name="obj/**"/>
      </fileset>
    </copy>
    <copy todir="${deploypath}/bin">
      <fileset basedir="../softWrench.sW4.Web/Dependencies">
        <include name="**/*" />
      </fileset>
    </copy>

    <copy todir="${deploypath}/App_Data/Client/@internal">
      <fileset basedir="../softWrench.sW4.Web/App_Data/Client/@internal">
        <include name="*.*" />
      </fileset>
    </copy>
    <copy todir="${deploypath}/App_Data/Client/otb">
      <fileset basedir="../softWrench.sW4.Web/App_Data/Client/otb">
        <include name="*.*" />
      </fileset>
    </copy>

    <copy todir="${deploypath}/App_Data/Client/${client}" failonerror="false">
      <fileset basedir="../softWrench.sW4.Web/App_Data/Client/${client}">
        <include name="*.*" />
      </fileset>
    </copy>

    <foreach item="Folder" in="../" property="foldername">
      <property name="customerplaceholder" value="${foldername}/customer.placeholder" />
      <property name="sharedplaceholder" value="${foldername}/shared.placeholder" />

      <property name="indexof" value="${string::last-index-of(foldername, '.') + 1}" />
      <property name="length" value="${string::get-length(foldername)}" />
      <property name="size" value="${string::get-length(foldername) - string::last-index-of(foldername, '.')-1}" />

      <property name="clientname" value="${string::substring(foldername,indexof,size)}" />



      <if test="${clientname == client}">
        <echo message="${foldername}" />
        <echo message="${clientname}"/>

        <copy todir="${deploypath}/Content/Customers/${clientname}">
          <fileset basedir="../softWrench.sW4.${client}/web_content/${clientname}">
            <include name="*.*" />
          </fileset>
        </copy>
        <echo message="Copied files for ${client}" />
      </if>


      <if test="${file::exists(sharedplaceholder)}">
        <echo message="${foldername}" />
        <echo message="${clientname}"/>

        <copy todir="${deploypath}/Content/Shared/${clientname}">
          <fileset basedir="../softWrench.sW4.${clientname}/web_content/${clientname}">
            <include name="*.*" />
          </fileset>
        </copy>
        <echo message="Copied files for ${client}" />
      </if>
    </foreach>


    <attrib readonly="false">
      <fileset basedir="${deploypath}">
        <include name="**"/>
      </fileset>
    </attrib>
  </target>

  <target name="copydllssw" depends="mkdir">
    <copy todir="${deploypath}">
      <fileset basedir="../softWrench.sW4.Web/">
        <include name="**/*" />
        <exclude name="App_Data/client/**"/>
        <exclude name="**.csproj"/>
        <exclude name=".nuget/**"/>
        <exclude name="Dependencies/**"/>
        <exclude name="bin/Dependencies/**"/>
        <exclude name="obj/**"/>
      </fileset>
    </copy>
    <copy todir="${deploypath}/App_Data/Client/@internal">
      <fileset basedir="../softWrench.sW4.Web/App_Data/Client/@internal">
        <include name="*.*" />
      </fileset>
    </copy>
    <copy todir="${deploypath}/App_Data/Client/${client}">
      <fileset basedir="../softWrench.sW4.Web/App_Data/Client/${client}">
        <include name="*.*" />
      </fileset>
    </copy>
    <attrib readonly="false">
      <fileset basedir="${deploypath}">
        <include name="**"/>
      </fileset>
    </attrib>
  </target>



  <target name="setclient">

    <xmlpoke file="${deploypath}/Web.config"
               xpath="/configuration/appSettings/add[@key = 'clientkey']/@value"
               value="${client}" failonerror="true"/>

  </target>

  <target name="setenv">

    <xmlpoke file="${deploypath}/Web.config"
               xpath="/configuration/appSettings/add[@key = 'profile']/@value"
               value="${profile}" failonerror="true"/>
  </target>

  <target name="zip" depends="copydlls,setclient,setenv,explodexmlfiles">



    <zip includeemptydirs="true" zipfile="${OutputDir}/deploy/sw4_${client}_${profile}_${build.date}.zip">
      <fileset basedir="${deploypath}">
        <include name="**/*" />
      </fileset>
    </zip>
  </target>
  

  <target name="explodexmlfiles" depends="setenv,setclient">
    <property name="clientpropertyfile" value="../softwrench.sW4.${client}/metadata/${client}/properties.xml" />
    <if test="${file::exists(clientpropertyfile)}">
      <copy todir="${deploypath}/App_Data/Client/${client}/">
        <fileset basedir="../softwrench.sW4.${client}/metadata/${client}/">
          <include name="*.*" />
        </fileset>
      </copy>
    </if>
  </target>
  
  <target name="deploypeek" depends="setenv,setclient">


    <property name="clientfile1" value="${deploypath}/App_Data/Client/${client}/deploy.xml" />
    <property name="clientfile2" value="../softwrench.sW4.${client}/metadata/${client}/deploy.xml" />
    
    <echo message="${clientfile1}"/>
    <echo message="${clientfile2}"/>

    <if test="${file::exists(clientfile1)}">

      <xmlpeek property="iispath" file="${clientfile1}"
               xpath="//x:metadata/x:globalproperties/x:environment[@key = '${profile}']/x:property[@key = 'iispath']/@value">
        <namespaces>
          <namespace prefix="x" uri="http://www.controltechnologysolutions.com/deploymetadata" />
        </namespaces>
      </xmlpeek>

      <xmlpeek property="msdeploy_url" file="${clientfile1}"
               xpath="//x:metadata/x:globalproperties/x:environment[@key = '${profile}']/x:property[@key = 'msdeploy_url']/@value">
        <namespaces>
          <namespace prefix="x" uri="http://www.controltechnologysolutions.com/deploymetadata" />
        </namespaces>
      </xmlpeek>

    </if>

    <if test="${file::exists(clientfile2)}">

      <echo message="searching in dll"/>

      <xmlpeek property="iispath" file="${clientfile2}"
               xpath="//x:metadata/x:globalproperties/x:environment[@key = '${profile}']/x:property[@key = 'iispath']/@value">
        <namespaces>
          <namespace prefix="x" uri="http://www.controltechnologysolutions.com/deploymetadata" />
        </namespaces>
      </xmlpeek>

      <xmlpeek property="msdeploy_url" file="${clientfile2}"
               xpath="//x:metadata/x:globalproperties/x:environment[@key = '${profile}']/x:property[@key = 'msdeploy_url']/@value">
        <namespaces>
          <namespace prefix="x" uri="http://www.controltechnologysolutions.com/deploymetadata" />
        </namespaces>
      </xmlpeek>

    </if>

    <echo message="urlPath: + ${msdeploy_url}"/>
    <echo message="iisPath:  + ${iispath}"/>
  </target>

  <target name="deploy" depends="setenv,setclient,deploypeek">
    <exec program="${MSDeployPath}">
      <arg line="-verb:sync" />
      <arg line="-source:iisApp=${deploypath},includeAcls=true" />
      <arg line="-dest:iisApp=${iispath},wmsvc=${msdeploy_url}" />
      <arg line="-allowUntrusted=true" />
      <arg line="-enableRule:AppOffline" />
      <arg line="-verbose" />
    </exec>
  </target>

  <target name="generatelinks">
    <foreach item="Folder" in="../" property="foldername">
      <property name="customerplaceholder" value="${foldername}/customer.placeholder" />
      <property name="sharedplaceholder" value="${foldername}/shared.placeholder" />

      <property name="indexof" value="${string::last-index-of(foldername, '.') + 1}" />
      <property name="length" value="${string::get-length(foldername)}" />
      <property name="size" value="${string::get-length(foldername) - string::last-index-of(foldername, '.')-1}" />

      <property name="clientname" value="${string::substring(foldername,indexof,size)}" />



      <if test="${file::exists(customerplaceholder)}">
        <echo message="${foldername}" />
        <echo message="${clientname}"/>



        <exec program="cmd" workingdir="../softwrench.sw4.web/Content/Customers" verbose="true" failonerror="false" resultproperty="customerlinkcreated">
          <arg value="/c"/>
          <arg line="mklink /D ${clientname} ${foldername}\web_content\${clientname}"/>
        </exec>

        <if test="${customerlinkcreated =='0'}">
          <echo message="created symbolic link for ${clientname}" />
        </if>
      </if>


      <if test="${file::exists(sharedplaceholder)}">
        <echo message="${foldername}" />
        <echo message="${clientname}"/>

        <exec program="cmd" workingdir="../softwrench.sw4.web/Content/Shared" verbose="true" failonerror="false" resultproperty="customerlinkcreated">
          <arg value="/c"/>
          <arg line="mklink /D ${clientname} ${foldername}\web_content\${clientname}"/>
        </exec>

        <if test="${customerlinkcreated =='0'}">
          <echo message="created symbolic link for ${clientname}" />
        </if>
      </if>
    </foreach>

  </target>

</project>