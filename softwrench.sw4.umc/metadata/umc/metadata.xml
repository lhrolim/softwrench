<?xml version="1.0" encoding="utf-8" ?>
<metadata xmlns="http://www.controltechnologysolutions.com/metadata">

  <templates>
    <template path="@woactivity.xml"/>
    <template path="@worklogs.xml"/>
    <template path="@person.xml"/>
    <template path="@workorder.xml"/>
    <template path="@location.xml"/>
    <template path="@servicerequest.xml"/>
    <template path="@quickservicerequest.xml"/>
    <template path="@failurecode.xml"/>
  </templates>

  <entities>
    <entity name="workorder" idAttribute="workorderid" useridAttribute="wonum" whereclause="!@woclass like 'WORKORDER'">
      <relationships>
        <relationship to="alndomain" qualifier="crew">
          <relationshipAttribute from="crewid" to="value" primary="true"/>
          <relationshipAttribute to="domainid" literal="CREWID" quoteLiteral="true"/>
        </relationship>
        <relationship to="failurelistonly" qualifier="failurelist" >
          <relationshipAttribute from="failurecode" to="failurecode" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>


        <relationship to="problemlist" qualifier="problemlist">
          <relationshipAttribute from="problemcode" to="failurecode" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>

      </relationships>
    </entity>
    <entity name ="problemlist" parententity="failurelist" idAttribute="failurelist" whereclause="((problemlist.TYPE like 'PROBLEM')) " >
      <attributes>
        <attribute name="description" query="(select description from failurecode where failurecode = !@failurecode and orgid = !@orgid)" type="varchar"/>
      </attributes>
    </entity>
    <entity name="pm" idAttribute="pmuid" useridAttribute="pmnum">
      <relationships>
        <relationship to="longdescription" qualifier="ld" lazy="true">
          <relationshipAttribute from="pmuid" to="ldkey" primary="true"/>
          <relationshipAttribute to="ldownertable" literal="PM" quoteLiteral="true" />
          <relationshipAttribute to="ldownercol" literal="DESCRIPTION" quoteLiteral="true" />
        </relationship>
        <relationship to="jobplan" qualifier="jp" lazy="true">
          <relationshipAttribute from="jpnum" to="jpnum" primary="true"/>
          <relationshipAttribute to="status" literal="ACTIVE" quoteLiteral="true" />
        </relationship>
        <relationship to="asset" >
          <relationshipAttribute from="assetnum" to="assetnum" primary="true"/>
          <relationshipAttribute from="siteid" to="siteid" />
        </relationship>
      </relationships>
      <connectorParameters>
        <connectorParameter key="integration_interface" value="SWPM"/>
      </connectorParameters>
    </entity>
    <entity name="jobplan" idAttribute="jobplanid" useridAttribute="jpnum">
      <attributes>
        <attribute name="jobplanid" type="bigint" required="true" />
        <attribute name="jpnum" type="varchar" required="true" />
        <attribute name="description" type="varchar" required="false" />
        <attribute name="status" type="varchar" required="true" />
      </attributes>
    </entity>
  </entities>

  <applications>
    <application entity="SR" name="servicerequest" title="Service Request" role="sr">
      <schemas>
        <list title="Service Request Grid" stereotype="list.selection" redeclaring="true">
          <field attribute="ticketid" label="SR#">
            <renderer type="default" params="width=5%" />
          </field>
          <field attribute="description" label="Work Request">
            <renderer type="default" params="excelwidth=50" />
          </field>
          <field attribute="reportedby" label="Reported By">
            <renderer type="default" params="width=12%" />
          </field>
          <field attribute="reportedemail" label="Reported By Email">
            <renderer type="default" params="width=15%" />
          </field>
          <field label="Reported Date" attribute="reportdate">
            <renderer type="datetime" params="width=10%" />
          </field>
          <field attribute="owner" label="Owner">
            <renderer type="default" params="width=12%" />
          </field>
          <field attribute="siteid" hidden="true"/>
          <field attribute="status" label="Status">
            <renderer type="statuscolor" params="width=8%;grid=servicerequest;column=status" />
          </field>
          <field attribute="internalpriority" tooltip="Priority">
            <renderer type="priorityicon" params="width=5%;icon=fa-flag;headericon=true;changevalue=true;onclick=priorityService.setPriority"/>
          </field>
          <field attribute="communicationcounter" tooltip="Communications" hidden="true">
            <renderer type="icon" params="icon=fa-envelope-o;autoloadcomposition=commlog_"/>
          </field>
          <field attribute="attachmentcounter" tooltip="Attachments" hidden="true">
            <renderer type="icon" params="hideValueOnTooltip=true;icon=fa-paperclip;autoloadcomposition=attachment_"/>
          </field>
          <field attribute="relatedcounter" tooltip="Related Records" hidden="true">
            <renderer type="icon" params="icon=fa-tags;autoloadcomposition=relatedrecord_"/>
          </field>
          <field attribute="statusicons" tooltip="Status Icons">
            <renderer type="statusicons" params="width=9%;iconcolumns=communicationcounter,attachmentcounter,relatedcounter;icon=fa-tachometer;headericon=true;showsort=false"/>
          </field>
          <properties>
            <property key="list.click.schema" value="editdetail"/>
            <property key="list.defaultorderby" value="sr.ticketuid desc"/>
            <property key="list.search.compositionstoexclude" value="attachment,relatedrecord"/>
          </properties>

          <commandbars>
            <commandgroup position="actions">
              <command id="Create" icon="fa-pencil" label="Change Status"
                       showexpression="service:genericTicketService.hasSelectedItemsForBatchStatus"
                       service="genericTicketService" method="initBatchStatusChange"
                       parameters="schema,datamap" cssclasses="large-button"/>
            </commandgroup>
          </commandbars>
        </list>
        <schema id="adetail" title="Request Details" abstract="true" stereotype="detail" redeclaring="false">
          <customization position="description">
            <field attribute="description" label="Work Request" requiredexpression="true">
              <renderer type="default" params="maxlength=100;inputsize=xlarge" />
            </field>
          </customization>
          <customization position="ld_.ldtext">
            <field label="Details/Location" attribute="ld_.ldtext">
              <renderer type="richtext"/>
            </field>
          </customization>
        </schema>

        <schema id="editdetail" parentschema="adetail" title="Service Request Details" redeclaring="false">
          <customization position="siteid"/>
        </schema>

        <schema id="nologinnewdetail" stereotype="detailnew" title="Service Request Details">
          <reference id="srhiddens"/>
          <field attribute="name" label="Full Name" requiredexpression="true"/>
          <field attribute="email" label="Email Address" requiredexpression="true">
            <renderer type="default" params="valtype=custom;valmessage=An '@umcsn.com' email is required.;valflags=i">
              <parameter key="valpattern" value="^(([^&lt;&gt;()\[\]\.,;:\s@\&quot;]+(\.[^&lt;&gt;()\[\]\.,;:\s@\&quot;]+)*)|(\&quot;.+\&quot;))@umcsn\.com$"/>
            </renderer>
          </field>
          <field attribute="phoneext" label="Phone Extension" requiredexpression="true">
            <renderer type="default" params="inputmaxlength=4;valtype=custom;valmessage=Phone extension is a sequence of four numbers.;valpattern=^\d{4}$"/>
          </field>
          <field attribute="location" label="Location" requiredexpression="true"/>
          <field attribute="description" label="Request Summary" requiredexpression="true">
            <renderer type="richtext"/>
          </field>

          <commandbars>
            <commandgroup position="detail.primary">
              <removecommand id="cancel"/>
              <removecommand id="save"/>
              <removecommand id="print"/>
              <command id="submit" icon="fa-check" service="umcNoLoginSubmitService" method="submit" label="Submit" cssclasses="large-button" tooltip="Submit Request" enableexpression="$scope:enableSave"/>
            </commandgroup>
          </commandbars>

          <properties>
            <property key="detail.show.toolbar.anonymous" value="true"/>
          </properties>
        </schema>

        <schema id="newdetail" parentschema="adetail" stereotype="detailnew" title="New Service Request" redeclaring="false">
          <customization position="siteid"/>
        </schema>

      </schemas>
    </application>

    <application entity="SR" name="quickservicerequest" title="Quick Requests" role="ssr">
      <schemas>
        <schema id="quicksrgrid" title="Quick Request Grid" stereotype="list" redeclaring="false">
          <customization position="description">
            <field attribute="description" label="Work Request">
              <renderer type="default" params="excelwidth=50" />
            </field>
          </customization>
          <customization position="+reportedby">
            <field attribute="reportedemail" label="Reported By Email"/>
            <field label="Reported Date" attribute="reportdate">
              <renderer type="datetime" />
            </field>
          </customization>
        </schema>

        <schema id="quicknewdetail" stereotype="detailnew" title="New Quick Request" redeclaring="false">
          <customization position="description">
            <field attribute="description" label="Work Request" requiredexpression="true">
              <renderer type="default" params="maxlength=100;inputsize=xlarge" />
            </field>
          </customization>
          <customization position="ld_.ldtext">
            <field label="Details/Location" attribute="ld_.ldtext" >
              <renderer type="richtext"/>
            </field>
          </customization>
          <customization position="siteid"/>
        </schema>

        <schema id="quickeditdetail" stereotype="detail" title="Quick Request Details" redeclaring="false">
          <customization position="description">
            <field attribute="description" label="Work Request" requiredexpression="true">
              <renderer type="default" params="maxlength=100;inputsize=xlarge" />
            </field>
          </customization>
          <customization position="ld_.ldtext">
            <field label="Details/Location" attribute="ld_.ldtext" >
              <renderer type="richtext"/>
            </field>
          </customization>
          <customization position="siteid"/>
        </schema>
      </schemas>
    </application>

    <application name="workorder" title="Work Order" entity="workorder" role="workorders">
      <schemas>
        <schema id="list" stereotype="list.selection" title="Work Order Grid" platform="web" redeclaring="true">
          <filters>
            <optionfilter attribute="status" provider="synstatus_.description" displaycode="true" style="width:300px" />
            <optionfilter attribute="location" provider="location_.description" allowblank="true" displaycode="true"/>
            <optionfilter attribute="asset_.description" provider="asset_.description" allowblank="true" style="width:300px" displaycode="true" whereclause="!@assetnum in (!@#value)"/>
            <optionfilter attribute="wopriority" displaycode="true">
              <option xmlns="http://www.controltechnologysolutions.com/filters" label="High" value="1" />
              <option xmlns="http://www.controltechnologysolutions.com/filters" label="Medium" value="2" />
              <option xmlns="http://www.controltechnologysolutions.com/filters" label="Low" value="3" />
            </optionfilter>
            <optionfilter attribute="statusicons" displaycode="true">
              <option xmlns="http://www.controltechnologysolutions.com/filters" label="Communications" value="communicationcounter" />
              <option xmlns="http://www.controltechnologysolutions.com/filters" label="Attachments" value="attachmentcounter" />
              <option xmlns="http://www.controltechnologysolutions.com/filters" label="Related Records" value="relatedcounter" />
            </optionfilter>
          </filters>
          <field attribute="wonum" label="WO#" >
            <renderer type="default" params="width=8%" />
          </field>
          <field attribute="description" label="Work Request">
            <renderer type="default" params="excelwidth=50" />
          </field>
          <field label="Reported Date" attribute="reportdate">
            <renderer type="datetime" params="width=10%" />
          </field>
          <field attribute="location" label="Location">
            <renderer type="default" params="width=15%" />
          </field>
          <field attribute="asset_.description" label="Asset Description">
            <renderer type="default" params="width=15%" />
          </field>
          <field attribute="siteid" label="Site" hidden="true"/>
          <field attribute="status" label="Status">
            <renderer type="statuscolor" params="width=8%;grid=workorder;column=status" />
          </field>
          <field attribute="wopriority" tooltip="Priority">
            <renderer type="priorityicon" params="width=5%;icon=fa-flag;headericon=true;changevalue=true;onclick=priorityService.setPriority"/>
          </field>
          <field attribute="communicationcounter" tooltip="Communications" hidden="true">
            <renderer type="icon" params="icon=fa-envelope-o;autoloadcomposition=commlog_"/>
          </field>
          <field attribute="attachmentcounter" tooltip="Attachments" hidden="true">
            <renderer type="icon" params="hideValueOnTooltip=true;icon=fa-paperclip;autoloadcomposition=attachment_"/>
          </field>
          <field attribute="relatedcounter" tooltip="Related Records" hidden="true">
            <renderer type="icon" params="icon=fa-tags;autoloadcomposition=relatedrecord_"/>
          </field>
          <field attribute="statusicons" tooltip="Status Icons">
            <renderer type="statusicons" params="width=9%;iconcolumns=communicationcounter,attachmentcounter,relatedcounter;icon=fa-tachometer;headericon=true;showsort=false"/>
          </field>
          <properties>
            <property key="list.click.schema" value="editdetail"/>
            <property key="list.defaultorderby" value="workorder.statusdate desc"/>
            <property key="list.noresultsnewschema" value="newdetail"/>
            <property key="list.search.compositionstoexclude" value="assetmeter,locationmeter"/>
            <!--<property key="list.click.mode" value="@status == 'CLOSE' ? 'output' : 'input'"/>-->
          </properties>

          <commandbars>
            <commandgroup position="actions">
              <command id="Create" icon="fa-pencil" label="Change Status"
                       showexpression="service:genericTicketService.hasSelectedItemsForBatchStatus"
                       service="genericTicketService" method="initBatchStatusChange"
                       parameters="schema,datamap" cssclasses="large-button"/>
            </commandgroup>
          </commandbars>
        </schema>

        <schema id="adetail" title="Work Order Details" abstract="true" stereotype="detail" platform="web" redeclaring="false">
          <customization position="description">
            <field attribute="description" label="Work Request" requiredexpression="true">
              <renderer type="default" params="maxlength=100;inputsize=xlarge" />
            </field>
          </customization>
          <customization position="ld_.ldtext">
            <field label="Details/Location" attribute="ld_.ldtext">
              <renderer type="richtext"/>
            </field>
          </customization>
        </schema>
        <schema id="editdetail" parentschema="adetail"  title="Work Order Details" platform="web" redeclaring="false">

          <customization position="failurecode"/>
          <customization position="problemcode"/>

          <customization position="+hiddenfield">
            <section orientation="horizontal">
              <association label="Failure Class" target="failurecode" labelfield="failurelist_.description" extraprojectionvalues="failurelist" orderbyfield="failurecode asc" requiredexpression="true">
                <renderer type="lookup" />
              </association>
              <association label="Problem Code" enableexpression="@failurecode!=null" target="problemcode" labelfield="problemlist_.description" extraprojectionvalues="failurelist" requiredexpression="true" >
                <renderer type="lookup"  />
                <dataprovider prefilterfunction="FilterProblemCodes" />
              </association>
              <association label="Trade" target="crewid" labelfield="crew_.description" requiredexpression="true">
                <renderer type="lookup"/>
              </association>
            </section>
          </customization>
          <customization position="worktype">
            <association label="Work Type" target="worktype" labelfield="worktype_.wtypedesc" orderbyfield="worktype asc" requiredexpression="true">
              <renderer type="lookup" params="inputsize=small"/>
            </association>
          </customization>
        </schema>

        <schema id="newdetail" parentschema="adetail" title="New Work Order"  platform="web" stereotype="detailnew" redeclaring="false">

        </schema>

        <schema id="workordercreationmodal" title="Fill In Workorder Details" stereotype="detail.modal" platform="web" redeclaring="false">
          <customization position="description">
            <field attribute="description" label="Work Request:" requiredexpression="true"/>
          </customization>
          <customization position="ld_.ldtext">
            <field attribute="ld_.ldtext" label="Details/Location:" requiredexpression="false">
              <renderer type="textarea"/>
            </field>
          </customization>

        </schema>

        <schema id="newdetail" platform="mobile" stereotype="detailnew" redeclaring="false">
          <customization position="ld_.ldtext">
            <field label="Details/Location" attribute="ld_.ldtext">
              <renderer type="richtext"/>
            </field>
          </customization>
        </schema>

      </schemas>
    </application>

    <application name="labtrans" entity="labtrans" title="Labor">
      <schemas>
        <schema id="detail" redeclaring="false">
          <customization position="transtype">
            <field hidden="true" attribute="transtype" defaultexpression="71"/>
          </customization>
        </schema>

      </schemas>
    </application>

    <application name="worklog" title="Work Logs" entity="worklog" id="00000000-0000-0000-0000-000000000008">
      <schemas>
        <schema id="list"  stereotype="compositionlist" redeclaring="false">
          <customization position="description">
            <field attribute="description" label="Work Request" qualifier="title"/>
          </customization>
        </schema>

        <detail stereotype="compositiondetail" title="Work Log" platform="web" redeclaring="false">
          <customization position="description">
            <field attribute="description" label="Work Request" requiredexpression="true">
              <renderer type="default" params="maxlength=100"/>
            </field>
          </customization>

          <customization position="wld_.ldtext">
            <field attribute="wld_.ldtext" label="Details/Location" >
              <renderer type="richtext"/>
            </field>
          </customization>
        </detail>

        <detail stereotype="compositiondetail" title="Work Log" platform="mobile" redeclaring="false">
          <customization position="description">
            <field attribute="description" label="Work Request" requiredexpression="true">
              <renderer type="default" params="maxlength=100"/>
            </field>
          </customization>

          <customization position="wld_.ldtext">
            <field attribute="wld_.ldtext" label="Work Request" >
              <renderer type="richtext"/>
            </field>
          </customization>
        </detail>

      </schemas>
    </application>

    <application entity="woactivity" name="woactivity" title="WO Activity">
      <schemas>
        <schema id="list" title="woactivity" stereotype="compositionlist" redeclaring="false">
          <customization position="description">
            <field attribute="description" label="Work Request"/>
          </customization>
        </schema>

        <detail stereotype="compositiondetail" redeclaring="false">
          <customization position="description">
            <field attribute="description" label="Work Request" requiredexpression="true">
              <renderer type="default" params="maxlength=100"/>
            </field>
          </customization>
          <customization position="ld_.ldtext">
            <field attribute="ld_.ldtext" label="Details/Location" >
              <renderer type="textarea"/>
            </field>
          </customization>

        </detail>

      </schemas>

    </application>

    <application entity="pm" name="pm" title="Preventive Maintenance">
      <schemas>
        <list title="PM Updater">
          <field attribute="siteid" hidden="true"/>
          <field attribute="pmnum" label="PM#">
            <renderer type="default" params="width=20%"/>
          </field>
          <field attribute="description" label="Summary">
            <renderer type="default" params="width=30%"/>
          </field>
          <field attribute="assetnum" label="Asset"/>
          <field attribute="jpnum" label="Job Plan"/>
          <field attribute="status" label="Status"/>


          <properties>
            <property key="list.selectionstyle" value="multiple"/>
          </properties>

          <commandbars>
            <commandgroup position="gridtop">
              <removecommand id="export"/>
              <removecommand id="print"/>
              <command id="editld" icon="fa-edit" label="Batch Update" enableexpression="service:umcPdService.isCommandEnabled" service="umcPdService" method="openUpdateLdModal" parameters="datamap" cssclasses="large-button"/>
            </commandgroup>
          </commandbars>
        </list>

        <schema id="editetail" stereotype="detail" title="Preventive Maintenance Details">
          <field attribute="pmuid" hidden="true"/>
          <field attribute="siteid" hidden="true"/>
          <field attribute="orgid" hidden="true"/>
          <field attribute="pmnum" label="PM#" readonly="true"/>
          <field attribute="description" label="Summary" requiredexpression="true"/>
          <field attribute="ld_.ldtext" label="Description">
            <renderer type="richtext"/>
          </field>

          <section orientation="horizontal">
            <association label="Asset" target="assetnum" labelfield="asset_.description" extraprojectionvalues="location" >
              <renderer type="lookup" params="largemodal=true;application=asset;schemaId=assetLookupList;"/>
            </association>
            <association label="Job Plan" target="jpnum" labelfield="jp_.jpnum" extraprojectionvalues="jpnum,description">
              <renderer type="lookup" params="application=jobplan;schemaId=list;"/>
            </association>
            <optionfield attribute="status" label="Status" defaultexpression="DRAFT" requiredexpression="true">
              <option value="DRAFT" label="Draft"/>
              <option value="ACTIVE" label="Active"/>
              <option value="INACTIVE" label="Inactive"/>
            </optionfield>
          </section>
        </schema>


        <schema id="viewdetail" stereotype="detail" title="Preventive Maintenance Details">
          <field attribute="pmnum" hidden="true"/>
          <field attribute="DESCRIPTION_LONGDESCRIPTION" label="Description"/>
        </schema>

        <schema id="updateld" stereotype="detail.modal" title="Preventive Maintenance Batch Update">
          <!--          <optionfield attribute="selectionmode" label="Selection Mode">-->
          <!--            <renderer type="radio"/>-->
          <!--            <option label="Current Page" value="currentselection" help="Applies the batch only to the current selected items"/>-->
          <!--            <option label="All Items Matching the Criteria" value="currentpage" help=""/>-->
          <!--          </optionfield>-->

          <field attribute="commonld" label="Long Description" requiredexpression="true">
            <renderer type="richtext" params="height=400"/>
          </field>
          <field attribute="alias" label="Batch Identifier" helpicon="right" tooltip="An optional alias to help identifying this operation later"/>
        </schema>

        <schema id="pmsimplelist" stereotype="list">
          <field attribute="pmuid"/>
          <field attribute="pmnum"/>
        </schema>
      </schemas>
    </application>
    <application entity="jobplan" name="jobplan" title="Job Plan">
      <schemas>
        <schema id="list" stereotype="compositionlist">
          <field attribute="jobplanid" hidden="true"/>
          <field attribute="status" hidden="true"/>
          <field attribute="jpnum" label="Job Plan"/>
          <field attribute="description" label="Summary"/>
        </schema>
      </schemas>
    </application>
  </applications>

</metadata>