<?xml version="1.0" encoding="utf-8" ?>
<metadata xmlns="http://www.controltechnologysolutions.com/metadata">

  <templates>
    <template path="@solution.xml"/>
    <template path="@attachments.xml"/>
  </templates>

  <entities>
    <entity name="incident" idAttribute="ticketid">

      <relationships>
        <relationship to="numericdomain" >
          <relationshipAttribute from="internalpriority" to="value" primary="true"/>
          <relationshipAttribute to ="domainid" literal="TICKETPRIORITY" quoteLiteral="true"/>
        </relationship>
        <relationship to="person" qualifier="reporter">
          <relationshipAttribute from="reportedby" to="personid" primary="true"/>
        </relationship>

        <relationship to="person">
          <relationshipAttribute from="affectedperson" to="personid" primary="true"/>
          <relationshipAttribute to="status" literal="ACTIVE" quoteLiteral="true" />
        </relationship>
        <relationship to="person" qualifier="ownerperson">
          <relationshipAttribute from="owner" to="personid" primary="true"/>
        </relationship>
        <relationship to ="persongroup">
          <relationshipAttribute from ="ownergroup" to ="persongroup" primary="true"/>
        </relationship>
        <relationship to="classification" qualifier="classification">
          <relationshipAttribute from="classificationid" to ="classificationid" primary="true"/>
        </relationship>
        <relationship to="incidentclassifications" qualifier="incidentclassifications">
          <relationshipAttribute from="classificationid" to="classificationid" primary="true"/>
        </relationship>
        <relationship to ="solution" qualifier="solution" >
          <relationshipAttribute from="solution" to ="solution" primary="true"/>
        </relationship>

        <relationship to="longdescription" qualifier="symptom">
          <relationshipAttribute from="ticketuid" to="ldkey" primary="true"/>
          <relationshipAttribute to="ldownertable" literal="TICKET" quoteLiteral="true" />
          <relationshipAttribute to="ldownercol" literal="PROBLEMCODE" quoteLiteral="true" />
        </relationship>
        <relationship to="longdescription" qualifier="cause">
          <relationshipAttribute from="ticketuid" to="ldkey" primary="true"/>
          <relationshipAttribute to="ldownertable" literal="TICKET" quoteLiteral="true" />
          <relationshipAttribute to="ldownercol" literal="FR1CODE" quoteLiteral="true" />
        </relationship>
        <relationship to="longdescription" qualifier="resolution">
          <relationshipAttribute from="ticketuid" to="ldkey" primary="true"/>
          <relationshipAttribute to="ldownertable" literal="TICKET" quoteLiteral="true" />
          <relationshipAttribute to="ldownercol" literal="FR2CODE" quoteLiteral="true" />
        </relationship>

      </relationships>
      <connectorParameters>
        <connectorParameter key="dbtable" value="incident" />
        <connectorParameter key="integration_interface" value="SWINCIDENT" />
        <connectorParameter key="customconnector" value="softWrench.sW4.Data.Persistence.WS.Commons.BaseIncidentCrudConnector" />
      </connectorParameters>
    </entity>

    <entity name="classstructure"  idAttribute="classstructureid" >
      <relationships>
        <relationship to ="classusewith" qualifier="incidentclassstructures">
          <relationshipAttribute from="classstructureid" to="classstructureid" primary="true"/>
          <relationshipAttribute to="objectvalue" literal="INCIDENT" quoteLiteral="true"/>
        </relationship>
      </relationships>
    </entity>

    <entity name="incidentclassifications" parententity="classstructure" idAttribute="classstructureid" >
      <attributes>
        <attribute name="classstructureid" type="varchar" query="CASE WHEN (xyz.classstructureid = classusewith.classstructureid) and (classusewith.objectvalue='INCIDENT')) "/>
      </attributes>
    </entity>

  </entities>

  <applications>

    <application name="incident" title="Incident" entity="incident">

      <schemas>
        <list title="Incident Grid">
          <field attribute="ticketid" label="Request#">
            <renderer type="default" params="widthXS=35%;widthSM=20%;widthMD=15%;widthLG=10%"/>
          </field>
          <field attribute="description" label="Summary">
            <renderer type="default" params="excelwidth=50" />
          </field>
          <field attribute="asset_.description" label="Asset">
            <renderer type="default" params="widthXS=-1%;widthSM=-1%;widthMD=20%;widthLG=12%" />
          </field>
          <field attribute="targetfinish" label="Target Finish">
            <renderer type="datetime" params="widthXS=-1%;widthSM=-1%;widthMD=-1%;widthLG=15%;format=dd/MM/yyyy HH:mm;showtime=false" />
          </field>
          <field attribute="internalpriority" label="Priority">
            <renderer type="default" params="widthXS=-1%;widthSM=15%;widthMD=10%;widthLG=8%" />
          </field>
          <field attribute="reportdate" label="Reported Date">
            <renderer type="datetime" params="widthXS=-1%;widthSM=-1%;widthMD=-1%;widthLG=15%;format=dd/MM/yyyy HH:mm;showtime=false" />
          </field>
          <field attribute="ownergroup" label="Owner Group">
            <renderer type="default" params="widthXS=-1%;widthSM=-1%;widthMD=15%;widthLG=12%" />
          </field>
          <field attribute="status" label="Status">
            <renderer type="default" params="widthXS=-1%;widthSM=20%;widthMD=15%;widthLG=10%" />
          </field>
          <field attribute="#color" label="">
            <renderer type="color" params="width=4%;grid=incident;column=status"/>
          </field>
          <properties>
            <property key="list.click.schema" value="detail"/>
          </properties>
        </list>

        <schema stereotype="detail" id="newdetail" mode="input" title="New Incident">
          <field attribute="actlabcost" default="0" hidden="true"/>
          <field attribute="actlabhrs" default="0" hidden="true" />
          <field attribute="ticketuid" label="Incident Id:" hidden="true"/>
          <field attribute="ticketid" label="Incident Number:" readonly="true"/>
          <field attribute="description" label="Summary:"/>
          <field label="Details:" attribute="longdescription_.ldtext">
            <renderer type="textarea"/>
          </field>
          <field label="Attachment:" attribute="newattachment" >
            <renderer type="upload"/>
          </field>
          <field attribute="reportedby" label="Reported By:" default="@username" readonly="true"/>
          <association label="Affected Person:" target="affectedperson" labelfield="person_.displayname" default="@username">
            <renderer type="lookup"/>
          </association>
          <association label="Owner:"  target="owner" labelfield="ownerperson_.displayname" enableexpression="@ownergroup==null">
            <renderer type="lookup"/>
            <event type="afterchange" service="srService" method="afterchangeowner"/>
          </association>
          <!-- Added the Owner Group field-->
          <association label="Owner Group:" target="ownergroup" labelfield="persongroup_.description" enableexpression="@owner==null">
            <renderer type="lookup"/>
          </association>
          <field label="Site Id:" attribute="siteid"  hidden="true"/>
          <field attribute ="orgid" hidden ="true"/>
          <field attribute ="class" hidden ="true"/>
          <association label ="Priority" target="internalpriority" labelfield="numericdomain_.description">
            <renderer type="lookup"/>
          </association>
          <!--          <association label="Classification:" target="classificationid" labelfield="incidentclassifications_.description">-->
          <!--            <renderer type="lookup"/>-->
          <!--          </association>-->
          <optionfield attribute="classstructureid" label="Classification:" providerattribute="_IncidentClassStructureType" default="@classstructureid">
            <renderer type="autocompleteclient" />
          </optionfield>
          <association label="Location:" target="location" labelfield="location_.description" >
            <event type="beforechange" service="srService" method="beforeChangeLocation"/>
            <!--renderer type="lookup"/-->
          </association>
          <association label="Asset:" target="assetnum" labelfield="asset_.description" extraprojectionvalues="location">
            <renderer type="lookup" params="application=asset;schemaId=assetLookupList;"/>
            <dataprovider prefilterfunction="FilterAssets"/>
            <event type="afterchange" service="srService" method="afterChangeAsset"/>
          </association>
          <field attribute="targetstart" hidden="true" attributeToServer="#notusedattribute"/>
          <field attribute="targetfinish" hidden="true" attributeToServer="#notusedattribute"/>
          <field attribute="actualstart" hidden="true" attributeToServer="#notusedattribute"/>
          <field attribute="actualfinish" hidden="true" attributeToServer="#notusedattribute"/>
          <section id="targetStart" resourcepath="/Content/Templates/samelinepickers.html"
                         parameters="joinattribute=targetstart;">
            <header label="Target Start Date:" displacement="sameline"/>
          </section>
          <section id="targetFinish" resourcepath="/Content/Templates/samelinepickers.html"
                         parameters="joinattribute=targetfinish;">
            <header label="Target Finish Date:" displacement="sameline"/>
          </section>
          <section id="actualStart" resourcepath="/Content/Templates/samelinepickers.html"
                         parameters="joinattribute=actualstart;">
            <header label="Actual Start Date:" displacement="sameline"/>
          </section>
          <section id="actualFinish" resourcepath="/Content/Templates/samelinepickers.html"
                         parameters="joinattribute=actualfinish;">
            <header label="Actual Finish Date:" displacement="sameline"/>
          </section>
          <field label="Status:" attribute="status" readonly="true" default="NEW" requiredexpression="true"/>
          <field attribute="statusdate" hidden="true" />
        </schema>

        <detail mode="input" title="Incident Details">
          <field attribute="actlabcost" default="0" hidden="true"/>
          <field attribute="actlabhrs" default="0" hidden="true" />
          <field attribute="ticketuid" label="Incident Id:" hidden="true"/>
          <field attribute="ticketid" label="Incident Number:" readonly="true" requiredexpression="true"/>
          <field attribute="description" label="Summary:"/>
          <field label="Details:" attribute="longdescription_.ldtext">
            <renderer type="textarea"/>
          </field>
          <!-- Code added from gric metadata.xml SWWEB 173-->
          <section id="attachmentsection" />
          <field attribute="reportedby" label="Reported By:" default="@username" readonly="true"/>
          <association label="Affected Person:" target="affectedperson" labelfield="person_.displayname" default="@username">
            <renderer type="lookup"/>
          </association>
          <association label="Owner:"  target="owner" labelfield="ownerperson_.displayname" default="@username" enableexpression="@ownergroup==null">
            <renderer type="lookup"/>
            <event type="afterchange" service="srService" method="afterchangeowner"/>
          </association>
          <!-- Added the Owner Group field-->
          <association label="Owner Group:" target="ownergroup" labelfield="persongroup_.description" enableexpression="@owner==null">
            <renderer type="lookup"/>
          </association>
          <optionfield attribute="classstructureid" label="Classification:" providerattribute="_IncidentClassStructureType" default="@classstructureid">
            <renderer type="autocompleteclient" />
          </optionfield>
          <field label="Site Id:" attribute="siteid"  readonly="true"/>
          <field attribute ="orgid" hidden ="true"/>
          <field attribute ="class" hidden="true"/>
          <optionfield label="Priority:" attribute="internalpriority" default="1">
            <renderer type="radio"/>
            <option label="Critical" value="1"/>
            <option label="High" value="2"/>
            <option label="Medium" value="3"/>
            <option label="Low" value="4"/>
            <option label="Planning" value="5"/>
          </optionfield>
          <association label="Location:" target="location" labelfield="location_.description" >
            <event type="beforechange" service="srService" method="beforeChangeLocation"/>
            <!--renderer type="lookup"/-->
          </association>
          <association label="Asset:" target="assetnum" labelfield="asset_.description" extraprojectionvalues="location">
            <renderer type="lookup" params="application=asset;schemaId=assetLookupList;"/>
            <dataprovider prefilterfunction="FilterAssets"/>
            <event type="afterchange" service="srService" method="afterChangeAsset"/>
          </association>
          <field attribute="targetstart" hidden="true" attributeToServer="#notusedattribute"/>
          <field attribute="targetfinish" hidden="true" attributeToServer="#notusedattribute"/>
          <field attribute="actualstart" hidden="true" attributeToServer="#notusedattribute"/>
          <field attribute="actualfinish" hidden="true" attributeToServer="#notusedattribute"/>
          <section id="targetStart" resourcepath="/Content/Templates/samelinepickers.html"
                         parameters="joinattribute=targetstart;">
            <header label="Target Start Date:" displacement="sameline"/>
          </section>
          <section id="targetFinish" resourcepath="/Content/Templates/samelinepickers.html"
                         parameters="joinattribute=targetfinish;">
            <header label="Target Finish Date:" displacement="sameline"/>
          </section>
          <section id="actualStart" resourcepath="/Content/Templates/samelinepickers.html"
                         parameters="joinattribute=actualstart;">
            <header label="Actual Start Date:" displacement="sameline"/>
          </section>
          <section id="actualFinish" resourcepath="/Content/Templates/samelinepickers.html"
                         parameters="joinattribute=actualfinish;">
            <header label="Actual Finish Date:" displacement="sameline"/>
          </section>
          <field label="Status:" attribute="status" readonly="true" />
          <tab label="Solution" id="solution">

            <field attribute="solution" hidden="true"/>
            <association label="Solution:" target="solution" labelfield="solution_.description" extraprojectionvalues="symptom_.ldtext,cause_.ldtext,resolution_.ldtext">
              <renderer type="lookup"/>
              <event type="afterchange" service="solutionService" method="setsolutiondata"/>
            </association>
            <field attribute="solution_.description" label="Description:" readonly="true"/>
            <field attribute="symptom_.ldtext" label="Symptom:">
              <renderer type="richtext"/>
            </field>
            <field attribute="cause_.ldtext" label="Cause:" >
              <renderer type="richtext"/>
            </field>
            <field attribute="resolution_.ldtext" label="Resolution:" >
              <renderer type ="richtext"/>
            </field>
          </tab>
          <composition relationship="attachment" label="Attachments">
            <collectionproperties allowcreation="@status!='CLOSED' &amp;&amp; @status!='CAN'"/>
          </composition>
          <!--composition relationship="solution" label="Solution">
            <collectionproperties allowcreation="@status!='CLOSED' &amp;&amp; @status!='CAN'"/>
          </composition-->
          <event type="beforesubmit.prevalidation" service="genericTicketService" method="validateCloseStatus"/>
        </detail>

        
      </schemas>

    </application>

  </applications>




</metadata>
