<?xml version="1.0" encoding="utf-8" ?>
<metadata xmlns="http://www.controltechnologysolutions.com/metadata">

  <templates>
    <template path="@solution.xml"/>
    <template path="@attachments.xml"/>
  </templates>

  <entities>
    <entity name="incident" idAttribute="ticketuid" useridAttribute="ticketid">

      <relationships>
        <relationship to="asset">
          <relationshipAttribute from="assetnum" to="assetnum" primary="true"/>
          <relationshipAttribute from="siteid" to="siteid" />
        </relationship>
        <relationship to="longdescription" qualifier="ld">
          <relationshipAttribute from="ticketuid" to="ldkey" primary="true"/>
          <relationshipAttribute to="ldownertable" literal="TICKET" quoteLiteral="true" />
          <relationshipAttribute to="ldownercol" literal="DESCRIPTION" quoteLiteral="true" />
        </relationship>
        <relationship to="location">
          <relationshipAttribute from="location" to="location" primary="true"/>
          <relationshipAttribute from="siteid" to="siteid" />
        </relationship>
        <relationship to="relatedrecord" collection="true">
          <relationshipAttribute from="ticketid" to="recordkey" primary="true"/>
          <relationshipAttribute to="class" literal="INCIDENT" quoteLiteral="true"/>
        </relationship>
        <relationship to="worklog" collection="true">
          <relationshipAttribute from="ticketid" to="recordkey" primary="true" />
          <relationshipAttribute from="siteid" to="siteid" />
          <relationshipAttribute to="class" literal="INCIDENT" quoteLiteral="true" />
        </relationship>
        <relationship to="DOCLINKS" qualifier="attachment" collection="true">
          <relationshipAttribute from="ticketuid" to="ownerid" primary="true"/>
          <relationshipAttribute to="ownertable" literal="INCIDENT" quoteLiteral="true"/>
        </relationship>
        <relationship to="person" qualifier="affectedperson">
          <relationshipAttribute from="affectedperson" to="personid" primary="true"/>
        </relationship>
      
        <relationship to="person" qualifier="reporter">
          <relationshipAttribute from="reportedby" to="personid" primary="true"/>
        </relationship>

        <relationship to="person">
          <relationshipAttribute from="affectedperson" to="personid" primary="true"/>
          <relationshipAttribute to="status" literal="ACTIVE" quoteLiteral="true" />
        </relationship>

        <relationship to="person" qualifier="ownerperson">
          <relationshipAttribute from="owner" to="personid" primary="true"/>
        </relationship>
        <relationship to="person" qualifier="reportedbyperson">
          <relationshipAttribute from="reportedby" to="personid" primary="true"/>
        </relationship>
        <relationship to ="persongroup">
          <relationshipAttribute from ="ownergroup" to ="persongroup" primary="true"/>
        </relationship>
      
        
        <relationship to="classification" qualifier="classification">
          <relationshipAttribute from="classificationid" to ="classificationid" primary="true"/>
        </relationship>
        <relationship to="classification" qualifier="incidentclassifications">
          <relationshipAttribute from="classificationid" to="classificationid" primary="true"/>
        </relationship>
        <relationship to ="solution" qualifier="solution" >
          <relationshipAttribute from="solution" to ="solution" primary="true"/>
        </relationship>

        <relationship to="longdescription" qualifier="symptom">
          <relationshipAttribute from="ticketuid" to="ldkey" primary="true"/>
          <relationshipAttribute to="ldownertable" literal="TICKET" quoteLiteral="true" />
          <relationshipAttribute to="ldownercol" literal="PROBLEMCODE" quoteLiteral="true" />
        </relationship>
        <relationship to="longdescription" qualifier="cause">
          <relationshipAttribute from="ticketuid" to="ldkey" primary="true"/>
          <relationshipAttribute to="ldownertable" literal="TICKET" quoteLiteral="true" />
          <relationshipAttribute to="ldownercol" literal="FR1CODE" quoteLiteral="true" />
        </relationship>
        <relationship to="longdescription" qualifier="resolution">
          <relationshipAttribute from="ticketuid" to="ldkey" primary="true"/>
          <relationshipAttribute to="ldownertable" literal="TICKET" quoteLiteral="true" />
          <relationshipAttribute to="ldownercol" literal="FR2CODE" quoteLiteral="true" />
        </relationship>
        <relationship to="synonymdomain" qualifier="synstatus" cacheable="true">
          <relationshipAttribute from="status" to="value" primary="true"/>
          <relationshipAttribute to="domainid" literal="INCIDENTSTATUS" quoteLiteral="true" />
        </relationship>

        <relationship to ="commlog" collection="true">
          <relationshipAttribute from="ticketuid" to="ownerid" primary="true" />
          <relationshipAttribute to="ownertable" literal="INCIDENT" quoteLiteral="true"/>
        </relationship>


      </relationships>
      <connectorParameters>
        <connectorParameter key="dbtable" value="incident" />
        <connectorParameter key="integration_interface" value="SWINCIDENT" />
        <connectorParameter key="customconnector" value="softWrench.sW4.Data.Persistence.WS.Commons.BaseIncidentCrudConnector" />
      </connectorParameters>
    </entity>

  </entities>

  <applications>

    <application name="incident" title="Incident" entity="incident">
      <filters>
        <optionfilter attribute="internalpriority" displaycode="true">
          <option xmlns="http://www.controltechnologysolutions.com/filters" label="High" value="1" />
          <option xmlns="http://www.controltechnologysolutions.com/filters" label="Medium" value="2" />
          <option xmlns="http://www.controltechnologysolutions.com/filters" label="Low" value="3" />
        </optionfilter>
        <optionfilter attribute="statusicons" displaycode="true">
          <option xmlns="http://www.controltechnologysolutions.com/filters" label="Attachments" value="attachmentcounter" />
        </optionfilter>
      </filters>
      <schemas>
        <list title="Incident Grid">
          <field attribute="ticketid" label="Incident#">
            <renderer type="default" params="width=12%"/>
          </field>
          <field attribute="description" label="Summary">
            <renderer type="default" params="excelwidth=50" />
          </field>
          <field attribute="asset_.description" label="Asset">
            <renderer type="default" params="width=15%" />
          </field>
          <field attribute="targetfinish" label="Target Finish">
            <renderer type="datetime" params="width=12%;showtime=false" />
          </field>
          <field attribute="reportdate" label="Reported Date">
            <renderer type="datetime" params="width=12%;showtime=false" />
          </field>
          <field attribute="ownergroup" label="Owner Group">
            <renderer type="default" params="width=12%" />
          </field>
          <field attribute="status" label="Status">
            <renderer type="statuscolor" params="width=12%;grid=incident;column=status" />
          </field>
          <field attribute="internalpriority" tooltip="Priority">
            <renderer type="priorityicon" params="width=5%;icon=fa-flag;headericon=true;changevalue=true;onclick=priorityService.setPriority"/>
          </field>
          <field attribute="attachmentcounter" tooltip="Attachments" hidden="true">
            <renderer type="icon" params="hideValueOnTooltip=true;icon=fa-paperclip;autoloadcomposition=attachment_"/>
          </field>
          <field attribute="statusicons" tooltip="Status Icons">
            <renderer type="statusicons" params="width=5%;iconcolumns=attachmentcounter;icon=fa-tachometer;headericon=true;showsort=false"/>
          </field>
          <properties>
            <property key="list.click.schema" value="detail"/>
            <property key="list.width.min" value="1280px"/>
          </properties>
        </list>

        <schema id="adetail" title="Request Details" abstract="true" stereotype="detail">
          <field attribute="actlabcost" default="0" hidden="true"/>
          <field attribute="actlabhrs" default="0" hidden="true" />
          <field attribute="ticketuid" label="Incident ID" hidden="true"/>

          <field attribute="class" label="" hidden="true"/>
          <field attribute="solution" hidden="true"/>
          <field attribute="assetsiteid" hidden="true"/>
          <field attribute="location" hidden="true"/>
          <field attribute="assetnum" hidden="true"/>
          <field attribute="failurecode" hidden="true"/>
          <field attribute="cinum" hidden="true"/>

          <section orientation="horizontal">
            <renderer type="default" params="childinputsize=large" />
            <field attribute="description" label="Summary">
              <renderer type="default" params="maxlength=100;inputsize=xlarge"/>
            </field>
            <section id="statussection"/>
            <field label="Site" attribute="siteid" readonly="true"/>
          </section>

          <section>
            <field label="Details" attribute="ld_.ldtext">
              <renderer type="textarea"/>
            </field>
            <field attribute="statusdate" hidden="true" />
            <field attribute ="orgid" hidden ="true"/>
            <field attribute ="class" hidden ="true"/>

            <section orientation="horizontal">
              <renderer type="default" params="childinputsize=medium" />
              
              <association label="Location" target="location" labelfield="location_.description" >
                <renderer type="lookup" />
                <event type="beforechange" service="srService" method="beforeChangeLocation"/>
              </association>
              
              <association label="Asset" target="assetnum" labelfield="asset_.description" extraprojectionvalues="location">
                <renderer type="lookup" params="application=asset;schemaId=assetLookupList;"/>
                <dataprovider prefilterfunction="FilterAssets"/>
                <event type="afterchange" service="srService" method="afterChangeAsset"/>
              </association>
              <optionfield attribute="classstructureid" label="Classification" providerattribute="_IncidentClassStructureType" default="@classstructureid">
                <renderer type="lookup" />
              </optionfield>
              
              <optionfield attribute="internalpriority" label="Priority" providerattribute="_SWPriorityType" default="1">
                <renderer type="lookup" />
              </optionfield>
          
            </section>
          </section>
           
          <section orientation="horizontal">
            <header displacement="ontop" label="Responsibility" params="fieldset=true" />
            <renderer type="default" params="childinputsize=medium" />
            <field attribute="reportedby" label="Reported By" default="@personid" readonly="true"/>
            <association label="Affected Person" target="affectedperson" labelfield="person_.displayname" default="@personid">
              <renderer type="lookup"/>
            </association>
            <association label="Owner"  target="owner" labelfield="ownerperson_.displayname" enableexpression="@ownergroup==null">
              <renderer type="lookup"/>
              <event type="afterchange" service="srService" method="afterchangeowner"/>
            </association>
            <association label="Owner Group" target="ownergroup" labelfield="persongroup_.description" enableexpression="@owner==null">
              <renderer type="lookup"/>
            </association>
          </section>

          <section orientation="horizontal">
            <header displacement="ontop" label="Scheduling" params="fieldset=true" />
            <renderer type="default" params="childinputsize=medium" />

            <!-- target -->
            <section orientation="vertical">
              <field attribute="targetstart" label="Target Start Date" attributeToServer="#notusedattribute">
                <renderer type="datetime" params="format=MM/dd/yyyy;"/>
              </field>
              <field attribute="targetfinish" label="Target Finish Date" attributeToServer="#notusedattribute">
                <renderer type="datetime" params="format=MM/dd/yyyy;"/>
              </field>
            </section>

            <!-- actual -->
            <section orientation="vertical">
              <field attribute="actualstart" label="Actual Start Date" attributeToServer="#notusedattribute">
                <renderer type="datetime" params="format=MM/dd/yyyy;"/>
              </field>
              <field attribute="actualfinish" label="Actual Finish Date" attributeToServer="#notusedattribute">
                <renderer type="datetime" params="format=MM/dd/yyyy;"/>
              </field>
            </section>
          </section>

          <section orientation="horizontal">
            <header displacement="ontop" label="Miscellaneous" params="fieldset=true" />
            <renderer type="default" params="childinputsize=medium" />
            <section id="attachmentsection" />
          </section>

          <section id="compositions"/>
        </schema>
        
        <schema id="newdetail" stereotype="detailnew" parentschema="adetail" mode="input" title="New Incident">
          <section id="attachmentsection">
            <field label="Attachment" attribute="newattachment" >
              <renderer type="upload"/>
            </field>
          </section>
        </schema>
        
        <schema parentschema="adetail" id="editdetail" title="Incident Details">
          <section id="statussection">
            <field attribute="ticketid" label="Incident#" readonly="true" requiredexpression="false" hidden="true"/>
            
            <association label="Status" target="status" labelfield="synstatus.description" requiredexpression="false">
              <renderer type="lookup" />
            </association>
          </section>
          
          <section id="compositions">
            <tab label="Solution" id="solution" icon="fa fa-book">
              <field attribute="solution" hidden="true"/>
              <association label="Solution" target="solution" labelfield="solution_.description" extraprojectionvalues="symptom_.ldtext,cause_.ldtext,resolution_.ldtext">
                <renderer type="lookup"/>
                <event type="afterchange" service="solutionService" method="setsolutiondata"/>
              </association>
              <field attribute="solution_.description" label="Description" readonly="true"/>
              <field attribute="symptom_.ldtext" label="Symptom">
                <renderer type="richtext"/>
              </field>
              <field attribute="cause_.ldtext" label="Cause" >
                <renderer type="richtext"/>
              </field>
              <field attribute="resolution_.ldtext" label="Resolution" >
                <renderer type ="richtext"/>
              </field>
            </tab>
            <composition relationship="attachment" label="Attachments" >
              <collectionproperties  allowcreation="@status!='CLOSED' &amp;&amp; @status!='CAN'" prefilterfunction="BuildRelatedAttachmentsWhereClause"/>
            </composition>
          </section>
          
          <event type="beforesubmit.postvalidation" service="genericTicketService" method="handleStatusChange"/>
        </schema>
      </schemas>
    </application>
  </applications>
</metadata>
