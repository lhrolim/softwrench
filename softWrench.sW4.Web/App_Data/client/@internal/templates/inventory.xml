<?xml version="1.0" encoding="utf-8" ?>
<metadata xmlns="http://www.example.org/metadata" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://www.example.org/metadata ../../../Schema/Metadata.xsd ">

  <templates>
    <template path="@chartofaccounts.xml"/>
    <template path="@workorder.xml"/>
  </templates>
  
  <entities>
    <entity name="invissue" idAttribute="matusetransid" parententity="matusetrans" whereclause="(ISSUETYPE = 'ISSUE' or ISSUETYPE = 'RETURN')">
      <relationships>
        <relationship to="workorder" >
          <relationshipAttribute from="refwo" to="wonum" primary="true"/>
        </relationship>
        <relationship to="person" qualifier="issuetoperson">
          <relationshipAttribute from="issueto" to="personid" primary="true"/>
        </relationship>
        <relationship to="asset" >
          <relationshipAttribute from="assetnum" to="assetnum" primary="true"/>
          <relationshipAttribute from="siteid" to="siteid" />
        </relationship>
        <relationship to="location">
          <relationshipAttribute from="location" to="location" primary="true"/>
          <relationshipAttribute from="siteid" to="siteid" />
        </relationship>
      </relationships>
      <connectorParameters>
        <connectorParameter key="customconnector" value="softWrench.sW4.Data.Persistence.WS.Commons.BaseInventoryIssueCrudConnector" />
      </connectorParameters>
    </entity>

  </entities>


  <applications>
    <application name="invissuewo" title="Issue/Return" entity="workorder">
      <schemas>
        <schema id="newdetail" stereotype="detail" mode="input">
          <field attribute="#refwo" label="Workorder" readonly="true"/>
          <field attribute="wonum" hidden="true"/>
          <field attribute="assetnum" label="Asset" readonly="true"/>
          <field attribute="location" label="Location" readonly="true"/>
          <field attribute="#issueto" label="Issue To" readonly="true"/>
          <field attribute="#assetnum" hidden="true"/>
          <field attribute="#location" hidden="true"/>
          <field attribute="#storeloc" label="Storeroom" readonly="true"/>
          <field attribute="#issuetype" label="Issue Type" readonly="true"/>
          <composition relationship="invissue" label="Items" detailschema="newitem">
            <collectionproperties listschema="itemlist" allowcreation="true" hideexistingdata="true" autocommit="false" />
          </composition>
          <event type="onload" service="scannerdetectionService" method="initIssueItemListener"/>
          <properties>
            <property key="detail.navigationbuttons.disabled" value="true"/>
          </properties>
          <commandbars>
            <commandgroup position="detailform" removeundeclared="true">
              <command id="savenewinvissue" label="Submit" service="inventoryService" method="submitNewInvIssue" parameters="schema,datamap" />
              <command id="cancelnewinvissue" label="Cancel" service="inventoryService" method="cancelNewInvIssue" />
            </commandgroup>
          </commandbars>
        </schema>
      </schemas>
    </application>
   
    <application name="inventory" title="Inventory" entity="inventory">
      <schemas>
        <list>
          <field attribute="itemnum"/>
          <field attribute="binnum"/>
          <field attribute="location"/>
          <field attribute="siteid"/>
          <field attribute="orgid"/>
          <field attribute="status"/>
        </list>
      </schemas>
    </application>

    <application name="invissue" title="Issue Inventory" entity="invissue">
      <schemas>
        <list id="invissuelist" title="Issues and Returns">
          <properties>
            <property key="list.click.service" value="inventoryService.editinvissuedetail"/>
          </properties>
          <commandbars>
            <commandgroup position="gridtop">
              <command id="bulk_issue" label="Bulk Issue" service="inventoryService" method="createIssue" parameters="schema,datamap" position=">filter"
             successmessage="Issue created"/>
              <command id="create_issue" label="New Issue" service="inventoryService" method="createReturn" parameters="schema,datamap"
             successmessage="Return created"/>
              <command id="test" label="Test" service="inventoryService" method="test" parameters="schema,datamap" successmessage="Return created"/>
            </commandgroup>
          </commandbars>
          <field attribute="matusetransid" hidden="true"/>
          <field attribute="storeloc" hidden="true"/>
          <field attribute="binnum" hidden="true"/>
          <field attribute="itemnum" label="Item">
            <renderer type="default" params="width=12%;"/>
          </field>
          <field attribute="refwo" label="Workorder">
            <renderer type="default" params="width=12%;"/>
          </field>
          <field attribute="issueto" label="Issue To">
            <renderer type="default" params="width=12%;"/>
          </field>
          <field attribute="assetnum" label="Asset">
            <renderer type="default" params="width=12%;"/>
          </field>
          <field attribute="location" label="Location">
            <renderer type="default" params="width=12%;"/>
          </field>
          <field attribute="issuetype" label="Issue Type">
            <renderer type="default" params="width=12%;"/>
          </field>
          <field attribute="quantity" label="Quantity">
            <renderer type="default" params="width=12%;"/>
          </field>
          <field attribute="qtyrequested" label="Quantity Returned">
            <renderer type="default" params="width=12%;"/>
          </field>
          <section resourcepath="/Content/Templates/otb/invissuereturnaction.html"></section>
        </list>

        <schema id="itemlist" stereotype="compositionlist">
          <properties>
            <property key="list.click.popup" value="modal"/>
            <property key="list.disablepagination" value="true"/>
            <property key="nextschema.schemaid" value="newitem"/>
          </properties>
          <commandbars>
            <commandgroup position="compositiontop" removeundeclared="true"/>
            <commandgroup position="compositionbottom" >
              <removecommand id="print"/>
              <removecommand id="cancel"/>
              <removecommand id="add"/>
              <command id="additem" label="Add Item" service="inventoryService" method="displayPopupModal" parameters="parentschema,parentdatamap"/>
              <command id="savenewinvissue" label="Submit" service="inventoryService" method="submitNewInvIssue" parameters="schema,datamap" />
              <command id="cancelnewinvissue" label="Cancel" service="inventoryService" method="cancelNewInvIssue" />
            </commandgroup>
          </commandbars>
          <field attribute="itemnum" label="Item"/>
          <field attribute="matusetransid" hidden="true"/>
          <field attribute="refwo" hidden="true"/>
          <field attribute="issueto" hidden="true"/>
          <field attribute="assetnum" hidden="true"/>
          <field attribute="location" hidden="true"/>
          <field attribute="item_.description" label="Description"/>
          <field attribute="quantity" label="Quantity"/>
          <field attribute="issuetype" label="Issue Type"/>
          <field attribute="storeloc" hidden="true"/>
        </schema>

        <schema id="viewinvissuedetail" stereotype="detail" mode="output">
          <field attribute="matusetransid" hidden="true"/>
          <field attribute="itemnum" label="Item" readonly="true"/>
          <field attribute="item_.description" label="Description" readonly="true"/>
          <field attribute="refwo" label="Workorder" readonly="true"/>
          <field attribute="issueto" label="Issue To" readonly="true"/>
          <field attribute="assetnum" label="Asset" readonly="true"/>
          <field attribute="location" label="Location" readonly="true"/>
          <field attribute="issuetype" label="Issue Type" readonly="true"/>
          <field attribute="storeloc" label="Storeroom" readonly="true"/>
          <field attribute="quantity" label="Quantity Returned"/>
          <commandbars>
            <commandgroup position="detailform">
              <removecommand id="save"/>
            </commandgroup>
          </commandbars>
        </schema>

        <schema id="editinvissuedetail" stereotype="detail" mode="input">
          <field attribute="matusetransid" hidden="true"/>
          <field attribute="itemnum" label="Item" readonly="true"/>
          <field attribute="item_.description" label="Description" readonly="true"/>
          <field attribute="refwo" label="Workorder" readonly="true"/>
          <field attribute="issueto" label="Issue To" readonly="true"/>
          <field attribute="assetnum" label="Asset" readonly="true"/>
          <field attribute="location" label="Location" readonly="true"/>
          <field attribute="issuetype" label="Issue Type" readonly="true"/>
          <field attribute="storeloc" label="Storeroom" readonly="true"/>
          <field attribute="quantity" label="Quantity Issued" readonly="true"/>
          <field attribute="qtyrequested" label="Quantity Returned" readonly="true"/>
          <field attribute="#quantityadj" label="New Return Quantity" default="1">
            <renderer type="numericinput" params="min=1;max=({0} + {1});maxExprVar=quantity,qtyrequested;"/>
          </field>
          <commandbars>
            <commandgroup position="detailform">
              <removecommand id="save"/>
            </commandgroup>
          </commandbars>
        </schema>

        <schema id="newitem" stereotype="compositiondetail" mode="input" >
          <association label="Item:" target="itemnum" labelfield="item_.description" extraprojectionvalues="description,issueunit,itemtype" required="true">
            <renderer type="lookup"/>
            <event type="afterchange" service="inventoryService" method="afterchangeinvissueitem"/>
          </association>
          <field attribute="quantity" label="Quantity" default="1">
            <renderer type="numericinput" params="min=1;"/>
          </field>
          <field attribute="unitcost" label="Unit Cost" readonly="true"/>
          <field attribute="item_.issueunit" label="Issue Unit" readonly="true"/>
          <field attribute="storeloc" label="Storeroom" hidden="true"/>
          <field attribute="enterby" label="Entered By" readonly="true"/>
          <field attribute="item_.itemtype" label="Item Type" readonly="true"/>
          <field attribute="siteid" label="Entered By" readonly="true"/>
          <!--<field attribute="curbal" label="Current Balance" readonly="true"/>-->
          <commandbars>
            <commandgroup position="detailform" removeundeclared="true">
              <command id="savenewitem" label="Save Item" service="inventoryService" method="addItemToInvIssue" parameters="schema,datamap,parentdata,clonedcompositiondata,originalDatamap, previousdata"/>
              <command id="cancelnewitem" label="Cancel" service="inventoryService" method="cancelNewInvIssueItem" />
            </commandgroup>
          </commandbars>
          <field attribute="matusetransid" hidden="true"/>
          <field attribute="refwo" label="Workorder" hidden="true"/>
          <field attribute="issueto" label="Issue To" hidden="true"/>
          <field attribute="assetnum" label="Asset" hidden="true"/>
          <field attribute="location" label="Location" hidden="true"/>
          <field attribute="issuetype" label="Issue Type" hidden="true"/>

        </schema>

        <schema id="filter" stereotype="detail" title="Issues and Returns" mode="input" platform="Web">
          <field attribute="matusetransid" hidden="true"/>
          <association label="Workorder" target="refwo" labelfield="workorder_.description" extraprojectionvalues="location,assetnum,glaccount">
            <renderer type="lookup"/>
            <event type="afterchange" service="inventoryService" method="afterchangeworkorder"/>
          </association>
          <association label="Issue To" target="issueto" labelfield="issuetoperson_.displayname">
            <renderer type="lookup"/>
          </association>
          <association label="Asset" target="assetnum" labelfield="asset_.assetnum" extraprojectionvalues="location,glaccount">
            <event type="afterchange" service="inventoryService" method="invIssue_afterChangeAsset"/>
          </association>
          <association label="Location" target="location" labelfield="location_.description" extraprojectionvalues="glaccount">
            <event type="afterchange" service="inventoryService" method="invIssue_afterChangeLocation"/>
          </association>
          <association label="Storeroom" target="storeloc" labelfield="storeroom_.description" required="true" >
            <renderer type="combo"/>
          </association>
          <!-- TODO: Modify to use default attribute instead of evalexpression attribute. -->
          <optionfield attribute="issuetype" label="Issue Type" required="true" evalexpression="ctx:fetchFromContext('matusetrans',true,false).issueType">
            <renderer type="combo"/>
            <option label="ISSUE" value="ISSUE"/>
            <option label="RETURN" value="RETURN"/>
          </optionfield>
          <field attribute="gldebitacct" label="GL Debit Account"/>
          <field attribute="glcreditacct" label="GL Credit Account" />
          <commandbars>
            <commandgroup position="detailform">
              <command id="start_issuing" label="Start Issuing" service="inventoryService" position="&lt;save" method="editinvissuewo" parameters="schema,datamap"/>
              <removecommand id="save"/>
              <removecommand id="print"/>
            </commandgroup>
          </commandbars>
        </schema>
        
      <detail title="Test" mode="input" platform="Web">
          <field attribute="matusetransid" hidden="true"/>
          <association label="Workorder" target="refwo" labelfield="workorder_.description" extraprojectionvalues="location,assetnum,glaccount">
            
            <renderer type="lookup"/>
            <event type="afterchange" service="inventoryService" method="afterchangeworkorder"/>
          </association>
          <association label="Issue To" target="issueto" labelfield="issuetoperson_.displayname">
            <renderer type="lookup"/>
          </association>
          <association label="Asset" target="assetnum" labelfield="asset_.assetnum" extraprojectionvalues="location,glaccount">
            <event type="afterchange" service="inventoryService" method="invIssue_afterChangeAsset"/>
          </association>
          <association label="Location" target="location" labelfield="location_.description" extraprojectionvalues="glaccount">
            <event type="afterchange" service="inventoryService" method="invIssue_afterChangeLocation"/>
          </association>
          <association label="Storeroom" target="storeloc" labelfield="storeroom_.description" required="true" >
            <renderer type="combo"/>
          </association>
          <!-- TODO: Modify to use default attribute instead of evalexpression attribute. -->
          <optionfield attribute="issuetype" label="Issue Type" required="true" evalexpression="ctx:fetchFromContext('matusetrans',true,false).issueType">
            <renderer type="combo"/>
            <option label="ISSUE" value="ISSUE"/>
            <option label="RETURN" value="RETURN"/>
          </optionfield>
          <field attribute="gldebitacct" label="GL Debit Account"/>
          <field attribute="glcreditacct" label="GL Credit Account" />

        </detail>
   
      </schemas>
    </application>

  </applications>




</metadata>
