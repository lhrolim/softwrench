<?xml version="1.0" encoding="utf-8" ?>
<metadata xmlns="http://www.controltechnologysolutions.com/metadata"
          xmlns:f="http://www.controltechnologysolutions.com/filters">
  <templates>
    <!--Email-->
    <template path="@email.xml"/>

    <!--Phone-->
    <template path="@phone.xml"/>
    <template path="@location.xml"/>
  </templates>

  <entities>

    <entity name="person" idAttribute="personuid" useridAttribute="personid">
      <attributes>
        <attribute name="personid" type="varchar" required="true" />
        <attribute name="status" type="varchar" required="true" />
        <attribute name="displayname" type="varchar" required="false" />
        <attribute name="firstname" type="varchar" required="false" />
        <attribute name="lastname" type="varchar" required="false" />
        <attribute name="department" type="varchar" required="false" />
        <attribute name="title" type="varchar" required="false" />
        <attribute name="employeetype" type="varchar" required="false" />
        <attribute name="jobcode" type="varchar" required="false" />
        <attribute name="supervisor" type="varchar" required="false" />
        <attribute name="birthdate" type="datetime" required="false" />
        <attribute name="lastevaldate" type="datetime" required="false" />
        <attribute name="nextevaldate" type="datetime" required="false" />
        <attribute name="hiredate" type="datetime" required="false" />
        <attribute name="terminationdate" type="datetime" required="false" />
        <attribute name="location" type="varchar" required="false" />
        <attribute name="locationsite" type="varchar" required="false" />
        <attribute name="locationorg" type="varchar" required="false" />
        <attribute name="shiptoaddress" type="varchar" required="false" />
        <attribute name="billtoaddress" type="varchar" required="false" />
        <attribute name="droppoint" type="varchar" required="false" />
        <attribute name="wfmailelection" type="varchar" required="false" />
        <attribute name="transemailelection" type="varchar" required="true" />
        <attribute name="delegate" type="varchar" required="false" />
        <attribute name="delegatefromdate" type="datetime" required="false" />
        <attribute name="delegatetodate" type="datetime" required="false" />
        <attribute name="pcardnum" type="varchar" required="false" />
        <attribute name="pcardtype" type="varchar" required="false" />
        <attribute name="pcardexpdate" type="varchar" required="false" />
        <attribute name="pcardverification" type="varchar" required="false" />
        <attribute name="addressline1" type="varchar" required="false" />
        <attribute name="addressline2" type="varchar" required="false" />
        <attribute name="addressline3" type="varchar" required="false" />
        <attribute name="city" type="varchar" required="false" />
        <attribute name="regiondistrict" type="varchar" required="false" />
        <attribute name="county" type="varchar" required="false" />
        <attribute name="stateprovince" type="varchar" required="false" />
        <attribute name="country" type="varchar" required="false" />
        <attribute name="postalcode" type="varchar" required="false" />
        <attribute name="vip" type="int" required="false" />
        <attribute name="statusdate" type="datetime" required="true" />
        <attribute name="acceptingwfmail" type="smallint" required="true" />
        <attribute name="wopriority" type="int" required="false" />
        <attribute name="loctoservreq" type="smallint" required="true" />
        <attribute name="personuid" type="bigint" required="true" />
        <attribute name="langcode" type="varchar" required="true" />
        <attribute name="sendersysid" type="varchar" required="false" />
        <attribute name="sourcesysid" type="varchar" required="false" />
        <attribute name="ownersysid" type="varchar" required="false" />
        <attribute name="externalrefid" type="varchar" required="false" />
        <attribute name="language" type="varchar" required="false" />
        <attribute name="locale" type="varchar" required="false" />
        <attribute name="timezone" type="varchar" required="false" />
        <attribute name="hasld" type="smallint" required="true" />
        <attribute name="primarysms" type="varchar" required="false" />
        <attribute name="ownergroup" type="varchar" required="false" />
        <attribute name="im_id" type="varchar" required="false" />
        <attribute name="caltype" type="varchar" required="false" />
        <attribute name="rowstamp" type="timestamp" required="true" />
        <attribute name="dfltapp" type="varchar" required="false" />
        <attribute name="deviceclass" type="smallint" required="false" />

      </attributes>
      <relationships>
        <relationship to="maxuser">
          <relationshipAttribute from="personid" to="personid" primary="true"/>
        </relationship>
        <relationship to="email" collection="true">
          <relationshipAttribute from="personid" to="personid" primary="true"/>
        </relationship>
        <relationship to="phone" collection="true">
          <relationshipAttribute from="personid" to="personid" primary="true"/>
        </relationship>
        <relationship to="site">
          <relationshipAttribute from="locationsite" to="siteid" primary="true"/>
        </relationship>
        <relationship to="organization">
          <relationshipAttribute from="locationorg" to="orgid" primary="true"/>
        </relationship>
        <relationship to="location">
          <relationshipAttribute from="location" to="location" primary="true"/>
          <relationshipAttribute from="locationsite" to="siteid"/>
          <relationshipAttribute to="type" query="!@type != 'STOREROOM'"/>
        </relationship>
      </relationships>
      <connectorParameters>
        <connectorParameter key="dbtable" value="person" />
        <connectorParameter key="integration_interface" value="SWPERSON" />
        <connectorParameter key="customconnector" value="softWrench.sW4.Data.Persistence.WS.Commons.BasePersonCrudConnector" />
      </connectorParameters>

    </entity>

  </entities>
  
  <applications>
    <application name="person" title="Person" entity="person">
      <properties>
        <property key="list.defaultorderby" value="personid asc"/>
        <property key="detail.navigationbuttons.disabled" value="true"/>
      </properties>

      <filters>
        <booleanfilter attribute="maxuser_.active" truelabel="Active" falselabel="Inactive"></booleanfilter>
      </filters>

      <schemas>


        <schema id="compositionlist" stereotype="compositionlist">
          <field attribute="displayname" label="Display Name" qualifier="title"/>
        </schema>
        <schema id="compositiondetail" stereotype="compositiondetail">
          <field attribute="personid" hidden="true" />
          <field attribute="displayname" label="Display Name" requiredexpression="true" />
        </schema>


        <schema id="list" stereotype="list" title="Users">
          <field attribute="personuid" hidden="true"/>
          <field attribute="personid" label="Username"/>
          <field attribute="firstname" label="First Name"/>
          <field attribute="lastname" label="Last Name"/>
          <field attribute="#isactive" label="Active (softWrench)" enableexpression="false" readonly="true">
            <renderer type="checkbox"/>
          </field>
          <field attribute="maxuser_.active" label="Active (MAXIMO)" readonly="true" enableexpression="false">
            <renderer type="checkbox" />
          </field>

          <field attribute="displayname" label="Display Name" qualifier="title" hidden="true"/>
        </schema>

        <schema id="detail" stereotype="detail" title="User Profile">
          <event type="beforesubmit.onvalidation" service="personService" method="validatePerson"/>

          <section id="statistics" resourcepath="/Content/Templates/usersetup/userstatistics.html"></section>

          <field attribute="personuid" label="Person ID" hidden="true"/>
          <field attribute="personid" label="Username" requiredexpression="true" readonly="true"/>

          <field attribute="#password" label="Password" showexpression="!@ldapEnabled">
            <renderer type="password" params="placeholder=Blank to keep current stored password;avoidautofocus=true"/>
          </field>
          <field attribute="#retypepassword" label="Retype Password" showexpression="!@ldapEnabled">
            <renderer type="password" params="placeholder=Blank to keep current stored password;avoidautofocus=true"/>
          </field>
          <field attribute="firstname" label="First Name" requiredexpression="true"/>
          <field attribute="lastname" label="Last Name" requiredexpression="true"/>
          <association target="locationorg" labelfield="organization_.description" label="Org ID" requiredexpression="true" defaultexpression="@orgid">
            <renderer type="lookup"/>
          </association>
          <association target="locationsite" labelfield="site_.description" label="Site ID" requiredexpression="true" defaultexpression="@siteid">
            <renderer type="lookup"/>
          </association>
          <association target="location" labelfield="location_.description" label="Location">
            <renderer type="lookup"/>
          </association>
          <field attribute="department" label="Department"/>
          <field attribute="langcode" label="Language"/>
          <field attribute="#isactive" label="Active (softWrench)">
            <renderer type="checkbox"/>
          </field>

          <field attribute="maxuser_.active" hidden="true"/>

          <field attribute="#maxactive" label="Active (MAXIMO)" readonly="true" enableexpression="false">
            <renderer type="checkbox" />
          </field>

          <composition relationship="phone" label="Phone Numbers" inline="false" >
            <collectionproperties allowcreation="true" allowupdate="true" allowremoval="!@primary" />
          </composition>
          <composition relationship="email" label="Email Addresses" inline="false">
            <collectionproperties allowcreation="true" allowupdate="true" allowremoval="!@primary"/>
          </composition>

          <tab label="Security Groups" icon="fa-gear" id="permission" role="sysadmin">
            <section attribute="#profiles" resourcepath="/Content/Templates/otb/profiles.html" >
              <header displacement="ontop" label="Profiles" showexpression="true"/>
            </section>
          </tab>

          <tab label ="Preferences" icon="fa-cogs" id="preferences" >
            <field attribute="#signature" label="Email Signature">
              <renderer type="richtext"/>
            </field>
          </tab>

          <commandbars>
            <commandgroup position="detail.primary">
              <removecommand id="save"/>
              <command id="save" icon="fa fa-check" label="Save" service="personService" method="submitPerson" position="left" parameters="schema,datamap" cssclasses="large-button"/>
              <command id="cancel" icon="fa-times" service="personService" method="cancelEdition" label="Cancel" tooltip="Cancel" cssclasses="large-button"/>
            </commandgroup>
          </commandbars>
        </schema>

        <schema id="myprofiledetail" parentschema="detail" title="Edit My Profile">
          <!-- Fix for SWWEB-1245-->
<!--          <commandbars>-->
<!--            <commandgroup position="detail.primary">-->
<!--              -->
<!--            </commandgroup>-->
<!---->
<!--          </commandbars>-->
        </schema>

        <schema id="newPersonDetail" stereotype="detailnew" title="New User" mode="input">
          <event type="beforesubmit.onvalidation" service="personService" method="validatePerson"/>
          <field attribute="personuid" label="Person ID" showexpression="false" default="-1"/>
          <field attribute="#personid" label="Username" requiredexpression="@personuid == -1" showexpression="@personuid == -1">
            <event type="afterchange" service="personService" method="afterChangeUsername"/>
          </field>
          <field attribute="personid" label="Username" showexpression="@personuid != -1" readonly="true" />
          <field attribute="#primaryemail" requiredexpression="true" label="Primary Email" tooltip="The user will receive a confirmation link on this email"/>

          <optionfield attribute="passwordmode" default="auto" label="Password Generation" showexpression="!@ldapEnabled"
                       tooltip="If Automatic an email with a link will be sent to the new users where they will be able to select a password. 
                       On manual mode the user will receive the assigned password via email">
            <renderer type="radio"/>
            <option value="auto" label="Automatic"/>
            <option value="manual" label="Manual"/>
          </optionfield>

          <section orientation="vertical" showexpression="@passwordmode == 'manual'">
            <field attribute="#password" label="Password" showexpression="!@ldapEnabled" requiredexpression="true">
              <renderer type="password"  params="placeholder=Leave it blank to make the system autogenerate it;avoidautofocus=true"/>
            </field>
            <field attribute="#retypepassword" label="Retype Password" showexpression="!@ldapEnabled" requiredexpression="true">
              <renderer type="password" params="placeholder=Leave it blank to make the system autogenerate it;avoidautofocus=true"/>
            </field>
          </section>

          <field attribute="firstname" label="First Name" requiredexpression="true"/>
          <field attribute="lastname" label="Last Name" requiredexpression="true"/>

          <field attribute="#primaryphone" label="Primary Phone" />
          <association target="locationorg" labelfield="organization_.description" label="Org ID" default="@orgid" requiredexpression="true">
            <renderer type="lookup"/>
          </association>
          <association target="locationsite" labelfield="site_.description" label="Site ID" default="@siteid" requiredexpression="true">
            <renderer type="lookup"/>
          </association>
          <association target="location" labelfield="location_.description" label="Location">
            <renderer type="lookup"/>
          </association>
          <field attribute="department" label="Department"/>
          <optionfield attribute="langcode" label="Language">
            <option label="English" value="EN"/>
            <option label="Spanish" value="ES"/>
          </optionfield>
          <field attribute="#isactive" label="Active" default="1">
            <renderer type="checkbox"/>
          </field>


          <!--          <composition relationship="phone" label="Phone Numbers" inline="false" >-->
          <!--            <collectionproperties allowcreation="true" allowupdate="false"/>-->
          <!--          </composition>-->
          <!--          <composition relationship="email" label="Email Addresses" inline="false">-->
          <!--            <collectionproperties allowcreation="true" allowupdate="false"/>-->
          <!--          </composition>-->

          <tab label="Security Groups" icon="fa-gear" id="permission" showexpression="" role="sysadmin">
            <section attribute="#profiles" resourcepath="/Content/Templates/otb/profiles.html">
              <header displacement="ontop" label="Profiles" showexpression="true"/>
            </section>
          </tab>

        </schema>
        
        <schema id="userselectlist" stereotype="list.selection.modal" title="Users">
          <properties>
            <property key="schema.customparamprovider" value="userProfileService.getProfileId"/>
          </properties>

          <field attribute="personuid" hidden="true"/>
          <field attribute="personid" label="Username"/>
          <field attribute="firstname" label="First Name"/>
          <field attribute="lastname" label="Last Name"/>
          <field attribute="#isactive" label="Active (softWrench)" enableexpression="false" readonly="true">
            <renderer type="checkbox"/>
          </field>
          <field attribute="maxuser_.active" label="Active (MAXIMO)" readonly="true" enableexpression="false">
            <renderer type="checkbox" />
          </field>
          <field attribute="displayname" label="Display Name" qualifier="title" hidden="true"/>
        </schema>

        <schema id="userremovelist" stereotype="list.selection.modal" title="Users">
          <properties>
            <property key="schema.customparamprovider" value="userProfileService.getProfileId"/>
          </properties>

          <field attribute="personuid" hidden="true"/>
          <field attribute="personid" label="Username"/>
          <field attribute="firstname" label="First Name"/>
          <field attribute="lastname" label="Last Name"/>
          <field attribute="#isactive" label="Active (softWrench)" enableexpression="false" readonly="true">
            <renderer type="checkbox"/>
          </field>
          <field attribute="maxuser_.active" label="Active (MAXIMO)" readonly="true" enableexpression="false">
            <renderer type="checkbox" />
          </field>
          <field attribute="displayname" label="Display Name" qualifier="title" hidden="true"/>
        </schema>
      </schemas>
    </application>
  </applications>
</metadata>