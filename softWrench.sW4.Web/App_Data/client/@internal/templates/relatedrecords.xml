<?xml version="1.0" encoding="utf-8" ?>
<metadata xmlns="http://www.controltechnologysolutions.com/metadata">

  <entities>
    <entity name="relatedrecord" idAttribute="relatedrecordid">
      <relationships>
        <relationship to="SR" qualifier="relatedservicerequest">
          <relationshipAttribute from="relatedreckey" to="ticketid" primary="true"/>
          <relationshipAttribute from="siteid" to="siteid" allowsnull="true" />
          <relationshipAttribute from="orgid"  to="orgid"  allowsnull="true" />
        </relationship>
        <relationship to="INCIDENT" qualifier="relatedincident">
          <relationshipAttribute from="relatedreckey" to="ticketid" primary="true"/>
          <relationshipAttribute from="siteid" to="siteid" allowsnull="true" />
          <relationshipAttribute from="orgid"  to="orgid"  allowsnull="true" />
        </relationship>
        <relationship to="workorder" qualifier="relatedworkorder">
          <relationshipAttribute from="relatedreckey" to="wonum" primary="true"/>
          <relationshipAttribute from="siteid" to="siteid" allowsnull="true" />
          <relationshipAttribute from="orgid"  to="orgid"  allowsnull="true" />
        </relationship>
      </relationships>
    </entity>
  </entities>
  
  
  <applications>    
    <application name="relatedrecord" title="Related Records" entity="relatedrecord" id="00000000-0000-0000-0000-000000000008" >
      <properties>
        <property key ="icon.composition.tab" value="fa fa-tags"/>
      </properties>
      <schemas>
        <list stereotype="compositionlist">
          <properties>
            <property key="list.click.service" value="relatedrecordService.open"/>
            <property key="list.search.quicksearchfields" value=""/>
          </properties>
<!--          <commandbars>-->
<!--            <commandgroup position="compositiontop" >-->
<!--              <container id="addrelated" label="Add Related Record" position=">refresh" icon="fa-plus" tooltip="Add related record entry">-->
<!--                <command id="addrelatedch" label="Change" icon="fa-random" service="relatedrecordService" method="create" parameters="'change',parentdatamap"/>-->
<!--                <command id="addrelatedin" label="Incident" icon="fa-warning" service="relatedrecordService" method="create" parameters="'incident',parentdatamap"/>-->
<!--                <command id="addrelatedsr" label="Service Request" icon="fa-ticket" service="relatedrecordService" method="create" parameters="'servicerequest',parentdatamap"/>-->
<!--              </container>-->
<!--            </commandgroup>-->
<!--          </commandbars>-->
          <field attribute="relatedreckey" label="Related Record Key" />
          <field attribute="relatedrecclass" label="Related Record Class" />
          <field attribute="siteid" hidden="true" />
        </list>
        
        <detail stereotype="compositiondetail" title="Related Record" platform="web">
          <field attribute="relatedrecordid" hidden="true" />
          
          <!-- display detail -->
          <section showexpression="!!@relatedrecordid">
            <field attribute="relatedreckey" label="Related Record Key" />
            <field attribute="relatedrecclass" label="Related Record Class" />
            <field attribute="siteid" hidden="true" />
          </section>
          
          <!-- creation -->
          <section showexpression="!@relatedrecordid">

            <field attribute="siteid" defaultexpression="$.parentdata.fields.siteid" hidden="true"/>
            <field attribute="orgid"  defaultexpression="$.parentdata.fields.orgid"  hidden="true"/>
            
            <optionfield attribute="relatedrecclass" label="Application" requiredexpression="true" default="" providerattribute="_RelatedRecordTypes">
              <!--<option label="Service Request" value="SR" />
              <option label="Work Order" value="WORKORDER" />-->
              <event type="afterchange" service="relatedrecordService" method="clearSelectedRelatedEntityId"/>
            </optionfield>
            
            <field attribute="relatedrecsiteid" hidden="true" />
            <field attribute="relatedrecorgid"  hidden="true" />

            <association target="relatedreckey" labelfield="relatedservicerequest_.description" 
                         extraprojectionvalues="siteid,orgid,ticketuid" orderbyfield="ticketuid desc"
                         requiredexpression="true"
                         label="Related To"
                         showexpression="@relatedrecclass==='SR'">
              <renderer type="lookup"/>
              <event type="afterchange" service="relatedrecordService" method="onAfterRelatedEntitySelected"/>
            </association>

            <association target="relatedreckey" labelfield="relatedincident_.description"
                         extraprojectionvalues="siteid,orgid,ticketuid" orderbyfield="ticketuid desc"
                         requiredexpression="true"
                         label="Related To"
                         showexpression="@relatedrecclass==='INCIDENT'">
              <renderer type="lookup"/>
              <event type="afterchange" service="relatedrecordService" method="onAfterRelatedEntitySelected"/>
            </association>

            <association target="relatedreckey" labelfield="relatedworkorder_.description" 
                         extraprojectionvalues="siteid,orgid,statusdate" orderbyfield="statusdate desc"
                         label="Related To"
                         requiredexpression="true"
                         showexpression="@relatedrecclass==='WORKORDER'">
              <renderer type="lookup"/>
              <event type="afterchange" service="relatedrecordService" method="onAfterRelatedEntitySelected"/>
            </association>
          
          </section>
        
        </detail>
        
        <schema id="newdetail" title="New Related Record" stereotype="detailnew" platform="web">
          <field attribute="recordkey" label="Record Key" hidden="true"/>
          <field attribute="class" label="Class" hidden="true"/>
          <field attribute="relatedreckey" label="Related Record Key" hidden="true"/>
          <field attribute="relatedrecclass" label="Related Record Class" hidden="true"/>
          <field attribute="relatedrecsiteid" label="Related Record Site ID" hidden="true"/>
          <field attribute="relatedrecorgid" label="Related Record Org ID" hidden="true"/>
          <field attribute="siteid" label="Site ID" hidden="true"/>
          <field attribute="orgid" label="Org ID" hidden="true"/>
          <field attribute="relatetype" label="Related Record Type" hidden="true"/>
        </schema>
      
      </schemas>
    
    </application>
  </applications>

</metadata>
