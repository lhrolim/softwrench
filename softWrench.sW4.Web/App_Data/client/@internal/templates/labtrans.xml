<?xml version="1.0" encoding="utf-8" ?>
<metadata xmlns="http://www.controltechnologysolutions.com/metadata">

  <templates>
    <template path="@chartofaccounts.xml"/>
    <template path="@labor.xml"/>
  </templates>

  <entities>
    <entity name="labtrans" idAttribute="labtransid">
      <relationships>
        <relationship to="labor">
          <relationshipAttribute from="laborcode" to="laborcode" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid" />
        </relationship>
        <relationship to="laborcraftrate">
          <relationshipAttribute from="craft" to="craft" primary="true"/>
          <relationshipAttribute from="laborcode" to="laborcode"/>
          <relationshipAttribute from="orgid" to="orgid" />
        </relationship>
        <relationship to="chartofaccounts" >
          <relationshipAttribute from="gldebitacct" to="glaccount" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid" />
        </relationship>
      </relationships>
      <connectorParameters>
        <connectorParameter key="dbtable" value="labtrans" />
      </connectorParameters>
    </entity>
  </entities>

  <applications>
    <application name="labtrans" entity="labtrans" title="Labor">
      <properties>
        <property key ="icon.composition.tab" value="fa fa-clock-o"/>
      </properties>
      <schemas>
        <list>
          <field attribute="labtransid" hidden="true"/>
          
          <field attribute="laborcode" label="Labor" qualifier="title"/>
          <field attribute="regularhrs" label="Regular Hours" qualifier="subtitle"/>
          <field attribute="gldebitacct" label="GL Debit Account" qualifier="subtitle"/>
          <field attribute="transdate" label="Created Date"/>
          <field attribute="genapprservreceipt" hidden="true"/>
          <event type="onremoval.validation" service="labtranService" method="validateRemoval"/>
          <event type="onedit.validation" service="labtranService" method="validateEdit"/>
        </list>

        <schema id="detail" stereotype="detail" title="Labor">
          <field attribute="labtransid" hidden="true"/>
          <field attribute="orgid" hidden="true"/>
          <field attribute="siteid" hidden="true"/>
          <field attribute="laborcode" hidden="true" />
          <field attribute="transtype" hidden="true" />
          <field attribute="genapprservreceipt" hidden="true"/>
          <field attribute="refwo" hidden="true" />
          <field attribute="enterby" hidden="true" />
          <field attribute="laborcraftrate_.rate" hidden="true" attributeToServer="payrate"/>
          <field attribute="labor_.worksite" hidden="true" />
          <field attribute="labor_.orgid" hidden="true" />

          <composition inline="true" relationship="#laborlist" label="Labors"  detailschema="" printschema="" showexpression="@_iscreation" requiredrelationshipexpression="true">
            <collectionproperties listschema="labors" autocommit="false"/>
            <renderer type="TABLE" params="mode=batch;composition.inline.startwithentry=true"/>
          </composition>

          <!--Shows only on line expand -->
          <field label="Labor" attribute="laborcode" showexpression="!@_iscreation"/>
          <field label="Craft" attribute="craft" showexpression="!@_iscreation"/>

          <section orientation="horizontal">
            <field label="Start Date" requiredexpression="true" attribute="startdate">
              <renderer type="date" params="format=MM/dd/yyyy;showtime=false;allowfuture=false" />
              <event type="afterchange" service="labtranService" method="afterDateTimeChange"/>
            </field>
            <field label="Start Time" attribute="starttime" >
              <renderer type="time" params="format=HH:mm;showdate=false" />
              <event type="afterchange" service="labtranService" method="afterDateTimeChange"/>
            </field>
          </section>
          <section orientation="horizontal">
            <field label="End Date" attribute="finishdate">
              <renderer type="date" params="format=MM/dd/yyyy;showtime=false" />
              <event type="afterchange" service="labtranService" method="afterDateTimeChange"/>
            </field>
            <field label="End Time" attribute="finishtime" >
              <renderer type="time" params="format=HH:mm;showdate=false" />
              <event type="afterchange" service="labtranService" method="afterDateTimeChange"/>
            </field>
          </section>
          <field attribute="regularhrs" label="Regular Hours" requiredexpression="true" default="8"/>
          <association label="GL Debit Account" target="gldebitacct" labelfield="chartofaccounts_.accountname" defaultexpression="$.parentdata.fields.glaccount">
            <renderer type="lookup"/>
          </association>
        </schema>

        <schema id="labors" stereotype="compositionlist">
          <association label="Labor" target="laborcode" labelfield="labor_.laborcode" requiredexpression="true" extraprojectionvalues="worksite, orgid">
            <renderer type="lookup"/>
            <event type="afterchange" service="labtranService" method="afterlaborchange"/>
          </association>
          <association label="Craft" requiredexpression="true" target="craft" labelfield="laborcraftrate_.craft" dependantfields="laborcode" extraprojectionvalues="defaultcraft, rate">
            <renderer type="autocompleteclient" />
            <event type="afterchange" service="labtranService" method="aftercraftchange"/>
          </association>
        </schema>
      </schemas>
    </application>

    <application entity="laborcraftrate" name="laborcraftrate" title="Craft">
      <schemas>
        <list platform="mobile">
          <field attribute="craft" />
          <field attribute="rate" />
          <field attribute="laborcode" />
          <field attribute="orgid" />
        </list>
      </schemas>
    </application>

  </applications>

</metadata>
