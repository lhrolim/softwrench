<?xml version="1.0" encoding="utf-8" ?>
<metadata xmlns="http://www.controltechnologysolutions.com/metadata">

  <templates>
    <template path="@chartofaccounts.xml"/>
    <template path="@labor.xml"/>
  </templates>

  <entities>

    <entity name="ppcraftrate" idAttribute="ppcraftrateid">
      <attributes>
        <attribute name="craft" type="varchar" required="true" />
        <attribute name="orgid" type="varchar" required="true" />
        <attribute name="ratetype" type="varchar" required="false" />
        <attribute name="rate" type="decimal" required="false" />
        <attribute name="inherit" type="smallint" required="true" />
        <attribute name="ppcraftrateid" type="bigint" required="true" />
        <attribute name="premiumpaycode" type="varchar" required="true" />
        <attribute name="rowstamp" type="timestamp" required="true" />
      </attributes>
      <relationships>
        <relationship to="premiumpay">
          <relationshipAttribute from="premiumpaycode" to="premiumpaycode" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>
      </relationships>
      <connectorParameters>
        <connectorParameter key="dbtable" value="ppcraftrate" />
      </connectorParameters>
    </entity>
    <entity name="laborcraftrate" idAttribute="laborcraftrateid">
      <attributes>
        <attribute name="craft" type="varchar" required="true" />
        <attribute name="skilllevel" type="varchar" required="false" />
        <attribute name="laborcode" type="varchar" required="true" />
        <attribute name="orgid" type="varchar" required="true" />
        <attribute name="contractnum" type="varchar" required="false" />
        <attribute name="inherit" type="smallint" required="true" />
        <attribute name="defaultcraft" type="smallint" required="true" />
        <attribute name="rate" type="decimal" required="false" />
        <attribute name="glaccount" type="varchar" required="false" />
        <attribute name="controlaccount" type="varchar" required="false" />
        <attribute name="laborcraftrateid" type="bigint" required="true" />
        <attribute name="defaultticketglacc" type="varchar" required="false" />
        <attribute name="vendor" type="varchar" required="false" />
        <attribute name="rowstamp" type="timestamp" required="true" />
      </attributes>
      <connectorParameters>
        <connectorParameter key="dbtable" value="laborcraftrate" />
      </connectorParameters>
    </entity>

    <entity name="premiumpay" idAttribute="premiumpayid">
      <attributes>
        <attribute name="orgid" type="varchar" required="true" />
        <attribute name="description" type="varchar" required="false" />
        <attribute name="defaultratetype" type="varchar" required="true" />
        <attribute name="defaultrate" type="decimal" required="false" />
        <attribute name="globalppcode" type="smallint" required="true" />
        <attribute name="premiumpayid" type="bigint" required="true" />
        <attribute name="premiumpaycode" type="varchar" required="true" />
        <attribute name="langcode" type="varchar" required="true" />
        <attribute name="hasld" type="smallint" required="true" />
        <attribute name="rowstamp" type="timestamp" required="true" />
      </attributes>
      <connectorParameters>
        <connectorParameter key="dbtable" value="premiumpay" />
      </connectorParameters>
    </entity>

    <entity name="labortranstype" idAttribute="synonymdomainid" parententity="synonymdomain" whereclause="DOMAINID = 'LTTYPE'">
      <connectorParameters>
        <connectorParameter key="dbtable" value="synonymdomain" />
      </connectorParameters>
    </entity>

    <entity name="labtrans" idAttribute="labtransid">
      <relationships>
        <relationship to="labor">
          <relationshipAttribute from="laborcode" to="laborcode" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid" />
        </relationship>
        <relationship to="laborcraftrate">
          <relationshipAttribute from="craft" to="craft" primary="true"/>
          <relationshipAttribute from="laborcode" to="laborcode"/>
          <relationshipAttribute from="orgid" to="orgid" />
        </relationship>
        <relationship to="ppcraftrate">
          <relationshipAttribute from="premiumpaycode" to="premiumpaycode" primary="true"/>
          <relationshipAttribute from="craft" to="craft"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>
        <relationship to="chartofaccounts" >
          <relationshipAttribute from="gldebitacct" to="glaccount" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid" />
        </relationship>
        <relationship to="labortranstype" qualifier="lttype">
          <relationshipAttribute from="transtype" to="value" primary="true"/>
        </relationship>
        <relationship to="workorder">
          <relationshipAttribute from="refwo" to="wonum" primary="true"/>
          <relationshipAttribute from="siteid" to="siteid"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>
        <relationship to="asset">
          <relationshipAttribute from="assetnum" to="assetnum" primary="true"/>
          <relationshipAttribute from="siteid" to="siteid"/>
        </relationship>
        <relationship to="location">
          <relationshipAttribute from="location" to="location" primary="true"/>
          <relationshipAttribute from="siteid" to="siteid"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>
      </relationships>
      <connectorParameters>
        <connectorParameter key="dbtable" value="labtrans" />
        <connectorParameter key="integration_interface" value="SWEMPACT" />
        <!--TODO: use these for delete/updates -->
        <connectorParameter key="integration_interface_operations" value="" />
      </connectorParameters>
    </entity>
   
  </entities>

  <applications>
    <application name="labtrans" entity="labtrans" title="Labor">
      <properties>
        <property key ="icon.composition.tab" value="fa fa-clock-o"/>
      </properties>

      <filters>
        <booleanfilter attribute="genapprservreceipt"/>
      </filters>
      
      <schemas>
        <schema id="compositionlist" title="Labor List" stereotype="compositionlist">
          <field attribute="labtransid" hidden="true"/>
          <field attribute="laborcode" label="Labor" qualifier="title"/>
          <field attribute="regularhrs" label="Regular Hours" qualifier="subtitle"/>
          <field attribute="gldebitacct" label="GL Debit Account" qualifier="subtitle"/>
          <field attribute="transdate" label="Created Date"/>
          <field attribute="genapprservreceipt" label="Approved?">
            <renderer type="checkbox"/>
          </field>
          <field attribute="linecost" label="Line Cost">
            <renderer type="default" params="formatter=money"/>
          </field>
          <event type="onremoval.validation" service="labtransService" method="validateEdit"/>
          <event type="onedit.validation" service="labtransService" method="validateEdit"/>
        </schema>

        <schema id="list" stereotype="list.selection" title="Labor Reporting Grid">
          <properties>
            <property key="list.selectionstyle" value="multiple"/>
            <property key="list.click.service" value="labtransService.listClick"/>
          </properties>
          <commandbars>
            <commandgroup position="actions">
              <command id="approvelabors" icon="fa fa-check-circle" label="Approve"
                       service="labtransService" method="approveMultipleLabtrans" cssclasses="large-button" showexpression="service:genericTicketService.hasSelectedItemsForBatchStatus"/>
              <command id="deletelabor" icon="fa fa-trash" label="Delete"
                       service="labtransService" method="deleteMultipleLabtrans" cssclasses="large-button" showexpression="service:genericTicketService.hasSelectedItemsForBatchStatus"/>
            </commandgroup>
            <commandgroup position="multiselect.dropdown">
              <command id="approvelabors" icon="fa fa-check-circle" label="Approve Labor"
                       service="labtransService" method="approveMultipleLabtrans"/>
              <command id="deletelabor" icon="fa fa-trash" label="Delete Labor"
                       service="labtransService" method="deleteMultipleLabtrans"/>
            </commandgroup>
          </commandbars>
          <field attribute="labtransid" hidden="true"/>
          <field attribute="laborcode" label="Labor"/>
          <field attribute="craft" label="Craft"/>
          <field attribute="refwo" label="Work Order"/>
          <field attribute="workorder_.historyflag" hidden="true"/>
          <field attribute="startdate" label="Start Date">
            <renderer type="date" params="format=MM/dd/yyyy;showtime=false"/>
          </field>
          <field attribute="regularhrs" label="Regular Hours"/>
          <field attribute="premiumpaycode" label="Prem Pay Code"/>
          <field attribute="premiumpayhours" label="Plus Rate Hours"/>
          <field attribute="transtype" label="Type"/>
          <field attribute="genapprservreceipt" label="Approved?">
            <renderer type="checkbox"/>
          </field>
          <field attribute="linecost" label="Line Cost">
            <renderer type="default" params="formatter=money"/>
          </field>
        </schema>

        <schema id="detail" stereotype="detail" title="Labor Reporting Detail" platform="web">
          <field attribute="labtransid" hidden="true"/>
          <field attribute="orgid" hidden="true"/>
          <field attribute="siteid" hidden="true"/>
          <field attribute="laborcode" hidden="true" />
          <field attribute="transtype" hidden="true" />
          <field attribute="genapprservreceipt" hidden="true"/>
          <field attribute="refwo" hidden="true" />
          <field attribute="enterby" hidden="true" />
          <field attribute="laborcraftrate_.rate" hidden="true" attributeToServer="payrate"/>
          <field attribute="labor_.worksite" hidden="true" />
          <field attribute="labor_.orgid" hidden="true" />

          <composition inline="true" relationship="#laborlist" label="Labors"  detailschema="" printschema="" showexpression="@_iscreation" requiredrelationshipexpression="true">
            <collectionproperties listschema="wolabors" autocommit="false"/>
            <renderer type="TABLE" params="mode=batch;composition.inline.startwithentry=true"/>
          </composition>

          <!--Shows only on line expand -->
          <field label="Labor" attribute="laborcode" showexpression="!@_iscreation"/>
          <field label="Craft" attribute="craft" showexpression="!@_iscreation"/>
          <field attribute="linecost" label="Line Cost" readonly="true" showexpression="!@_iscreation"/>

          <section orientation="horizontal">
            <field label="Start Date" requiredexpression="true" attribute="startdate">
              <renderer type="date" params="format=MM/dd/yyyy;showtime=false;allowfuture=false" />
              <event type="afterchange" service="labtransService" method="afterDateTimeChange"/>
            </field>
            <field label="Start Time" attribute="starttime" >
              <renderer type="time" params="format=HH:mm;showdate=false" />
              <event type="afterchange" service="labtransService" method="afterDateTimeChange"/>
            </field>
          </section>
          <section orientation="horizontal">
            <field label="End Date" attribute="finishdate">
              <renderer type="date" params="format=MM/dd/yyyy;showtime=false" />
              <event type="afterchange" service="labtransService" method="afterDateTimeChange"/>
            </field>
            <field label="End Time" attribute="finishtime" >
              <renderer type="time" params="format=HH:mm;showdate=false" />
              <event type="afterchange" service="labtransService" method="afterDateTimeChange"/>
            </field>
          </section>
          <field attribute="regularhrs" label="Regular Hours" requiredexpression="true" default="8">
            <event type="afterchange" service="labtransService" method="updateLineCost"/>
          </field>
          <association label="GL Debit Account" target="gldebitacct" labelfield="chartofaccounts_.accountname" defaultexpression="$.parentdata.fields.glaccount">
            <renderer type="lookup"/>
          </association>
        </schema>

        <schema id="wolabors" stereotype="compositionlist">
          <field attribute="orgid" hidden="true" defaultexpression="$.parentdata.orgid"/>
          <association label="Labor" target="laborcode" labelfield="labor_.laborcode" requiredexpression="true" extraprojectionvalues="worksite, orgid">
            <renderer type="lookup"/>
            <event type="afterchange" service="labtransService" method="afterlaborchange"/>
          </association>
          <association label="Craft" requiredexpression="true" target="craft" labelfield="laborcraftrate_.craft" dependantfields="laborcode" extraprojectionvalues="defaultcraft, rate">
            <renderer type="autocompleteclient" />
            <event type="afterchange" service="labtransService" method="aftercraftchange"/>
          </association>
          <field attribute="linecost" label="Line Cost"/>
        </schema>

        <schema id="labors" stereotype="compositionlist">
          <association label="Labor" target="laborcode" labelfield="labor_.laborcode" requiredexpression="true" extraprojectionvalues="worksite, orgid" defaultexpression="service:labtransService.defaultLaborExpression" hideDescription="true">
            <renderer type="lookup" params="hideDescription=true"/>
            <event type="afterchange" service="labtransService" method="afterlaborchange"/>
          </association>
          <association label="Craft" requiredexpression="true" target="craft" labelfield="laborcraftrate_.craft" dependantfields="laborcode" extraprojectionvalues="defaultcraft, rate">
            <renderer type="autocompleteclient" />
            <event type="afterchange" service="labtransService" method="aftercraftchange"/>
          </association>
          <association target="premiumpaycode" label="Premium Pay Code" labelfield="ppcraftrate_.premiumpay_.description" extraprojectionvalues="rate">
            <event type="afterchange" service="labtransService" method="updateLineCost"/>
            <renderer type="lookup"/>
          </association>
          <field attribute="linecost" label="Line Cost">
            <renderer type="default" params="formatter=money"/>
          </field>
          <field attribute="laborcraftrate_.rate" hidden="true" attributeToServer="payrate">
            <event type="afterchange" service="labtransService" method="updateLineCost"/>
          </field>
          <field attribute="rate" label="Premium Pay Rate" hidden="true">
            <event type="afterchange" service="labtransService" method="updateLineCost"/>
          </field>
          <field attribute="premiumpayrate" hidden="true"/>
        </schema>

        <schema id="newdetail" title="New Labor Transaction" stereotype="detailnew" platform="web">
          <properties>
            <property key="schema.noninternal" value="true"/>
            <property key="nextschema.schemaid" value="list"/>
          </properties>
          <field attribute="labtransid" hidden="true"/>
          <field attribute="orgid" hidden="true"/>
          <field attribute="siteid" hidden="true"/>
          <field attribute="enterby" hidden="true" />

          <field attribute="labor_.worksite" hidden="true" />
          <field attribute="labor_.orgid" hidden="true" />
          <field label="Trans Date" requiredexpression="true" attribute="transdate" default="@now" enableexpression="false" hidden="true">
            <renderer type="datetime"/>
          </field>
          <field label="Entered Date" requiredexpression="true" attribute="enterdate" default="@now" enableexpression="false" hidden="true">
            <renderer type="datetime"/>
          </field>
          <field attribute="mode" label="Mode" qualifier="batchselector" hidden="true" default="batch"></field>
          <composition inline="true" label="" relationship="#laborlist"  detailschema="" printschema="" showexpression="true" requiredrelationshipexpression="true">
            <collectionproperties listschema="labors" autocommit="false"/>
            <renderer type="TABLE" params="mode=batch;composition.inline.startwithentry=true"/>
          </composition>
          <!--<association label="Labor" target="laborcode" labelfield="labor_.laborcode" requiredexpression="true" extraprojectionvalues="worksite, orgid">
            <renderer type="lookup"/>
            <event type="afterchange" service="labtransService" method="afterlaborchange"/>
          </association>
          <association label="Craft" requiredexpression="true" target="craft" labelfield="laborcraftrate_.craft" dependantfields="laborcode" extraprojectionvalues="defaultcraft, rate">
            <renderer type="autocompleteclient" />
            <event type="afterchange" service="labtransService" method="aftercraftchange"/>
          </association>-->
          <section orientation="horizontal">
            <renderer type="default" params="childinputsize=medium" />
            <field label="Start Date" requiredexpression="true" attribute="startdate" default="@now">
              <renderer type="date" params="format=MM/dd/yyyy;showtime=false;allowfuture=false" />
              <event type="afterchange" service="labtransService" method="afterDateTimeChange"/>
            </field>
            <field attribute="regularhrs" label="Regular Hours" requiredexpression="true" default="8">
              <event type="afterchange" service="labtransService" method="updateLineCost"/>
            </field>
            <association target="transtype" label="Work Type" labelfield="lttype_.description" requiredexpression="true">
              <renderer type="lookup"/>
            </association>
            <association target="refwo" label="Work Order" labelfield="workorder_.description" requiredexpression="@transtype == 'WORK' &amp;&amp; (@location == null &amp;&amp; @assetnum == null &amp;&amp; @gldebitacct == null)">
              <renderer type="lookup"/>
            </association>
            <association target="location" label="Location" labelfield="location_.description" requiredexpression="@transtype == 'WORK' &amp;&amp; (@refwo == null &amp;&amp; @assetnum == null &amp;&amp; @gldebitacct == null)">
              <renderer type="lookup"/>
            </association>
            <association target="assetnum" label="Asset" labelfield="asset_.description" requiredexpression="@transtype == 'WORK' &amp;&amp; (@refwo == null &amp;&amp; @location == null &amp;&amp; @gldebitacct == null)">
              <renderer type="lookup"/>
            </association>
            <association label="GL Debit Account" target="gldebitacct" labelfield="chartofaccounts_.accountname">
              <renderer type="lookup"/>
            </association>
            <field attribute="premiumpayhours" label="Premium Pay Hours">
              <event type="afterchange" service="labtransService" method="updateLineCost"/>
            </field>
          </section>
        </schema>

        <schema id="editdetail" title="Labor Report Details" stereotype="detail" platform="web">
          <commandbars>
            <commandgroup position="multiselect.dropdown">
              <!--<container label="Actions" id="actioncontainer" icon="fa-bolt">-->
                <command id="approvelabors" icon="fa fa-check-circle" label="Approve Labor"
                         service="labtranService" method="approveSingleLabtrans"/>
                <command id="deletelabor" icon="fa fa-trash" label="Delete Labor"
                         service="labtranService" method="deleteSingleLabtrans"/>
              <!--</container>-->
            </commandgroup>
            <commandgroup position="detail.primary">
              <command id="save" service="labtransService" method="save" parameters="datamap" icon="fa-check" cssclasses="large-button"/>
            </commandgroup>
          </commandbars>
          <field attribute="labtransid" hidden="true"/>
          <field attribute="orgid" hidden="true" defaultexpression="$.parentdata.fields.orgid"/>
          <field attribute="siteid" hidden="true" defaultexpression="$.parentdata.fields.siteid"/>
          <field attribute="enterby" hidden="true" />
          <field attribute="genapprservreceipt" hidden="true"/>
          <field attribute="payrate" label="Rate" hidden="true"/>
          <field attribute="premiumpayrate" hidden="true"/>
          <field attribute="linecost" label="Line Cost" hidden="true"/>
          <!--<field attribute="laborcraftrate_.rate" hidden="true" attributeToServer="payrate">
            <event type="afterchange" service="labtransService" method="updateLineCost"/>
          </field>-->
          <field attribute="ppcraftrate_.premiumpay_.defaultrate" label="Premium Pay Rate" hidden="true">
            <event type="afterchange" service="labtransService" method="updateLineCost"/>
          </field>
          <field label="Trans Date" requiredexpression="true" attribute="transdate" enableexpression="false" hidden="true">
            <renderer type="datetime"/>
          </field>
          <field label="Entered Date" requiredexpression="true" attribute="enterdate" enableexpression="false" hidden="true">
            <renderer type="datetime"/>
          </field>

          <section orientation="horizontal">
            <renderer type="default" params="childinputsize=medium" />
            <association label="Labor" target="laborcode" labelfield="labor_.laborcode" requiredexpression="true" extraprojectionvalues="worksite, orgid">
              <renderer type="lookup"/>
              <event type="afterchange" service="labtransService" method="afterlaborchange"/>
            </association>
            <association label="Craft" requiredexpression="true" target="craft" labelfield="laborcraftrate_.craft" dependantfields="laborcode" extraprojectionvalues="defaultcraft, rate">
              <renderer type="lookup" />
              <event type="afterchange" service="labtransService" method="aftercraftchange"/>
            </association>
            <field label="Start Date" requiredexpression="true" attribute="startdate">
              <renderer type="date" params="format=MM/dd/yyyy;showtime=false;allowfuture=false" />
              <event type="afterchange" service="labtransService" method="afterDateTimeChange"/>
            </field>
            <field attribute="regularhrs" label="Regular Hours" requiredexpression="true">
              <event type="afterchange" service="labtransService" method="updateLineCost"/>
            </field>
            <association target="transtype" label="Work Type" labelfield="lttype_.description"  requiredexpression="true">
              <renderer type="lookup"/>
            </association>
            <association target="refwo" label="Work Order" labelfield="workorder_.description" dependantfields="siteid,orgid" requiredexpression="@transtype == 'WORK' &amp;&amp; (@location == null &amp;&amp; @assetnum == null &amp;&amp; @gldebitacct == null)">
              <dataprovider prefilterfunction = "FilterOpenWorkorders" />
              <renderer type="lookup"/>
            </association>
            <association target="location" label="Location" labelfield="location_.description" dependantfields="siteid,orgid" requiredexpression="@transtype == 'WORK' &amp;&amp; (@refwo == null &amp;&amp; @assetnum == null &amp;&amp; @gldebitacct == null)">
              <renderer type="lookup"/>
            </association>
            <association target="assetnum" label="Asset" labelfield="asset_.description" dependantfields="siteid,orgid" requiredexpression="@transtype == 'WORK' &amp;&amp; (@refwo == null &amp;&amp; @location == null &amp;&amp; @gldebitacct == null)">
              <renderer type="lookup"/>
            </association>
            <association label="GL Debit Account" target="gldebitacct" labelfield="chartofaccounts_.accountname">
              <renderer type="lookup"/>
            </association>
            <association target="premiumpaycode" label="Premium Pay Code" labelfield="ppcraftrate_.premiumpay_.description" extraprojectionvalues="rate">
              <event type="afterchange" service="labtransService" method="updateLineCost"/>
              <renderer type="lookup"/>
            </association>
            <field attribute="premiumpayhours" label="Premium Pay Hours">
              <event type="afterchange" service="labtransService" method="updateLineCost"/>
            </field>
            <field attribute="linecost" label="Line Cost" readonly="true">
              <renderer type="default" params="formatter=money"/>
            </field>
          </section>
        </schema>

        <schema id="detail" stereotype="detail" title="Labor Reporting" platform="mobile">
          <field attribute="labtransid" hidden="true"/>
          <field attribute="orgid" hidden="true"/>
          <field attribute="siteid" hidden="true"/>
          <field attribute="laborcode" hidden="true" />
          <field attribute="transtype" hidden="true" />
          <field attribute="genapprservreceipt" hidden="true"/>
          <field attribute="refwo" hidden="true" />
          <field attribute="enterby" hidden="true" />
          <field attribute="laborcraftrate_.rate" hidden="true" attributeToServer="payrate"/>
          <field attribute="labor_.worksite" hidden="true" />
          <field attribute="labor_.orgid" hidden="true" />
          <field label="Labor" attribute="laborcode" showexpression="!@_iscreation"/>
          <field label="Craft" attribute="craft" showexpression="!@_iscreation"/>
          <field attribute="linecost" label="Line Cost" readonly="true" showexpression="!@_iscreation"/>
          <field label="Start Date" requiredexpression="true" attribute="startdate">
            <renderer type="date" params="format=MM/dd/yyyy;showtime=false;allowfuture=false" />
            <event type="afterchange" service="labtransService" method="afterDateTimeChange"/>
          </field>
          <field label="Start Time" attribute="starttime" >
            <renderer type="time" params="format=HH:mm;showdate=false" />
            <event type="afterchange" service="labtransService" method="afterDateTimeChange"/>
          </field>
          <field label="End Date" attribute="finishdate">
            <renderer type="date" params="format=MM/dd/yyyy;showtime=false" />
            <event type="afterchange" service="labtransService" method="afterDateTimeChange"/>
          </field>
          <field label="End Time" attribute="finishtime" >
            <renderer type="time" params="format=HH:mm;showdate=false" />
            <event type="afterchange" service="labtransService" method="afterDateTimeChange"/>
          </field>
          <field attribute="regularhrs" label="Regular Hours" requiredexpression="true" default="8">
            <event type="afterchange" service="labtransService" method="updateLineCost"/>
          </field>
          <association label="GL Debit Account" target="gldebitacct" labelfield="chartofaccounts_.accountname" defaultexpression="$.parentdata.fields.glaccount">
            <renderer type="lookup"/>
          </association>
        </schema>
      </schemas>
    
    </application>

    <application entity="laborcraftrate" name="laborcraftrate" title="Craft">
      <schemas>
        <list platform="mobile">
          <field attribute="craft" />
          <field attribute="rate" />
          <field attribute="laborcode" />
          <field attribute="orgid" />
        </list>
      </schemas>
    </application>
  </applications>

</metadata>
