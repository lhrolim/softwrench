<?xml version="1.0" encoding="utf-8" ?>
<metadata xmlns="http://www.controltechnologysolutions.com/metadata">

  <templates>
    <template path="@worklogs.xml"/>
    <template path="@attachments.xml"/>
    <template path="@relatedrecords.xml"/>
    <template path="@commlogs.xml"/>
    <template path="@failurecode.xml"/>
    <template path="@serviceaddress.xml"/>
  </templates>

  <entities>
    <entity name="SR" idAttribute="ticketuid" useridAttribute="ticketid">
      <attributes>
        <attribute name="originalstatus" query="!@status" type="varchar"/>
      </attributes>

      <relationships>
        <relationship to="asset">
          <relationshipAttribute from="assetnum" to="assetnum" primary="true"/>
          <relationshipAttribute from="assetsiteid" to="siteid" />
        </relationship>
        <relationship to="site">
          <relationshipAttribute from="siteid" to="siteid" primary="true"/>
          <relationshipAttribute to="active" literal="1"/>
        </relationship>
        <relationship to="location">
          <relationshipAttribute from="location" to="location" primary="true"/>
          <relationshipAttribute from="siteid" to="siteid" />
        </relationship>
        <relationship to="worklog" collection="true">
          <relationshipAttribute from="ticketid" to="recordkey" primary="true" />
          <relationshipAttribute from="siteid" to="siteid" allowsnull="true" />
          <relationshipAttribute to="class" literal="SR" quoteLiteral="true" />
        </relationship>
        <relationship to ="commlog" collection="true">
          <relationshipAttribute from="ticketuid" to="ownerid" primary="true" />
          <relationshipAttribute to="ownertable" literal="SR" quoteLiteral="true"/>
        </relationship>
        <relationship to="longdescription" qualifier="ld" lazy="true">
          <relationshipAttribute from="ticketuid" to="ldkey" primary="true"/>
          <relationshipAttribute to="ldownertable" literal="TICKET" quoteLiteral="true" />
          <relationshipAttribute to="ldownercol" literal="DESCRIPTION" quoteLiteral="true" />
        </relationship>
        <relationship to="DOCLINKS" qualifier="attachment" collection="true">
          <relationshipAttribute from="ticketuid" to="ownerid" primary="true"/>
          <relationshipAttribute to="ownertable" literal="SR" quoteLiteral="true"/>
        </relationship>
        <relationship to="relatedrecord" collection="true">
          <relationshipAttribute from="ticketid" to="recordkey" primary="true"/>
          <relationshipAttribute to="class" literal="SR" quoteLiteral="true"/>
        </relationship>
        <relationship to="classstructure">
          <relationshipAttribute from="classstructureid" to="classstructureid" primary="true"/>
        </relationship>
        <relationship to="synonymdomain" qualifier="synstatus" cacheable="true">
          <relationshipAttribute from="status" to="value" primary="true"/>
          <relationshipAttribute to="domainid" literal="SRSTATUS" quoteLiteral="true" />
        </relationship>

        <relationship to="person">
          <relationshipAttribute from="affectedperson" to="personid" primary="true"/>
          <relationshipAttribute to="status" literal="ACTIVE" quoteLiteral="true" />
        </relationship>
        <relationship to="person" qualifier="reportedbyp">
          <relationshipAttribute from="reportedby" to="personid" primary="true"/>
          <!--          <relationshipAttribute from="reportedphone" to="phone_.phonenum"/>-->
          <!--          <relationshipAttribute from="reportedemail" to="email_.emailaddress"/>-->
        </relationship>
        <relationship to="email" qualifier="reportedemail">
          <relationshipAttribute from="reportedby" to="personid" primary="true"/>
          <relationshipAttribute query="reportedemail_.isprimary = 1"/>
        </relationship>
        <relationship to="phone" qualifier="reportedphone">
          <relationshipAttribute from="reportedby" to="personid" primary="true"/>
          <relationshipAttribute query="reportedphone_.isprimary = 1"/>
        </relationship>
        <relationship to="person" qualifier="ownerperson">
          <relationshipAttribute from="owner" to="personid" primary="true"/>
        </relationship>
        <relationship to ="persongroup" >
          <relationshipAttribute from ="ownergroup" to ="persongroup" primary="true"/>
        </relationship>

        <relationship to ="persongroup" qualifier="ownergroup">
          <relationshipAttribute from ="ownergroup" to ="persongroup" primary="true"/>
        </relationship>
        <!--COMSW 24 Reverse Lookup of Service Address (Lazy Fetch)-->
        <relationship to="sraddress" reverselookupattribute="addresscode" >
          <relationshipAttribute from="ticketid" to="tkserviceaddress_.ticketid" primary="true"/>
        </relationship>
        <relationship to="tkserviceaddress">
          <relationshipAttribute from="ticketid" to="ticketid" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid"/>
          <relationshipAttribute from="siteid" to="siteid"/>
        </relationship>
        <relationship to="failurelistonly" qualifier="failurelist">
          <relationshipAttribute from="failurecode" to="failurecode" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>
        <relationship to="multiassetlocci" collection="true">
          <relationshipAttribute from="ticketid" to="RECORDKEY" primary="true"/>
          <relationshipAttribute from="class" to="RECORDCLASS" />
          <relationshipAttribute from="siteid" to="siteid" />
        </relationship>

      </relationships>
      <connectorParameters>
        <!--<connectorParameter key="integration_interface" value="SRSWVALIDATIONTEST" />-->
        <connectorParameter key="integration_interface" value="SWSR" />
        <!--<connectorParameter key="integration_interface" value="SWSRnonexistent" />-->
        <connectorParameter key="dispatchwo_customconnector" value="softWrench.sW4.Data.Persistence.Dataset.Commons.Ticket.ServiceRequest.DispatchOperationHandler" />
        <connectorParameter key="dispatchincident_customconnector" value="softWrench.sW4.Data.Persistence.Dataset.Commons.Ticket.ServiceRequest.DispatchOperationHandler" />
        <connectorParameter key="changestatus_customconnector" value="softWrench.sW4.Data.Persistence.Dataset.Commons.Ticket.ChangeStatusTicketHandler" />
      </connectorParameters>
    </entity>
  </entities>

  <applications>


    <application entity="SR" name="servicerequest" title="Service Request" role="sr">

      <components>

        <componentdisplayable id="status">
          <association label="Status" target="status" labelfield="synstatus.description" requiredexpression="true" >
            <dataprovider postfilterfunction="FilterAvailableStatus"/>
            <renderer type="lookup" />
          </association>
        </componentdisplayable>

        <componentdisplayable id="owner">
          <association label="Owner"  target="owner" labelfield="ownerperson_.displayname" enableexpression="@ownergroup==null" orderbyfield="personid asc">
            <renderer type="lookup"/>
            <event type="afterchange" service="genericTicketService" method="afterchangeowner"/>
          </association>
        </componentdisplayable>

        <componentdisplayable id="ownergroup">
          <association label="Owner Group" target="ownergroup" labelfield="ownergroup_.description" enableexpression="@owner==null" orderbyfield="persongroup asc">
            <renderer type="lookup"/>
            <event type="afterchange" service="genericTicketService" method="afterchangeownergroup"/>
          </association>
        </componentdisplayable>

        <componentdisplayable id="worklogs">
          <composition relationship="worklog" label="Work Logs">
            <collectionproperties allowcreation="@originalstatus!='CLOSED'" allowupdate="true" orderbyfield="modifydate desc" />
          </composition>
        </componentdisplayable>

        <componentdisplayable id="commlogs">
          <composition relationship="commlog" label="Communications">
            <collectionproperties allowcreation="@originalstatus!='CLOSED'" allowupdate="false" orderbyfield="createdate desc"/>
            <event type="onviewdetail" service="commlogService" method="updatereadflag"/>
          </composition>
        </componentdisplayable>

        <componentdisplayable id="attachments">
          <composition relationship="attachment" label="Attachments" printenabled="false" >
            <collectionproperties allowupdate="false" allowcreation="@originalstatus!='CLOSED'" allowremoval="@originalstatus!='CLOSED'" prefilterfunction="BuildRelatedAttachmentsWhereClause"/>
          </composition>
        </componentdisplayable>

        <componentdisplayable id="relatedrecords">
          <composition relationship="relatedrecord" label="Related Records">
            <collectionproperties allowupdate="false" allowcreation="@originalstatus!='CLOSED'" />
          </composition>
        </componentdisplayable>


        <componentdisplayable id="srhiddens">
          <field attribute="ticketid" label="SR#" hidden="true"/>
          <field attribute="ticketuid" label="SR#" hidden="true"/>
          <field attribute="originalstatus" hidden="true"/>
          <field attribute="actlabcost" hidden="true" />
          <field attribute="actlabhrs" hidden="true"/>
          <field attribute="orgid" hidden="true"/>
          <field attribute="createby" hidden="true"/>
          <!-- hiddens for communication template -->
          <field attribute="changedate" hidden="true"/>
          <field attribute="classificationid" hidden="true"/>
          <field attribute="reportedemail" hidden="true"/>
          <field attribute="affectedemail" hidden="true"/>

          <field attribute="class" label="" hidden="true"/>
          <field attribute="solution" hidden="true"/>
          <field attribute="assetsiteid" hidden="true"/>
          <field attribute="location" hidden="true"/>
          <field attribute="assetnum" hidden="true"/>
          <field attribute="failurecode" hidden="true"/>
          <field attribute="cinum" hidden="true"/>
          <field attribute="ownerperson_.displayname" hidden="true"/>
        </componentdisplayable>

      </components>

      <filters>
        <optionfilter attribute="status" provider="synstatus_.description" displaycode="true"/>
        <optionfilter attribute="owner" provider="ownerperson_.displayname" allowblank="true">
          <option xmlns="http://www.controltechnologysolutions.com/filters" label="Current User" value="@personid"/>
        </optionfilter>
        <optionfilter attribute="reportedby" provider="reportedbyp_.displayname" allowblank="true">
          <option xmlns="http://www.controltechnologysolutions.com/filters" label="Current User" value="@personid"/>
        </optionfilter>
        <optionfilter attribute="internalpriority" displaycode="true">
          <option xmlns="http://www.controltechnologysolutions.com/filters" label="High" value="1" />
          <option xmlns="http://www.controltechnologysolutions.com/filters" label="Medium" value="2" />
          <option xmlns="http://www.controltechnologysolutions.com/filters" label="Low" value="3" />
        </optionfilter>
        <optionfilter attribute="statusicons" displaycode="true">
          <option xmlns="http://www.controltechnologysolutions.com/filters" label="Communications" value="communicationcounter" />
          <option xmlns="http://www.controltechnologysolutions.com/filters" label="Attachments" value="attachmentcounter" />
          <option xmlns="http://www.controltechnologysolutions.com/filters" label="Related Records" value="relatedcounter" />
        </optionfilter>
      </filters>

      <properties>
        <property key="mobile.disabled" value="true"/>
        <property key="rolealias" value="sr"/>
      </properties>
      <schemas>

        <list title="Service Request Grid" stereotype="list.selection">
          <field attribute="ticketid" label="SR#">
            <renderer type="default" params="width=12%" />
          </field>
          <field attribute="description" label="Summary">
            <renderer type="default" params="excelwidth=50" />
          </field>
          <field attribute="reportedby" label="Reported By">
            <renderer type="default" params="width=15%" />
          </field>
          <field attribute="owner" label="Owner">
            <renderer type="default" params="width=15%" />
          </field>
          <field attribute="siteid" hidden="true"/>
          <field attribute="status" label="Status">
            <renderer type="statuscolor" params="width=12%;grid=servicerequest;column=status" />
          </field>
          <field attribute="internalpriority" tooltip="Priority">
            <renderer type="priorityicon" params="width=5%;icon=fa-flag;headericon=true;changevalue=true;onclick=priorityService.setPriority"/>
          </field>
          <field attribute="communicationcounter" tooltip="Communications" hidden="true">
            <renderer type="icon" params="icon=fa-envelope-o;autoloadcomposition=commlog_"/>
          </field>
          <field attribute="attachmentcounter" tooltip="Attachments" hidden="true">
            <renderer type="icon" params="hideValueOnTooltip=true;icon=fa-paperclip;autoloadcomposition=attachment_"/>
          </field>
          <field attribute="relatedcounter" tooltip="Related Records" hidden="true">
            <renderer type="icon" params="icon=fa-tags;autoloadcomposition=relatedrecord_"/>
          </field>
          <field attribute="statusicons" tooltip="Status Icons">
            <renderer type="statusicons" params="width=9%;iconcolumns=communicationcounter,attachmentcounter,relatedcounter;icon=fa-tachometer;headericon=true;showsort=false"/>
          </field>
          <properties>
            <property key="list.click.schema" value="editdetail"/>
            <property key="list.defaultorderby" value="sr.ticketuid desc"/>
            <property key="list.search.compositionstoexclude" value="attachment,relatedrecord"/>
          </properties>

          <commandbars>
            <commandgroup position="actions">
              <command id="Create" icon="fa-pencil" label="Change Status"
                       showexpression="service:genericTicketService.hasSelectedItemsForBatchStatus"
                       service="genericTicketService" method="initBatchStatusChange"
                       parameters="schema,datamap" cssclasses="large-button"/>
            </commandgroup>
          </commandbars>

        </list>

        <schema id="batchStatusChangeModal" stereotype="detail.modal" title="Change Status">
          <association label="Status" target="status" labelfield="synstatus.description" requiredexpression="true">
            <dataprovider postfilterfunction="FilterAvailableStatus"/>
            <renderer type="lookup"/>
          </association>
        </schema>

        <schema id="adetail" title="Request Details" abstract="true" stereotype="detail">

          <reference id="srhiddens"/>

          <!-- field used for PECSO customization -->
          <field attribute="tophiddenfield" hidden="true"/>


          <section orientation="horizontal">
            <renderer type="default" params="childinputsize=large" />

            <field attribute="description" label="Summary" requiredexpression="true">
              <renderer type="default" params="maxlength=100;inputsize=xlarge" />
            </field>
            <section id="ticketidsection"/>

            <!-- field used for PECSO customization -->
            <field attribute="locationhiddenfield" hidden="true"/>
          </section>

          <section>
            <field label="Details" attribute="ld_.ldtext">
              <renderer type="richtext"/>
            </field>
          </section>



          <field attribute="changeby" default="@personid" hidden="true"/>

          <section orientation="horizontal">
            <header displacement="ontop" label="Responsibility" params="fieldset=true" />
            <renderer type="default" params="childinputsize=medium" />

            <reference id="owner"/>
            <reference id="ownergroup"/>

            <association label="Reported By" target="reportedby" labelfield="reportedbyp_.displayname" default="@personid" orderbyfield="personid asc" >
              <renderer type="lookup" params="columnlabel=Name;"/>
              <event type="afterchange" service="genericTicketService" method="afterChangeReportedBy"/>
            </association>
            <field label="Reported Date" attribute="reportdate" readonly="true" default="@currentdatetime">
              <renderer type="datetime" />
            </field>

            <optionfield attribute="internalpriority" label="Priority" providerattribute="_SWPriorityType">
              <renderer type="lookup"/>
            </optionfield>
          </section>

          <section secondarycontent="true" orientation="vertical">
            <section orientation="horizontal">
              <section>
                <section orientation="horizontal">
                  <header displacement="ontop" label="Work Details" params="fieldset=true" />
                  <renderer type="default" params="childinputsize=large" />
                  <!--<section id ="siteidsection"/>-->
                  <association label="Location" target="location" labelfield="location_.description" dependantfields="siteid" extraprojectionvalues="serviceaddress_.latitudey, serviceaddress_.longitudex, serviceaddress_.addresscode, serviceaddress_.description, serviceaddress_.streetaddress, serviceaddress_.city, serviceaddress_.stateprovince, serviceaddress_.country">
                    <renderer type="lookup"/>
                    <event type="beforechange" service="genericTicketService" method="beforeChangeLocation"/>
                  </association>
                  <association label="Asset" target="assetnum" labelfield="asset_.description" extraprojectionvalues="location" >
                    <renderer type="lookup" params="application=asset;schemaId=assetLookupList;"/>
                    <dataprovider prefilterfunction="FilterAssets"/>
                    <event type="afterchange" service="genericTicketService" method="afterChangeAsset"/>
                  </association>
                  <!--<section id="statussection"/>-->

                  <optionfield attribute="classstructureid" label="Classification" providerattribute="_SRClassStructureTypeDescription">
                    <renderer type="lookup" />
                  </optionfield>

                  <association label="Affected Person" target="affectedperson" labelfield="person_.displayname" default="@personid" orderbyfield="personid asc" >
                    <renderer type="lookup" params="columnlabel=Name"/>
                  </association>
                  <section id="attachmentsection" />

                  <!--COMSW 24 required field for population purposes-->
                  <field attribute="sraddress_.description" attributeToServer="#tkdesc" hidden="true" />
                  <field attribute="sraddress_.staddrnumber" attributeToServer="#tkstaddrnumber" hidden="true" />
                  <field attribute="sraddress_.staddrstreet" attributeToServer="#tkstaddrstreet" hidden="true" />
                  <field attribute="sraddress_.staddrsttype" attributeToServer="#tkstaddrsttype" hidden="true" />
                  <field attribute="sraddress_.formattedaddress" attributeToServer="#tkformattedaddress" hidden="true" />
                  <!--COMSW 24 association field used for lazy lookup-->
                  <association label="Service Address" target="saddresscode" labelfield="sraddress_.description" extraprojectionvalues="description, staddrnumber, staddrstreet, staddrsttype, formattedaddress" >
                    <renderer type="lookup" />
                  </association>
                </section>
              </section>
              <section orientation="horizontal">
                <header displacement="ontop" label="Scheduling" params="fieldset=true" />

                <renderer type="default" params="childinputsize=large" />
                <field attribute="targetstart" label="Target Start Date">
                  <renderer type="datetime" params="format=MM/dd/yyyy"/>
                </field>
                <field attribute="targetfinish" label="Target Finish Date">
                  <renderer type="datetime" params="format=MM/dd/yyyy"/>
                </field>

                <field attribute="actualstart" label="Actual Start Date">
                  <renderer type="datetime" params="format=MM/dd/yyyy"/>
                </field>
                <field attribute="actualfinish" label="Actual Finish Date">
                  <renderer type="datetime" params="format=MM/dd/yyyy"/>
                </field>
              </section>

            </section>

            <section id="compositions"/>

          </section>

        </schema>

        <schema id="newdetail" parentschema="adetail" stereotype="detailnew" title="New Service Request" >
          <section id="ticketidsection">
            <field label="Status" attribute="status" readonly="true" default="NEW" hidden="true"/>
            <association label="Site" target="siteid" labelfield="site_.description" requiredexpression="true" extraprojectionvalues="orgid">
              <renderer type="lookup"/>
              <event type="afterchange" method="adjustOrgId" service="genericTicketService"/>
            </association>
          </section>

          <section id="attachmentsection">
            <field label="Attachment" attribute="newattachment" >
              <renderer type="upload"/>
            </field>
          </section>
        </schema>

        <schema id="editdetail" parentschema="adetail" title="Service Request Details">
          <section id="ticketidsection">
            <reference id="status"/>
            <field label="Site" attribute="siteid" readonly="true"/>
          </section>

          <section id="compositions">
            <reference id="worklogs"/>
            <reference id="commlogs"/>
            <reference id="attachments"/>
            <reference id="relatedrecords"/>

            <tab label="Location Address" id="saddress" icon="fa-map-o" showexpression="(@location_.serviceaddress_.latitudey &amp;&amp; @location_.serviceaddress_.longitudex) || @location_.serviceaddress_.streetaddress">
              <section id="saddresssection" resourcepath="/Content/Templates/otb/saddress.html" parameters="zoom=19;tabid=saddress">
              </section>
            </tab>
          </section>
          <event type="beforesubmit.prevalidation" service="genericTicketService" method="validateCloseStatus"/>
          <event type="beforesubmit.postvalidation" service="genericTicketService" method="handleStatusChange"/>
          <commandbars>
            <commandgroup position="actions">
              <!--              <container label="Actions" id="actioncontainer" icon="fa-bolt">-->
              <command id="dispatchwo" icon="fa-wrench" label="Create W.O."
                        parameters="schema,datamap" service="dispatchService" method="dispatchWO" cssclasses="large-button" enableexpression="$scope:enableSave"/>

              <!-- Incident is for smart cloud only, allowing them to dispatch incidents on all images is a violation for maximo images -->
              <command id="dispatchincident" icon="fa-warning" label="Create Incident" permissionexpression="@maximoVersionEvaluator.IsSCCD"
                        parameters="schema,datamap" service="dispatchService" method="dispatchIncident" cssclasses="large-button" enableexpression="$scope:enableSave"/>

              <command id="crud_delete" label="Delete" service="crudextraService" method="deletefn" parameters="schema,datamap"
                       showexpression="service:genericTicketService.isDeleteAllowed" successmessage="SR deleted" position="right" cssclasses="large-button" icon="fa-remove"/>

              <!-- Create new SR as Related Record -->
              <command id="createrelated"
                       service="srService" method="startRelatedSRCreation" parameters="schema,datamap"
                       label="Create Request" icon="fa-ticket" cssclasses="large-button" enableexpression="$scope:enableSave"/>
              <!--              </container>-->
            </commandgroup>
          </commandbars>
        </schema>
      </schemas>
    </application>

  </applications>
</metadata>
