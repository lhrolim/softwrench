<?xml version="1.0" encoding="utf-8" ?>
<metadata xmlns="http://www.controltechnologysolutions.com/metadata">
  <templates>
    <!--Location-->
    <template path="@lochierarchy.xml"/>
    <template path="@locationspec.xml"/>
    <template path="@assettrans.xml"/>
    <template path="@locationmeter.xml"/>
    <template path="@serviceaddress.xml"/>
  </templates>

  <entities>

    <entity name="locoper" idAttribute="locoperid">
      <attributes>
        <attribute name="location" type="varchar" required="true" />
        <attribute name="calnum" type="varchar" required="false" />
        <attribute name="locpriority" type="int" required="false" />
        <attribute name="itemnum" type="varchar" required="false" />
        <attribute name="failurecode" type="varchar" required="false" />
        <attribute name="classification" type="varchar" required="false" />
        <attribute name="flo1" type="varchar" required="false" />
        <attribute name="flo2" type="varchar" required="false" />
        <attribute name="flo3" type="varchar" required="false" />
        <attribute name="flo4" type="varchar" required="false" />
        <attribute name="flo5" type="varchar" required="false" />
        <attribute name="flo6" type="decimal" required="false" />
        <attribute name="flo7" type="datetime" required="false" />
        <attribute name="flo8" type="decimal" required="false" />
        <attribute name="flo9" type="varchar" required="false" />
        <attribute name="flo10" type="int" required="false" />
        <attribute name="warrantyexpdate" type="datetime" required="false" />
        <attribute name="siteid" type="varchar" required="true" />
        <attribute name="orgid" type="varchar" required="true" />
        <attribute name="itemsetid" type="varchar" required="false" />
        <attribute name="shiftnum" type="varchar" required="false" />
        <attribute name="groupname" type="varchar" required="false" />
        <attribute name="locoperid" type="bigint" required="true" />
        <attribute name="rowstamp" type="timestamp" required="true" />
      </attributes>
      <relationships>
        <relationship to="item">
          <relationshipAttribute from="itemnum" to="itemnum" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>
        <relationship to="metergroup">
          <relationshipAttribute from="groupname" to="groupname" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>
      </relationships>
      <connectorParameters>
        <connectorParameter key="dbtable" value="locoper" />
      </connectorParameters>
    </entity>

    <entity name="location" idAttribute="locationsid">
      <attributes>
        <attribute name="locationsid"  type="int" required="true" />
        <attribute name="location" type="varchar"  required="true" />
        <attribute name="description" type="varchar"  required="true" />
        <attribute name="siteid"  type="varchar" />
        <attribute name="orgid" type="varchar" />
        <attribute name="type"  type="varchar" />
        <attribute name="status"  type="varchar" />
        <attribute name="glaccount" type="varchar" />
        <attribute name="intlabrec" type="varchar" />
        <attribute name="classstructureid" type="int" />
        <attribute name="billtoaddresscode" type="varchar" required="false" />
        <attribute name="shiptoaddresscode" type="varchar" required="false" />
        <attribute name="serviceaddresscode" type="varchar" required="false" />
        <attribute name="workordercounter" type="int" query="(select count(*) from workorder where status not in ('CAN', 'CLOSE', 'COMP') and location = !@location and siteid = !@siteid)"/>
        <!--<attribute name="children" type="varchar" query="(select count(lochierarchy.parent) from lochierarchy where lochierarchy.parent = location.location and lochierarchy.systemid = parentlocation_.systemid)"/>-->
        <attribute name="assets" type="varchar" query="(select count(assetnum) from asset where asset.location = location.location and asset.orgid = location.orgid)"/>
      </attributes>
      <relationships>
        <relationship to="site">
          <relationshipAttribute from="siteid" to="siteid" primary="true" />
          <relationshipAttribute from="orgid" to="orgid" />
        </relationship>
        <relationship to="synonymdomain" qualifier="synstatus" cacheable="true">
          <relationshipAttribute from="status" to="value" primary="true"/>
          <relationshipAttribute to="domainid" literal="LOCASSETSTATUS" quoteLiteral="true" />
        </relationship>
        <relationship to="synonymdomain" qualifier="syntype" cacheable="true">
          <relationshipAttribute from="type" to="value" primary="true"/>
          <relationshipAttribute to="domainid" literal="LOCTYPE" quoteLiteral="true" />
        </relationship>
        <relationship to="asset" collection="true">
          <relationshipAttribute from="location" primary="true" query="asset.location = @from or asset.location in (select location from locancestor locan where locan.ancestor = @from)"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>
        <relationship to="serviceaddress">
          <relationshipAttribute from="saddresscode" to="addresscode" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>
        <relationship to="address" qualifier="shipto">
          <relationshipAttribute from="shiptoaddresscode" to="addresscode" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid" />
        </relationship>
        <relationship to="address" qualifier="billto">
          <relationshipAttribute from="billtoaddresscode" to="addresscode" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid" />
        </relationship>
        <relationship to="address" qualifier="serv">
          <relationshipAttribute from="serviceaddresscode" to="addresscode" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid" />
        </relationship>
        <relationship to="lochierarchy" qualifier="parentlocation" collection="true">
          <relationshipAttribute from="location" to="location" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>
        <relationship to="lochierarchy" qualifier="childlocation" collection="true">
          <relationshipAttribute from="location" to="parent" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>
        <relationship to="classstructure">
          <relationshipAttribute from="classstructureid" to="classstructureid" primary="true"/>
        </relationship>
        <relationship to="locoper">
          <relationshipAttribute from="location" to="location" primary="true"/>
          <relationshipAttribute from="siteid" to="siteid"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>
        <relationship to="asset" collection="true">
          <relationshipAttribute from="location" to="location" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>
        <relationship to="workorder" collection="true">
          <relationshipAttribute from="location" to="location" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>
        <relationship to="locationmeter" collection="true">
          <relationshipAttribute from="location" to="location" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>
        <relationship to="locationspec" collection="true">
          <relationshipAttribute from="location" to="location" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>
        <relationship to="assettrans" collection="true" ignoreprimary="true">
          <!--Required to have a relationshipAttribute on relationship declaration, real query build in prefilterfunction-->
          <relationshipAttribute query=""/>
        </relationship>
      </relationships>
      <connectorParameters>
        <connectorParameter key="dbtable" value="locations" />
      </connectorParameters>
    </entity>

  </entities>

  <applications>
    <application name="location" title="Location" entity="location" id="00000000-0000-0000-0000-000000000002">
      <properties>
        <property key="mobile.fetchlimit" value="3000"/>
        <property key="mobile.userInteractionEnabled" value="false"/>
        <property key="application.maindetailschema" value="locationdetail"/>
      </properties>

      <filters>
        <optionfilter attribute="status" provider="synstatus_.description" displaycode="true" />
        <optionfilter attribute="type" provider="syntype_.description" displaycode="true"/>
        <optionfilter attribute="parentlocation_.parent" provider="parentlocation_.parent" displaycode="true" allowblank="true" />
        <optionfilter attribute="parentlocation_.systemid" provider="parentlocation_.systemid" displaycode="true" allowblank="true" />
        <optionfilter attribute="siteid" provider="site_.siteid" />
        <optionfilter attribute="classstructure_.description" provider="classstructure_.description" whereclause="classstructure_.classstructureid in (!@#value)" allowblank="true"/>
        <!--<numericfilter attribute="children" label="Child Locations" position="children" />-->
        <numericfilter attribute="assets" label="Assets" position="assets" />
        <optionfilter attribute="locoper_.locpriority" displaycode="true">
          <option xmlns="http://www.controltechnologysolutions.com/filters" label="High" value="1" />
          <option xmlns="http://www.controltechnologysolutions.com/filters" label="Medium" value="2" />
          <option xmlns="http://www.controltechnologysolutions.com/filters" label="Low" value="3" />
        </optionfilter>
        <optionfilter attribute="statusicons" displaycode="true">
          <option xmlns="http://www.controltechnologysolutions.com/filters" label="Active Work Orders" value="workordercounter" />
        </optionfilter>
      </filters>

      <schemas>
        <schema id="locationlookup" title="Location List">
          <field attribute="location" label="Location" qualifier="title"/>
          <field attribute="description" label="Description" qualifier="excerpt"/>
        </schema>
        <detail>
          <field attribute="description" label="Description"  requiredexpression="true" >
            <renderer type="default" params="maxlength=100;inputsize=xlarge" />
          </field>
          <field attribute="locationsid" label="ID"  requiredexpression="true" />
          <field attribute="location" label="Location"  requiredexpression="true" />
          <field attribute="siteid"  requiredexpression="true" readonly="true" hidden="true"/>
          <field attribute="type"  requiredexpression="true" readonly="true" hidden="true"/>
        </detail>
        <list platform="web">
          <properties>
            <property key="list.click.schema" value="locationdetail"/>
            <property key="list.click.customparams" value="parentlocation_.systemid"/>
            <property key="list.search.compositionstoexclude" value="assettrans"/>
            <property key="list.width.min" value="1280px"/>
          </properties>
          <field attribute="location" label="Location" readonly="true"/>
          <field attribute="description" label="Description"/>
          <field attribute="classstructure_.description" label="Class Structure"/>
          <field attribute="parentlocation_.parent" label="Parent Location"/>
          <field attribute="parentlocation_.systemid" label="System"/>
          <!--<field attribute="children" label="Child Locations"/>-->
          <field attribute="assets" label="Assets"/>
          <field attribute="type" label="Type"/>
          <field attribute="status" label="Status"/>
          <field attribute="siteid" label="Site"/>
          <field attribute="orgid" hidden="true"/>
          <field attribute="locoper_.locpriority" tooltip="Priority">
            <renderer type="priorityicon" params="width=5%;icon=fa-flag;headericon=true;changevalue=true;onclick=priorityService.setPriority"/>
          </field>
          <field attribute="workordercounter" tooltip="Active Work Orders" hidden="true">
            <renderer type="icon" params="icon=fa-wrench;autoloadcomposition=workorder_"/>
          </field>
          <field attribute="statusicons" tooltip="Status Icons">
            <renderer type="statusicons" params="width=9%;iconcolumns=workordercounter;icon=fa-tachometer;headericon=true;showsort=false"/>
          </field>
          <!--Child Locations-->
          <!--Open Work Orders-->
        </list>

        <list platform="mobile">
          <field attribute="location" label="Location" readonly="true"/>
          <field attribute="description" label="Description"/>
          <field attribute="classstructure_.description" label="Class Structure"/>
          <field attribute="assets" label="Assets"/>
          <field attribute="type" label="Type"/>
          <field attribute="status" label="Status"/>
          <field attribute="siteid" label="Site"/>
          <field attribute="orgid" hidden="true"/>
          <!-- TODO: support for field exclusion based on platform -->
          <!--<field attribute="parentlocation_.parent" label="Parent Location"/>-->
          <!--<field attribute="parentlocation_.systemid" label="System"/>-->
          <!--<field attribute="children" label="Child Locations"/>-->
        </list>

        <schema id="locationdetail" title="Location Detail" stereotype="detail">
          <properties>
            <property key="detail.crawl.customparams" value="parentlocation_.systemid"/>
          </properties>
          <field attribute="orgid" showexpression="false"/>

          <section orientation="horizontal">
            <renderer type="default" params="childinputsize=large" />
            <field attribute="location" label="Location:" readonly="true" hidden="true"/>
            <field attribute="description" label="Description:" readonly="true">
              <renderer type="default" params="maxlength=100;inputsize=xlarge" />
            </field>
            <field attribute="status" label="Status" readonly="true"/>
            <field attribute="siteid" label="Site" readonly="true"/>            
          </section>

          <section orientation="horizontal">
            <header displacement="ontop" label="Location Information" params="fieldset=true" />
            <renderer type="default" params="childinputsize=medium" />
            <field attribute="type" label="Type:" readonly="true"/>

            <optionfield attribute="locoper_.locpriority" label="Priority" providerattribute="_SWPriorityType" readonly="true">
              <renderer type="lookup"/>
            </optionfield>

            <field attribute="locoper_.failurecode" label="Failure Code:" readonly="true"/>
            <field attribute="locoper_.itemnum" label="Rotating Item:" readonly="true"/>
            <field attribute="locoper_.groupname" label="Meter Group:" readonly="true"/>
            <field attribute="locoper_.calnum" label="Calendar:" readonly="true"/>
            <field attribute="locoper_.shiftnum" label="Shift:" readonly="true"/>
            <field attribute="glaccount" label="GL Account:" readonly="true"/>
            <field attribute="intlabrec" label="Internal Labor Account" readonly="true"/>
          </section>

          <section id="systems" orientation="horizontal">
            <!-- need to add some type of selectable association for systems -->
          </section>

          <composition relationship="parentlocation" label="Parent" detailschema="" inline="true">
            <collectionproperties listschema="locationparentlist" allowcreation="false" prefilterfunction="FilterLocationHierarchy"/>
          </composition>
          <composition relationship="childlocation" label="Children" detailschema="" inline="true">
            <collectionproperties listschema="locationchildlist" allowcreation="false" prefilterfunction="FilterLocationHierarchy"/>
          </composition>
          <composition relationship="asset" label="Assets" detailschema="" rendermode="output">
            <collectionproperties listschema="locationassets" allowcreation="false" allowupdate="false" allowremoval="false"/>
          </composition>
          <composition relationship="workorder" label="Work Order History" detailschema="" rendermode="output">
            <collectionproperties listschema="locationwolist" allowcreation="false" allowupdate="false" allowremoval="false"/>
          </composition>
          <composition relationship="assettrans" label="History" detailschema="" rendermode="output">
            <collectionproperties listschema="compositionlist" allowcreation="false" allowupdate="false" allowremoval="false" prefilterfunction="BuildAssettransWhereClause"/>
          </composition>
          <composition relationship="locationmeter" label="Meters" detailschema="locationdetail" rendermode="output">
            <collectionproperties listschema="locationcomposition" allowcreation="false" allowupdate="false" allowremoval="false" orderbyfield="sequence"/>
          </composition>
          <composition relationship="locationspec" label="Specifications" detailschema="compositiondetail" rendermode="output">
            <collectionproperties listschema="compositionlist"  allowcreation="false" allowupdate="false" allowremoval="false"/>
          </composition>
          <commandbars>
            <commandgroup position="actions">
              <!--              <container label="Actions" id="actioncontainer" icon="fa-bolt">-->
              <command id="dispatchwo" icon="fa-wrench" label="Create W.O."
                        parameters="schema,datamap" service="locationService" method="dispatchWO" cssclasses="large-button"/>
              <!--              </container>-->
            </commandgroup>
            <commandgroup position="detail.primary">
              <removecommand id="save"/>
            </commandgroup>
          </commandbars>
        </schema>
      </schemas>
    </application>
  </applications>




</metadata>
