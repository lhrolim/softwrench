<?xml version="1.0" encoding="utf-8" ?>
<metadata xmlns="http://www.controltechnologysolutions.com/metadata">

  <templates>
    <template path="@attachments.xml"/>
  </templates>
  
  <entities>

    <entity name="COMMTEMPLATE" idAttribute="commtemplateid">
      <attributes>
        <attribute name="templateid" type="varchar" required="true" />
        <attribute name="description" type="varchar" required="false" />
        <attribute name="sendfrom" type="varchar" required="true" />
        <attribute name="subject" type="varchar" required="false" />
        <attribute name="replyto" type="varchar" required="false" />
        <attribute name="createby" type="varchar" required="true" />
        <attribute name="createdate" type="datetime" required="true" />
        <attribute name="objectname" type="varchar" required="true" />
        <attribute name="commtemplateid" type="bigint" required="true" />
        <attribute name="status" type="varchar" required="false" />
        <attribute name="statusdate" type="datetime" required="false" />
        <attribute name="usewith" type="varchar" required="true" />
        <attribute name="langcode" type="varchar" required="true" />
        <attribute name="message" type="text" required="false" />
        <attribute name="freeform" type="smallint" required="true" />
        <attribute name="hasld" type="smallint" required="true" />
        <attribute name="sendersysid" type="varchar" required="false" />
        <attribute name="logflag" type="smallint" required="true" />
        <attribute name="rowstamp" type="timestamp" required="true" />
        <attribute name="trackfailedmessages" type="smallint" required="true" />
      </attributes>
      <connectorParameters>
        <connectorParameter key="dbtable" value="COMMTEMPLATE" />
      </connectorParameters>
    </entity>
    
    <entity name="commlog" idAttribute="commloguid">
      <attributes>
        <attribute name="commlogid" type="int" required="true"/>
        <attribute name="sendto" type="text" required="false" />
        <attribute name="sendfrom" type="varchar" required="true" />
        <attribute name="subject" type="varchar" required="false" />
        <attribute name="createby" type="varchar" required="true" />
        <attribute name="createdate" type="datetime" required="true" />
        <attribute name="ownerid" type="int" required="true" />
        <attribute name="ownertable" type="varchar" required="true" />
        <attribute name="cc" type="text" required="false" />
        <attribute name="bcc" type="text" required="false" />
        <attribute name="replyto" type="varchar" required="false" />
        <attribute name="inbound" type="smallint" required="true" />
        <attribute name="commloguid" type="bigint" required="true" />
        <attribute name="message" type="text" required="false" />
        <attribute name="orgobject" type="varchar" required="false" />
        <attribute name="uniqueid" type="int" required="false" />
        <attribute name="rowstamp" type="timestamp" required="true" />
        <attribute name="issendfail" type="smallint" required="true" />
        <attribute name="keepfailed" type="smallint" required="true" />
        <attribute name="summary_message" type="text" query="@baseCommlogDataset.GetSummary" />
        <attribute name="ccflag" query="CASE WHEN !@cc is not null THEN 'true' ELSE 'false' end " type="bool"/>
        <attribute name="bccflag" query="CASE WHEN !@bcc is not null THEN 'true' ELSE 'false' end " type="bool"/>
      </attributes>
      <relationships>
        <relationship to ="email">
          <!--this to attribute is used for the autocompleteserver, do not remove it -->
          <relationshipAttribute query="commlog.sendto like email_.emailaddress" primary="true" to="emailaddress"/>
        </relationship>
        <relationship to="commlogdocs" >
          <relationshipAttribute from="commlogid" to="commlogid" primary="true"/>
        </relationship>
        <relationship to="sr">
          <relationshipAttribute from="ownerid" to="ticketuid" primary="true"/>
        </relationship>
        <relationship to="commtemplate" ignoreprimary="true">
          <relationshipAttribute from="ownertable" to="objectname"/>
          <relationshipAttribute to="status" literal="ACTIVE" quoteLiteral="true"/>
        </relationship>
      </relationships>
      <connectorParameters>
        <connectorParameter key="dbtable" value="commlog" />
      </connectorParameters>
    </entity>

    <entity name="commlogdocs" idAttribute="commlogdocsid">
      <attributes>
        <attribute name="commlogid" type="int" required="true" />
        <attribute name="commlogdocsid" type="bigint" required="true" />
        <attribute name="docinfoid" type="bigint" required="false" />
        <attribute name="urlname" type="varchar" required="false" />
        <attribute name="rowstamp" type="timestamp" required="true" />
      </attributes>
      <connectorParameters>
        <connectorParameter key="dbtable" value="commlogdocs" />
      </connectorParameters>
    </entity>
  </entities>

  <applications>
    <application entity="commlog" name="commlog" title="Communications">
      <properties>
        <property key ="icon" value="fa fa-envelope-o"/>
        <property key ="icon.composition.tab" value="fa fa-envelope-o"/>
        <property key="list.click.popup" value="modal"/>
        <property key ="add.button.label" value="Add Communication"/>
      </properties>
      <schemas>
        <schema id="list" stereotype="compositionlist">
          <commandbars>
            <commandgroup position="compositiontop" platform="web" removeundeclared="false">
              <command id="additem"
                       icon="fa fa-envelope-o"
                       label="Add Communication"
                       service="commlogService"
                       method="addCommlog"
                       parameters="schema"
                       cssclasses="btn-primary"/>
            </commandgroup>
          </commandbars>
          <properties>
            <property key="expansible" value="false"/>
            <property key="masterdetail" value="true"/>
            <property key="list.search.quicksearchfields" value="sendto,sendfrom,subject"/>
          </properties>
          <field attribute="read">
            <renderer type="icon" params="expression={'#default':'fa-circle','true':''}"/>
          </field>
          <field attribute="inbound">
            <renderer type="icon" params="expression={'1':'fa-long-arrow-right green','0':'fa-long-arrow-left orange'}"/>
          </field>
          <field attribute="createdate" label="Created Date" qualifier="tag">
            <renderer type="datetime" />
          </field>
          <field attribute="sendto" label="To" qualifier="expression={'!@inbound':'title'}">
            <renderer type="default" params="formatter=lower"/>
          </field>
          <field attribute="sendfrom" label="From" qualifier="expression={'@inbound':'title'}">
            <renderer type="default" params="formatter=lower"/>
          </field>
          <field attribute="subject" label="Subject" qualifier="subtitle">
            <renderer type="default"/>
          </field>
          <field attribute="summary_message" label="Message" qualifier="message">
            <renderer type="default"/>
          </field>          
        </schema>

        <schema id="detail" stereotype="compositiondetail" title="Communication Details">
          <event type="onschemafullyloaded" service="commlogService" method="addSignature"/>
          <field attribute="commlogid" hidden="true" />
          <field attribute="ownertable" defaultexpression="$.parentdata['class']" hidden="true"/>
          <association target="#templateid" label="Template" labelfield="commtemplate_.description" valuefield="templateid" showexpression="!@commlogid">
            <renderer type="lookup"/>
            <event type="afterchange" service="commlogService" method="formatCommTemplate"/>
          </association>
          <!--<field attribute="createdate" label="Created Date" readonly="true">
            <renderer type="datetime" params="format=MM/dd/yyyy HH:mm:ss"/>
          </field>-->

          <section orientation="horizontal">
            <renderer type="default" params="childinputsize=large" />
            <field attribute="orgobject" label="Origination" hidden="true"/>
            <association label="To" target="sendto" labelfield="email_.emailaddress" valuefield="emailaddress" orderbyfield="LOWER(emailaddress) desc" requiredexpression="true" >
              <renderer type="multiselectautocompleteclient" stereotype="email" params="valtype=email;valmessage=invalid email format;" />
              <dataprovider postfilterfunction="EmailPostFilter"/>
            </association>
            <field attribute="sendfrom" label="From" requiredexpression="true" default="@user.email" readonly="true" >
              <renderer type="email"/>
            </field>
          </section>

          <section orientation="horizontal">
            <renderer type="default" params="childinputsize=large" />
            <association label="CC" target="cc" labelfield="email_.emailaddress" orderbyfield="LOWER(emailaddress) desc">
              <renderer type="multiselectautocompleteclient" stereotype="email" params="valtype=email;valmessage=invalid email format;" />
              <dataprovider postfilterfunction="EmailPostFilter"/>
            </association>
            <association label="BCC" target="bcc" labelfield="2email_.emailaddress" orderbyfield="LOWER(emailaddress) desc">
              <renderer type="multiselectautocompleteclient" stereotype="email" params="valtype=email;valmessage=invalid email format;" />
              <dataprovider postfilterfunction="EmailPostFilter"/>
            </association>
          </section>
          
          <field attribute="subject" label="Subject" requiredexpression="true"/>
          <field attribute="message" label="Message">
            <renderer type="richtext"/>
          </field>
          
          <field label="Attachment" attribute="attachment" showexpression="!@commlogid">
            <renderer type="multipleupload"/>
          </field>
          
          <field label="Attachments" attribute="attachments" showexpression="!!@attachments &amp;&amp; @attachments.length > 0">
            <renderer type="link" params="linkUrlField=url;linkNameField=name"/>
          </field>

          <optionfield attribute="extraattachments" label="Featured Attachments" default="" showexpression="!@commlogid" >
            <option label="Details" value="details"/>
          </optionfield>

          <commandbars>
            <commandgroup position="modal.detail.primary" removeundeclared="false">
              <command id="save" icon="fa-check" service="commlogService" method="send" parameters="datamap,schema" label="Send" primary="true"/>
            </commandgroup>
          </commandbars>

          <properties>
            <property key="schema.whereclause.related" value="commtemplate"/>
          </properties>
          
        </schema>
      </schemas>
    </application>
  </applications>
</metadata>
