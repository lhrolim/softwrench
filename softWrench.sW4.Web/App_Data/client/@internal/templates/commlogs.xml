<?xml version="1.0" encoding="utf-8" ?>
<metadata xmlns="http://www.controltechnologysolutions.com/metadata">

  <templates>
    <template path="@attachments.xml"/>
  </templates>
  
  <entities>
    <entity name="commlog" idAttribute="commloguid">
      <attributes>
        <attribute name="commlogid" type="int" required="true"/>
        <attribute name="sendto" type="varchar" required="false" />
        <attribute name="sendfrom" type="varchar" required="true" />
        <attribute name="subject" type="varchar" required="false" />
        <attribute name="createby" type="varchar" required="true" />
        <attribute name="createdate" type="datetime" required="true" />
        <attribute name="ownerid" type="int" required="true" />
        <attribute name="ownertable" type="varchar" required="true" />
        <attribute name="cc" type="text" required="false" />
        <attribute name="bcc" type="text" required="false" />
        <attribute name="replyto" type="varchar" required="false" />
        <attribute name="inbound" type="smallint" required="true" />
        <attribute name="commloguid" type="bigint" required="true" />
        <attribute name="message" type="text" required="false" />
        <attribute name="orgobject" type="varchar" required="false" />
        <attribute name="uniqueid" type="int" required="false" />
        <attribute name="rowstamp" type="timestamp" required="true" />
        <attribute name="issendfail" type="smallint" required="true" />
        <attribute name="keepfailed" type="smallint" required="true" />
        <attribute name="ccflag" query="CASE WHEN !@cc is not null THEN 'true' ELSE 'false' end " type="bool"/>
        <attribute name="bccflag" query="CASE WHEN !@bcc is not null THEN 'true' ELSE 'false' end " type="bool"/>
      </attributes>
      <relationships>
        <relationship to ="email">
          <!--this to attribute is used for the autocompleteserver, do not remove it -->
          <relationshipAttribute query="commlog.sendto like email_.emailaddress" primary="true" to="emailaddress"/>
        </relationship>
        <relationship to="commlogdocs" >
          <relationshipAttribute from="commlogid" to="commlogid" primary="true"/>
        </relationship>
        <relationship to="sr">
          <relationshipAttribute from="ownerid" to="ticketuid" primary="true"/>
        </relationship>
        <relationship to="commtemplate" ignoreprimary="true">
          <relationshipAttribute from="ownertable" to="objectname"/>
          <relationshipAttribute to="status" literal="ACTIVE" quoteLiteral="true"/>
        </relationship>
      </relationships>
      <connectorParameters>
        <connectorParameter key="dbtable" value="commlog" />
      </connectorParameters>
    </entity>

    <entity name="commlogdocs" idAttribute="commlogdocsid">
      <attributes>
        <attribute name="commlogid" type="int" required="true" />
        <attribute name="commlogdocsid" type="bigint" required="true" />
        <attribute name="docinfoid" type="bigint" required="false" />
        <attribute name="urlname" type="varchar" required="false" />
        <attribute name="rowstamp" type="timestamp" required="true" />
      </attributes>
      <connectorParameters>
        <connectorParameter key="dbtable" value="commlogdocs" />
      </connectorParameters>
    </entity>
  </entities>

  <applications>
    <application entity="commlog" name="commlog" title="Communications">
      <properties>
        <property key ="icon" value="fa fa-envelope-o"/>
        <property key ="icon.composition.tab" value="fa fa-envelope-o"/>
      </properties>
      <schemas>
        <schema id="list" stereotype="compositionlist">
          <properties>
            <property key="expansible" value="false"/>
            <property key="masterdetail" value="true"/>
          </properties>
          <field attribute="read">
            <renderer type="icon" params="expression={'#default':'fa-circle','true':''}"/>
          </field>
          <field attribute="inbound">
            <renderer type="icon" params="expression={'1':'fa-long-arrow-right green','0':'fa-long-arrow-left orange'}"/>
          </field>
          <field attribute="createdate" label="Created Date/Time" qualifier="date">
            <renderer type="datetime" params="format=MM/dd/yyyy"/>
          </field>
          <field attribute="sendto" label="To" qualifier="personTo">
            <renderer type="default" params="formatter=lower"/>
          </field>
          <field attribute="sendfrom" label="From" qualifier="personFrom">
            <renderer type="default" params="formatter=lower"/>
          </field>
          <field attribute="subject" label="Subject" qualifier="title">
            <renderer type="default"/>
          </field>
          <field attribute="message" label="Message" qualifier="message">
            <renderer type="default"/>
          </field>          
        </schema>

        <schema id="detail" stereotype="compositiondetail">
          <event type="onload" service="commlogService" method="addSignature"/>
          <field attribute="commlogid" hidden="true" />
          <field attribute="ownertable" defaultexpression="$.parentdata.fields['class']" hidden="true"/>
          <association target="#templateid" label="Template" labelfield="commtemplate_.description" valuefield="templateid" >
            <renderer type="lookup"/>
            <event type="afterchange" service="commlogService" method="formatCommTemplate"/>
          </association>
          <field attribute="createdate" label="Created Date/Time" readonly="true">
            <renderer type="datetime" params="format=MM/dd/yyyy HH:mm"/>
          </field>
          <field attribute="orgobject" label="Origination" hidden="true"/>
          <!--<field attribute="sendto" label="To" requiredexpression="true">
            <renderer type="email"/>
          </field>-->
          <association label="To" target="sendto" labelfield="email_.loweremail" valuefield="loweremail" orderbyfield="LOWER(emailaddress) desc" requiredexpression="true" >
            <renderer type="multiselectautocompleteclient" stereotype="email"/>
            <dataprovider postfilterfunction="EmailPostFilter"/>
          </association>
          <association label="CC" target="cc" labelfield="email_.emailaddress" orderbyfield="LOWER(emailaddress) desc">
            <renderer type="multiselectautocompleteclient" stereotype="email"/>
            <dataprovider postfilterfunction="EmailPostFilter"/>
          </association>
          <association label="BCC" target="bcc" labelfield="2email_.emailaddress" orderbyfield="LOWER(emailaddress) desc">
            <renderer type="multiselectautocompleteclient" stereotype="email"/>
            <dataprovider postfilterfunction="EmailPostFilter"/>
          </association>

          <field attribute="sendfrom" label="From" requiredexpression="true" default="@user.email" readonly="true" >
            <renderer type="email"/>
          </field>
          <field attribute="subject" label="Subject" requiredexpression="true"/>
          <field attribute="message" label="Message">
            <renderer type="richtext"/>
          </field>
          <field label="Attachment" attribute="attachment" >
            <renderer type="multipleupload"/>
          </field>

          <commandbars>
            <commandgroup position="detailform" removeundeclared="false">
              <command id="save" icon="fa-check" service="$scope" method="save" label="Send" />
            </commandgroup>
          </commandbars>
          
        </schema>
      </schemas>
    </application>
  </applications>


</metadata>
