<div>

    <div style="background: none; border-bottom: none" ng-show="!inline && ismodal=='false'">

        <compositiontoolbar position="compositiontop"
                            schema="compositionlistschema"
                            parentschema="parentschema"
                            datamap="compositiondata"
                            parentdatamap="parentdata"
                            pagination-data="paginationData"
                            search-data="searchData"
                            search-sort="searchSort"
                            search-operator="searchOperator"
                            mode="{{mode}}"
                            class="compositiontoolbar" />
    </div>

    <!--build responsive css rules based on metadata-->
    <style column-widths schema="compositionlistschema"></style>

    <table class="table" ng-class="showTableHover() ? 'table-hover' : 'no-hover'" data-application="{{compositionlistschema.applicationName}}" data-schema="{{compositionlistschema.schemaId}}" id="compositionlistgrid">
        <thead>
            <tr class="hapag-table-header">
                <th ng-if="hasDetailSchema()">
                    <!--batchMode-->
                </th>

                <th ng-if="compositionlistschema.properties['list.selectionstyle'] == 'multiple'">
                    <!--Multiselect-->
                </th>
                <th ng-if="compositionlistschema.properties['list.selectionstyle'] == 'single'">
                    <!--Singleselect-->
                </th>
                <th class="{{safeCSSselector(column.attribute)}}"
                    ng-repeat="column in compositionlistschema.displayables"
                    ng-show="!isCompositionItemFieldHidden(compositionlistschema,column,null)">
                    <span ng-show="isFieldRequired(column,column.requiredExpression)" class="requiredfieldmark">* </span>
                    <span class="add-on">{{i18NLabel(column)}}</span>
                </th>
                <th ng-if="isBatch()">
                    <button ng-if="collectionproperties.allowInsertion == 'true'" class="fa fa-plus btn btn-primary" ng-click="addBatchItem()"></button>
                </th>
            </tr>

        </thead>
        <tbody ng-show="compositionData().length > 0">
            <tr ng-repeat-start="(rowindex, compositionitem) in compositionData()"
                ng-show="!isRowHidden(compositionlistschema, collectionproperties, compositionitem)"
                ng-class="$odd ? 'odd' : 'even'"
                draggable="{{ draggableValue() }}"
                composition-list-key="{{getCompositionListKey()}}"
                composition-list-index="{{rowindex}}">
                <td ng-if="hasDetailSchema()">
                    <button class="btn" ng-click="toggleDetails(compositionitem,column,'arrow',$event,rowindex)" ng-show="expansionAllowed(compositionitem)">
                        <i class="fa fa-caret-right" ng-hide="isItemExpanded(compositionitem)"></i>
                        <i class="fa fa-caret-down" ng-show="isItemExpanded(compositionitem)"></i>
                    </button>
                </td>

                <td ng-if="compositionlistschema.properties['list.selectionstyle'] == 'multiple'" style="text-align: center;">
                    <!--Multiselect-->
                    <!-- TODO: Move style to css -->
                    <input type="checkbox"
                           ng-model="compositionitem['_#selected']"
                           ng-true-value="true" ng-false-value="false">
                </td>
                <td ng-if="compositionlistschema.properties['list.selectionstyle'] == 'single'">
                    <input type="radio" ng-model="compositionitem['#selected']" value="true" name="radio" ng-click="toggleDetails(compositionitem,column,'singleselection',$event,rowindex)">
                </td>
                <td class="{{safeCSSselector(column.attribute)}}"
                    ng-repeat="column in compositionlistschema.displayables"
                    ng-show="!isCompositionItemFieldHidden(compositionlistschema,column,compositionitem)"
                    ng-click="toggleDetails(compositionitem,column,'row',$event,rowindex)"
                    data-title="{{column.label}}">
                    <ng-switch on="column.type">

                        <div ng-switch-when="ApplicationAssociationDefinition">
                            <ng-switch on="column.rendererType">
                                <div ng-switch-when="lookup" class="row">
                                    <lookup-input parentdata="parentdata"
                                                  datamap="compositionitem" field-metadata="column" schema="compositionlistschema"
                                                  disabledassociations="disabledassociations" blockedassociations="blockedassociations"
                                                  mode="composition"
                                                  displayablepath="{{getApplicationPah(compositionitem,column)}}"/>
                                </div>
                                <div ng-switch-when="autocompleteclient" class="row">
                                    <autocomplete-client-input parentdata="parentdata"
                                                  datamap="compositionitem" field-metadata="column" schema="compositionlistschema"
                                                  disabledassociations="disabledassociations" blockedassociations="blockedassociations"
                                                  mode="composition"
                                                  displayablepath="{{getApplicationPah(compositionitem,column)}}"/>
                                </div>
                            </ng-switch>
                        </div>

                        <div ng-switch-when="OptionField">
                            <div ng-class="{'input-group': column.rendererParameters['prepend'] || column.rendererParameters['append'] }">
                                <span class="input-group-addon" ng-if="column.rendererParameters['prepend']!=null">{{column.rendererParameters['prepend']}}</span>
                                <select class="hidden-phone form-control combobox"
                                        ng-model="compositionitem[column.target]"
                                        number-to-string
                                        ng-options="option.value as i18NOptionField(option,column,compositionlistschema) for option in GetAssociationOptions(column)"
                                        data-field="{{fieldMetadata.associationKey}}">
                                    <option value="" ng-if="false"></option>
                                </select>
                                <span class="input-group-addon" ng-if="fieldMetadata.rendererParameters['append']!=null">{{fieldMetadata.rendererParameters['append']}}</span>
                            </div>
                        </div>

                        <div ng-switch-when="ApplicationSection">
                            <div ng-include="contextPath(column.resourcepath)" href="#" style="width: 100%" />
                        </div>
                        <div ng-switch-when="ApplicationFieldDefinition">
                            <ng-switch on="column.rendererType">
                                <div ng-switch-when="checkbox" style="text-align: center;">
                                    <i class="fa {{getBooleanClass(compositionitem,column.attribute)}}" ng-if="column.rendererParameters['editable'] != 'true'"/>
                                    <input type="checkbox" ng-if="column.rendererParameters['editable'] == 'true'" ng-model="compositionitem[column.attribute]"
                                           ng-checked="compositionitem[column.attribute] == 1"
                                           ng-enabled="isModifiableEnabled(column,compositionitem)"
                                           ng-click="invokeCustomCheckBoxService(column,compositionitem,$event)"
                                           ng-true-value="'true'" ng-false-value="'false'"/>
                                </div>

                                <div ng-switch-when="numericinput">
                                    <input id="spinner"
                                           class="hidden-phone form-control"
                                           ng-model="compositionitem[column.attribute]"
                                           ng-init="initField(column,compositionitem)"
                                           min="{{column.rendererParameters['min']}}"
                                           max="{{setMaxNumericInput(compositionitem,column)}}"
                                           ng-enabled="isModifiableEnabled(column,compositionitem)"
                                           data-field="{{column.attribute+rowindex}}"
                                           number-spinner/>
                                </div>
                                <div ng-switch-when="icon">
                                    <i class="fa" ng-class="loadIcon(compositionitem[column.attribute],column)"></i>
                                    <span ng-if="column.rendererParameters['showattribute'] == 'true'">
                                        {{getFormattedValue(compositionitem[column.attribute],column,compositionData())}}
                                    </span>
                                </div>
                                <div ng-switch-when="datetime">
                                    <div id="datetimepicker" class="input-group" data-datepicker="true" ng-if="column.rendererParameters['editable'] == 'true'">
                                        <input type="text" ng-model="compositionitem[column.attribute]"
                                               data-date-time
                                               data-show-time="{{column.rendererParameters['showtime']}}"
                                               data-show-date="{{column.rendererParameters['showdate']}}"
                                               data-date-format="{{column.rendererParameters['format']}}"
                                               data-show-meridian="{{column.rendererParameters['showmeridian']}}"
                                               data-allow-past="{{column.rendererParameters['allowpast']}}"
                                               data-allow-future="{{column.rendererParameters['allowfuture']}}"
                                               class="form-control">
                                        <span class="input-group-addon" data-calendericon="true" rel="tooltip" data-original-title="{{i18N('calendar.date_tooltip','Open the calendar popup')}}" style="cursor: pointer;">
                                            <i class="datetime-class"></i>
                                        </span>
                                    </div>
                                    <a ng-if="column.rendererParameters['editable'] != 'true'">
                                        {{getFormattedValue(compositionitem[column.attribute],column,compositionData())}}
                                    </a>

                                </div>
                                <div ng-switch-default>
                                    <div ng-if="column.rendererParameters['editable'] == 'true'"
                                         ng-class="{'input-group': column.rendererParameters['prepend'] || column.rendererParameters['append'] }">
                                        <span class="input-group-addon" ng-if="column.rendererParameters['prepend']!=null">{{column.rendererParameters['prepend']}}</span>
                                        <input type="{{getInputType(column)}}"
                                               ng-model="compositionitem[column.attribute]" class="hidden-phone form-control"
                                               data-ng-maxlength="{{column.rendererParameters['maxlength']}}"
                                               maxlength="{{column.rendererParameters['maxlength']}}"
                                               placeholder="{{column.rendererParameters['placeholder']}}"
                                               ng-init="initField(column)"
                                               dynamic-name="column.attribute"/>
                                        <span class="input-group-addon" ng-if="column.rendererParameters['append']!=null">{{column.rendererParameters['append']}}</span>
                                    </div>

                                    <a ng-if="column.rendererParameters['editable'] != 'true'" style="vertical-align: middle">
                                        {{getFormattedValue(compositionitem[column.attribute],column,compositionData())}}
                                    </a>
                                </div>
                            </ng-switch>
                        </div>


                    </ng-switch>
                </td>
                <td ng-if="isBatch()" ng-hide="compositionitem[compositionlistschema.idFieldName] > 0">
                    <button class="fa fa-trash btn" ng-click="removeBatchItem(rowindex)"></button>
                </td>
            </tr>
            <tr ng-repeat-end ng-if="detailData[compositionitem[compositionlistschema.idFieldName]].expanded">
                <td colspan="100%" style="background-color: white" class="detaildata">
                    <div class="expanded-item-composition" ng-if="noupdateallowed">
                        <expanded-item-output displayables="compositiondetailschema.displayables"
                                              schema="compositiondetailschema"
                                              datamap="detailData[compositionitem[compositionlistschema.idFieldName]].data"
                                              cancelfn="cancelComposition()"
                                              class="clearfix">
                        </expanded-item-output>
                    </div>
                    <div class="expanded-item-composition" ng-if="!noupdateallowed">
                        <expanded-item-input displayables="compositiondetailschema.displayables"
                                             schema="compositiondetailschema"
                                             datamap="detailData[compositionitem[compositionlistschema.idFieldName]].data"
                                             cancelfn="cancelComposition()"
                                             savefn="save()"
                                             class="clearfix">
                        </expanded-item-input>
                    </div>
                </td>
            </tr>
        </tbody>
        <tbody ng-show="isNoRecords()">
            <tr>
                <td colspan="100%">
                    <p class="no-results">
                        <i class="fa fa-info-circle"></i>&ensp;{{i18N('general.norecords','No records to display.')}}
                    </p>
                </td>
            </tr>
        </tbody>
    </table>

    <div class="context clearfix" ng-if="showPagination()">
        <pagination pagination-data="paginationData" renderfn="selectPage(pageNumber, pageSize, printMode)" />
    </div>

    <div ng-if="showListCommands()" class="form-actions form-group" data-class="commandbar" ng-if="shouldShowAdd()">
        <div class="col-lg-12 hapag-align-button" style="padding-top: 5px">
            <!--This button will only be show at this position in case of an inline composition.
            Otherwise, it shoul join the default command bar-->
            <button type="button" id="additem" class="btn commandButton" ng-click="newDetailFn()" ng-show="allowButton(collectionproperties.allowInsertion)">
                <i class="fa fa-plus {{list.schema.icon}}"></i>&ensp;{{i18N(relationship + '.add','Add ' + title)}}
            </button>

        </div>
    </div>
    <div ng-if="newDetail" style="margin-top: 10px">
        <form name="compositionform">
            <div ng-init="setForm(compositionform)"></div>
            <new-item-input displayables="compositiondetailschema.displayables"
                            elementid="inputComposition"
                            schema="compositiondetailschema"
                            datamap="selecteditem"
                            cancelfn="cancelComposition()"
                            savefn="save()"
                            previousdata="parentdata"
                            previousschema="parentschema"
                            parentdata="parentdata"
                            parentschema="parentschema" />
        </form>
    </div>
</div>
