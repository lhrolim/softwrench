<?xml version="1.0" encoding="utf-8" ?>
<metadata xmlns="http://www.controltechnologysolutions.com/metadata">
  <templates>
    <template path="@person.xml"/>
    <!--ServiceRequest-->
    <template path="@servicerequest.xml"/>

    <template path="@quickservicerequest.xml"/>

    <!--WorkOrder-->
    <template path="@inventory.xml"/>
    <template path="@workorder.xml"/>

    <template path="@tooltrans.xml"/>
    <template path="@materials.xml"/>
    <template path="@labtrans.xml"/>
    <template path="@woactivity.xml"/>
  </templates>

  <entities>
    <entity name="ALNDOMAIN" idAttribute="domainid">
      <attributes>
        <attribute name="domainid" type="varchar" required="true" />
        <attribute name="value" type="varchar" required="true" />
        <attribute name="description" type="varchar" required="false" />
        <attribute name="siteid" type="varchar" required="false" />
        <attribute name="orgid" type="varchar" required="false" />
        <attribute name="alndomainid" type="bigint" required="true" />
        <attribute name="valueid" type="varchar" required="true" />
        <attribute name="rowstamp" type="timestamp" required="true" />
      </attributes>
      <connectorParameters>
        <connectorParameter key="dbtable" value="ALNDOMAIN" />
      </connectorParameters>
    </entity>

    <entity name="workorder" idAttribute="wonum">
      <relationships>
        <relationship to="ALNDOMAIN" qualifier="division">
          <relationshipAttribute from="division" to="value" primary="true"/>
          <relationshipAttribute to="domainid" literal="DIVISION" quoteLiteral="true" />
        </relationship>
        <relationship to="worklog" collection="true">
          <relationshipAttribute from="wonum" to="recordkey" primary="true" />
          <relationshipAttribute from="siteid" to="siteid" />
          <relationshipAttribute to="class" literal="WORKORDER" quoteLiteral="true" />
        </relationship>
        <relationship to="matusetrans" collection="true">
          <relationshipAttribute from="wonum" to="refwo" primary="true" />
          <relationshipAttribute from="siteid" to="siteid" />
        </relationship>
        <relationship to="labtrans" collection="true">
          <relationshipAttribute from="wonum" to="refwo" primary="true" />
          <relationshipAttribute from="siteid" to="siteid" />
        </relationship>
        <relationship to="location" >
          <relationshipAttribute from="location" to="location" primary="true"/>
          <relationshipAttribute from="siteid" to="siteid" />
        </relationship>
        <relationship to="asset" >
          <relationshipAttribute from="assetnum" to="assetnum" primary="true"/>
          <relationshipAttribute from="siteid" to="siteid" />
        </relationship>
        <relationship to="failurecode" >
          <relationshipAttribute from="failurecode" to="failurecode" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid" />
        </relationship>
        <relationship to="worktype" >
          <relationshipAttribute from="worktype" to="worktype" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid" />
        </relationship>
        <relationship to="glcomponents">
          <relationshipAttribute from="glaccount" to="compvalue" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid" />
          <relationshipAttribute to="glorder" literal="0" quoteLiteral="true"/>
        </relationship>
        <!--COMSW 51 Reverse Lookup of Service Address (Lazy Fetch)-->
        <relationship to="woaddress" reverselookupattribute="addresscode" >
          <relationshipAttribute from="wonum" to="woserviceaddress_.wonum" primary="true"/>
        </relationship>
        <relationship to="woserviceaddress">
          <relationshipAttribute from="wonum" to="wonum" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid"/>
          <relationshipAttribute from="siteid" to="siteid"/>
        </relationship>
        <relationship to="synonymdomain" qualifier="synstatus">
          <relationshipAttribute from="status" to="value" primary="true"/>
          <relationshipAttribute to="domainid" literal="WOSTATUS" quoteLiteral="true" />
        </relationship>
        <relationship to="longdescription" >
          <relationshipAttribute from="workorderid" to="ldkey" primary="true"/>
          <relationshipAttribute to="ldownertable" literal="WORKORDER" quoteLiteral="true" />
          <relationshipAttribute to="ldownercol" literal="DESCRIPTION" quoteLiteral="true" />
        </relationship>
        <relationship to="DOCLINKS" qualifier="attachment" collection="true">
          <relationshipAttribute from="workorderid" to="ownerid" primary="true"/>
          <relationshipAttribute to="ownertable" literal="WORKORDER" quoteLiteral="true"/>
        </relationship>
        <relationship to="tooltrans" collection="true">
          <relationshipAttribute from="wonum" to="refwo" primary="true" />
          <relationshipAttribute from="siteid" to="siteid" />
        </relationship>
      </relationships>
      <connectorParameters>
        <connectorParameter key="integration_interface" value="SWWO" />
        <connectorParameter key="customconnector" value="softWrench.sW4.Data.Persistence.WS.Applications.Workorder.BaseWorkOrderCrudConnector" />
      </connectorParameters>
    </entity>

    <entity name="labtrans" idAttribute="labtransid">
      <relationships>
        <relationship to="labor">
          <relationshipAttribute from="laborcode" to="laborcode" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid" />
        </relationship>
        <relationship to="laborcraftrate">
          <relationshipAttribute from="craft" to="craft" primary="true"/>
          <relationshipAttribute from="laborcode" to="laborcode"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>
        <relationship to="glcomponents">
          <relationshipAttribute from="gldebitacct" to="compvalue" primary="true"/>
          <relationshipAttribute to="glorder" literal="0" quoteLiteral="true"/>
        </relationship>
      </relationships>
    </entity>

    <entity name="matusetrans" idAttribute="matusetransid" >
      <relationships>
        <relationship to="inventory">
          <relationshipAttribute from="itemnum" to="itemnum" primary="true"/>
          <relationshipAttribute from="siteid" to="siteid" />
          <relationshipAttribute to="status" literal="ACTIVE"/>
        </relationship>
        <relationship to="item">
          <relationshipAttribute from="itemnum" to="itemnum" primary="true"/>
          <relationshipAttribute from="itemsetid" to="itemsetid"/>
          <relationshipAttribute to="itemtype" literal="ITEM" quoteLiteral="true"/>
          <relationshipAttribute to="status" literal="ACTIVE" quoteLiteral="true"/>
        </relationship>
        <relationship to="location" qualifier="storeroom">
          <relationshipAttribute from="siteid" to="siteid" primary="true" />
          <relationshipAttribute to="type" literal="STOREROOM" quoteLiteral="true" />
        </relationship>
        <relationship to="invbalances" qualifier="invbal" >
          <relationshipAttribute from="itemnum" to="itemnum" primary="true" />
          <relationshipAttribute from="location" to="location" />
          <relationshipAttribute from="siteid" to="siteid" />
        </relationship>
        <relationship to="glcomponents">
          <relationshipAttribute from="gldebitacct" to="compvalue" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid" />
          <relationshipAttribute to="glorder" literal="0" quoteLiteral="true"/>
        </relationship>
        <relationship to="inventory" qualifier="offlineinventory">
          <relationshipAttribute from="itemnum" to="itemnum" primary="true"/>
          <relationshipAttribute to="status" literal="ACTIVE"/>
        </relationship>
        <relationship to="item" qualifier="offlineitem">
          <relationshipAttribute from="itemnum" to="itemnum" primary="true"/>
          <relationshipAttribute from="itemsetid" to="itemsetid"/>
          <relationshipAttribute to="itemtype" literal="ITEM" quoteLiteral="true"/>
          <relationshipAttribute to="status" literal="ACTIVE" quoteLiteral="true"/>
          <relationshipAttribute to="rotating" literal="0" quoteLiteral="true"/>
        </relationship>
        <relationship to="location" qualifier="offlinelocation">
          <relationshipAttribute from ="storeloc" to="location" primary="true" />
          <relationshipAttribute to="type" literal="STOREROOM" quoteLiteral="true" />
          <relationshipAttribute to="status" literal="OPERATING" quoteLiteral="true" />
        </relationship>
      </relationships>
    </entity>

    <entity name="tooltrans" idAttribute="tooltransid">
      <relationships>
        <relationship to="toolitem" qualifier="tool" >
          <relationshipAttribute from="itemnum" to="itemnum" primary="true" />
          <relationshipAttribute from="itemsetid" to="itemsetid" />
        </relationship>
        <relationship to="glcomponents">
          <relationshipAttribute from="gldebitacct" to="compvalue" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid" />
          <relationshipAttribute to="glorder" literal="0" quoteLiteral="true"/>
        </relationship>
      </relationships>
    </entity>
  </entities>

  <applications>


    <application entity="SR" name="servicerequest" title="Service Request">
      <schemas>
        <schema id="newdetail" platform="web" redeclaring="false">
          <customization position="classstructureid"></customization>
          <customization position="saddresscode"></customization>
        </schema>
        <schema id="editdetail" platform="web" redeclaring="false">
          <customization position="classstructureid"></customization>
          <customization position="saddresscode"></customization>
        </schema>

        <schema id="nologinnewdetail" stereotype="detailnew" title="Service Request Details">
          <reference id="srhiddens"/>
          <section orientation="horizontal">
            <header label="Contact" params="fieldset=true"/>
            <field attribute="name" label="Name" requiredexpression="true" helpicon="right" tooltip="Please enter your first and last name. "/>
            <field attribute="email" label="Email Address" requiredexpression="true" helpicon="right" tooltip="Please enter your Southwest Gas email address. ">
              <renderer type="default" params="valtype=custom;valmessage=An '@swgas.com' email is required.;valflags=i">
                <parameter key="valpattern" value="^(([^&lt;&gt;()\[\]\.,;:\s@\&quot;]+(\.[^&lt;&gt;()\[\]\.,;:\s@\&quot;]+)*)|(\&quot;.+\&quot;))@swgas\.com$"/>
              </renderer>
            </field>

            <section>

              <field attribute="phoneext" label="Phone Number" requiredexpression="true" helpicon="right" tooltip="Please provide the phone number that the technician can reach you at if they have any questions about the work">
                <renderer type="default" params="inputmaxlength=10;mask=(999) 999-9999;mask-modelvalue=true"/>
              </field>
              <field label="Please provide a phone number where a technician may reach you" attribute="#phonelabel">
                <renderer type="label"/>
              </field>
            </section>
          </section>


          <section>
            <header label="Details" params="fieldset=true"/>
            <field attribute="summary" label="Summary" requiredexpression="true" helpicon="right" tooltip="Please enter a brief summary of your work request."/>

            <field label="To ensure the best customer service, please provide the technician with the best details of the work requested" attribute="#desclabel">
              <renderer type="label"/>
            </field>

            <field attribute="description" label="Description" requiredexpression="true" helpicon="right" tooltip="To ensure the best customer service, please provide the technician with the best details of the work requested">
              <renderer type="textarea"/>
            </field>
            


            <composition inline="true" relationship="#attachments" label="Attachments" detailschema="" fetchtype="lazy">
              <renderer type="fileexplorer" params="acceptedFileExtensions=sw_all_types;showdownloadall=false"/>
            </composition>

            <optionfield attribute="requrgency" label="Request Urgency" requiredexpression="true" helpicon="right" tooltip="Please enter the work request urgency. " sort="true" default="routine">
              <option label="Emergency" value="emergency"/>
              <option label="Urgent" value="urgency"/>
              <option label="Routine" value="routine"/>
              <option label="Renovation" value="renovation"/>
            </optionfield>

            <field label="Affected Personnel" attribute="affectpersonnel" helpicon="right" tooltip="If you are entering this work request on behalf of someone, please enter their name here. "/>

          </section>

          <section orientation="horizontal">
            <header params="fieldset=true" label="Location"></header>
            <optionfield attribute="division" label="Division" defaultexpression="null" default="null" requiredexpression="true" helpicon="right" tooltip="Please select the division where the work is being requested. ">
              <option label="CAZ" value="CAZ"/>
              <option label="CORP" value="CORP"/>
              <option label="NNV" value="NNV"/>
              <option label="SAZ" value="SAZ"/>
              <option label="SCA" value="SCA"/>
              <option label="SNV" value="SNV"/>
              <event type="afterchange" service="swgasNoLoginSubmitService" method="loadCities"/>
            </optionfield>

            <optionfield attribute="city" label="Site" providerattribute="#city" enableexpression="@division!='null'" skipvalidation="true" requiredexpression="true" helpicon="right" tooltip="Please select the site where the work is being requested.">
              <event type="afterchange" service="swgasNoLoginSubmitService" method="loadBuildings"/>
            </optionfield>

            <optionfield attribute="locationb" label="Location/Bldg" providerattribute="#locbuilding" enableexpression="@city!=null" skipvalidation="true" requiredexpression="true" helpicon="right" tooltip="Please select the location where the work is being requested."/>
          </section>

          <section resourcepath="/Content/Customers/swgas/htmls/templates/submitbutton.html"/>


          <event type="onschemafullyloaded" service="swgasNoLoginSubmitService" method="loadOptionFields"/>

          <commandbars>
            <commandgroup position="detail.primary">
              <removecommand id="cancel"/>
              <removecommand id="save"/>
              <removecommand id="print"/>
              <command id="submit" icon="fa-check" service="swgasNoLoginSubmitService" method="submit" label="Submit" cssclasses="large-button" tooltip="Submit Request" enableexpression="$scope:enableSave"/>
            </commandgroup>
          </commandbars>

          <properties>
            <property key="detail.show.toolbar.anonymous" value="true"/>
          </properties>
        </schema>

      </schemas>
    </application>
    <application entity="workorder" name="workorder" title="Work Order">

      <properties>
        <property key="list.offline.text.indexlist" value="wonum,asset_.description,status,description"/>
        <property key="list.offline.date.indexlist" value="schedstart"/>
      </properties>

      <schemas>
        <schema id="newdetail" platform="web" redeclaring="false">
          <!--<customization position="classstructureid"></customization>-->
          <customization position="failurecode"></customization>
          <customization position="problemcode"></customization>
          <customization position="glaccount"></customization>
        </schema>
        <schema id="editdetail" platform="web" redeclaring="false">
          <!--<customization position="classstructureid"></customization>-->
          <customization position="failurecode"></customization>
          <customization position="problemcode"></customization>
          <customization position="glaccount"></customization>
        </schema>
        <schema id="list" redeclaring="false" platform="web" stereotype="list">
          <filters>
            <optionfilter attribute="worktype">
              <option xmlns="http://www.controltechnologysolutions.com/filters" label="PM" value="pm" />
              <option xmlns="http://www.controltechnologysolutions.com/filters" label="Other" value="!pm" />
            </optionfilter>
          </filters>

          <customization position="description">
            <field attribute="description" label="Summary">
              <renderer type="default" params="excelwidth=50;width=20%" />
            </field>
          </customization>

          <customization position="+siteid">
            <field attribute="worktype" label="Work Type"/>
            <field attribute="schedstart" label="Scheduled Start Date">
              <renderer type="datetime" params="width=10%"/>
            </field>
          </customization>


          <properties>
            <property key="list.defaultorderby" value="workorder.reportdate desc"/>
          </properties>
        </schema>


        <detail platform="mobile" title="Work Order">
          <reference id="detailhiddensoffline"/>

          <field attribute="owner" label="Owner"  readonly="true"/>

          <reference id="statuslookup"/>
          <field attribute="wopriority" label="Priority">
            <renderer type="numericinput" params="min=1;max=5;decimals=0"/>
            <number decimals="0" min="0" max="999" />
          </field>

          <field attribute="assetnum" label="Asset">
            <renderer type="custom" params="resourcepath=Content/Customers/firstsolar_offline/templates/fslocationdrilldownbutton.html"/>
          </field>
          <association label="Location" target="location" labelfield="location.description" showexpression="false"/>

          <!-- do not remove - added to force the sync of assets -->
          <association label="Asset" target="assetnum" labelfield="asset.description" showexpression="false"/>

          <association label="Failure Class" target="failurecode" labelfield="failurecode.description" />
          <association label="Work Type" target="worktype" labelfield="worktype.wtypedesc" />
          <association label="GL Account" target="glaccount" labelfield="chartofaccounts.accountname" />
          <field attribute="description" label="Description" />
          <field label="Details" attribute="ld_.ldtext">
            <renderer type="richtext"/>
          </field>
          <field label="Reported Date" attribute="reportdate" readonly="true">
            <renderer type="datetime"/>
          </field>

          <field label="Scheduled Start Date" attribute="schedstart" readonly="true">
            <renderer type="datetime"/>
          </field>

          <composition relationship="labtrans" label="Labor">
            <event type="beforedelete" service="laborService" method="confirmPossibleTimer"/>
            <event type="afterdelete" service="laborService" method="cancelPossibleTimer"/>
            <collectionproperties allowupdate="false" allowcreation="@originalstatus!='CLOSED'" />
          </composition>
          <composition relationship="attachment" label="Attachments">
            <collectionproperties prefilterfunction="BuildRelatedAttachmentsWhereClause"/>
          </composition>

          <composition relationship="matusetrans" label="Material" >
            <collectionproperties allowupdate="false" allowcreation="@status!=='CLOSE'"/>
          </composition>


          <commandbars>
            <commandgroup platform="mobile" position="mobile.fab" removeundeclared="false">
              <container id="detail.container" icon="fa-bolt">
                <!-- TODO: currently no support for merging command containers so repeating base commands -->
                <command id="quicksync"
                         service="itemActionService" method="quickSyncCurrentItem"
                         showexpression="service:itemActionService.shouldAllowQuickSyncForCurrentItem"
                         icon="ion-loop" label="Quick Sync"/>
                <command id="restoreitem"
                         service="itemActionService" method="deleteOrRestoreCurrentItem"
                         showexpression="service:itemActionService.shouldAllowDeleteOrRestoreForCurrentItem"
                         icon="ion-trash-a" label="Delete/Restore" cssclasses="red" />

                <command id="startlabtrans" service="laborService" method="startLaborTransaction"
                         showexpression="service:laborService.shouldAllowLaborStart"
                         icon="ion-play" label="Start Labor Report" cssclasses="green"/>
                <command id="finishlabtrans" service="laborService" method="finishLaborTransaction"
                         showexpression="service:laborService.shouldAllowLaborFinish"
                         icon="ion-stop" label="Finish Labor Report" cssclasses="red" />
              </container>
            </commandgroup>
          </commandbars>

        </detail>

        <schema id="newdetail" stereotype="detailnew" platform="mobile" redeclaring="true">
          <field attribute="wopriority" label="Priority" default="1">
            <renderer type="numericinput" params="min=1;max=5;decimals=0"/>
            <number decimals="0" min="0" max="5" />
          </field>

          <field attribute="assetnum" label="Asset">
            <renderer type="custom" params="resourcepath=Content/Customers/firstsolar_offline/templates/fslocationdrilldownbutton.html"/>
          </field>
          <association label="Location" target="location" labelfield="location.description" showexpression="false"/>

          <association label="Failure Class" target="failurecode" labelfield="failurecode.description" />
          <association label="Work Type" target="worktype" labelfield="worktype.wtypedesc" />
          <association label="GL Account" target="glaccount" labelfield="chartofaccounts.accountname" />
          <field attribute="description" label="Description" />
          <field label="Details" attribute="ld_.ldtext">
            <renderer type="richtext"/>
          </field>
        </schema>


      </schemas>
    </application>
    <application name="labtrans" entity="labtrans" title="Labor">
      <schemas>
        <detail platform="web" redeclaring="false" >
          <customization position="starttime"></customization>
          <customization position="finishdate"></customization>
          <customization position="finishtime"></customization>
          <customization position="gldebitacct">
            <field label="GL Debit Account:" attribute="gldebitacct" default="0000-000-000-00000" hidden="true" />
          </customization>
        </detail>
      </schemas>
    </application>
    <application name="matusetrans" title="Materials" entity="matusetrans" id="00000000-0000-0000-0000-000000000009">
      <schemas>
        <detail platform="web" redeclaring="false">
          <customization position="gldebitacct">
            <field label="GL Debit Account:" attribute="gldebitacct" default="0000-000-000-00000" hidden="true" />
          </customization>
        </detail>

        <list stereotype="compositionlist" platform="mobile">
          <field attribute="itemnum" label="Item#" />
          <field attribute="description" label="Description" />
          <field attribute="linetype" label="Type" />
          <field attribute="storeloc" label="Storeroom" />
          <field attribute="qtyrequested" label="Quantity" />
          <field attribute="unitcost" showexpression="@linetype==='MATERIAL'" label="Unit Cost">
            <renderer type="default" params="formatter=money"/>
          </field>
          <field attribute="transdate" label="Created Date" >
            <renderer type="datetime" params="format=MM/dd/yyyy HH:mm;showtime=true"/>
          </field>
        </list>

        <detail stereotype="compositiondetail" platform="mobile">
          <!-- declared just so it can be fetched in sync -->
          <association target="#inventory" labelfield="offlineinventory.itemnum"
                       showexpression="false" enableexpression="false"
                       label="#inventory" />

          <field attribute="matusetransid" hidden="true" />
          <field attribute="refwo" hidden="true" />
          <field attribute="orgid" defaultexpression="$.parentdata.fields.orgid" hidden="true" />
          <field attribute="siteid" defaultexpression="$.parentdata.fields.siteid" hidden="true" />

          <field attribute="transdate" hidden="true" defaultexpression="@now" >
            <renderer type="datetime" params="format=MM/dd/yyyy HH:mm;showtime=true"/>
          </field>

          <optionfield attribute="linetype" label="Type" default="ITEM">
            <event type="afterchange" service="materialService" method="lineSelected"/>
            <option label="ITEM" value="ITEM"/>
            <option label="MATERIAL" value="MATERIAL"/>
          </optionfield>

          <association target="storeloc" labelfield="offlinelocation_.location"
                       showexpression="@linetype==='ITEM'" requiredexpression="@linetype==='ITEM'"
                       label="Storeroom">
            <dataprovider whereClause="@materialService.getStoreRoomWhereClause"/>
            <event type="afterchange" service="materialService" method="storeRoomSelected"/>
          </association>

          <association target="itemnum" labelfield="offlineitem_.description" extraprojectionvalues="description"
                       showexpression="@linetype==='ITEM'" requiredexpression="@linetype==='ITEM'"
                       label="Item" >
            <dataprovider whereClause="@materialService.getAvailableItemsWhereClause"/>
            <event type="afterchange" service="materialService" method="itemSelected"/>
          </association>

          <!--          <association target="warranty" labelfield="warranty_.description" requiredexpression="true" label="Warranty">-->
          <!--            <renderer type="lookup" params="showCode=false"/>-->
          <!--          </association>-->

          <field attribute="description" label="Material Description" requiredexpression="true" showexpression="@linetype==='MATERIAL'"/>
          <field attribute="unitcost" label="Unit Cost" qualifier="quantity" requiredexpression="@linetype==='MATERIAL'" showexpression="@linetype==='MATERIAL'">
            <renderer type="numericinput" params="min=0;step=0.01" />
          </field>

          <field attribute="qtyrequested" label="Quantity" requiredexpression="true" qualifier="quantity" default="1">
            <renderer type="numericinput" params="min=1;max=100;decimals=0;step=1"/>
          </field>

        </detail>

      </schemas>
    </application>


    <application name="offlineitem" entity="item" title="Item">
      <schemas>
        <list platform="mobile">
          <field attribute="itemnum" label="Item" />
          <field attribute="description" label="Description"/>
          <field attribute="status" label="Status"/>
          <field attribute="itemtype" label="Type"/>
          <field attribute="rotating" label="Rotating"/>
          <field attribute="commoditygroup" label="Commodity Group"/>
        </list>
      </schemas>
      <properties>
        <property key="list.offline.text.indexlist" value="itemnum"/>
      </properties>
    </application>

  </applications>
</metadata>