<?xml version="1.0" encoding="utf-8" ?>
<metadata xmlns="http://www.controltechnologysolutions.com/metadata">
  <templates>
    <!--ServiceRequest-->
    <template path="@servicerequest.xml"/>
    
    <!--WorkOrder-->
    <template path="@workorder.xml"/>

    <template path="@tooltrans.xml"/>
    <template path="@materials.xml"/>
    <template path="@labtrans.xml"/>
    <template path="@woactivity.xml"/>
  </templates>

  <entities>
    <entity name ="failurelistonly" parententity="failurelist" idAttribute="failurelist" whereclause="((failurelistonly.TYPE is null)) " >
    </entity>

    <entity name ="problemlist" parententity="failurelist" idAttribute="failurelist" whereclause="((problemlist.TYPE like 'PROBLEM')) " >
    </entity>

    <entity name="ALNDOMAIN" idAttribute="domainid">
      <attributes>
        <attribute name="domainid" type="varchar" required="true" />
        <attribute name="value" type="varchar" required="true" />
        <attribute name="description" type="varchar" required="false" />
        <attribute name="siteid" type="varchar" required="false" />
        <attribute name="orgid" type="varchar" required="false" />
        <attribute name="alndomainid" type="bigint" required="true" />
        <attribute name="valueid" type="varchar" required="true" />
        <attribute name="rowstamp" type="timestamp" required="true" />
      </attributes>
      <connectorParameters>
        <connectorParameter key="dbtable" value="ALNDOMAIN" />
      </connectorParameters>
    </entity>

    <entity name="workorder" idAttribute="wonum">
      <relationships>
        <relationship to="ALNDOMAIN" qualifier="division">
          <relationshipAttribute from="division" to="value" primary="true"/>
          <relationshipAttribute to="domainid" literal="DIVISION" quoteLiteral="true" />
        </relationship>
        <relationship to="worklog" collection="true">
          <relationshipAttribute from="wonum" to="recordkey" primary="true" />
          <relationshipAttribute from="siteid" to="siteid" />
          <relationshipAttribute to="class" literal="WORKORDER" quoteLiteral="true" />
        </relationship>
        <relationship to="matusetrans" collection="true">
          <relationshipAttribute from="wonum" to="refwo" primary="true" />
          <relationshipAttribute from="siteid" to="siteid" />
        </relationship>
        <relationship to="labtrans" collection="true">
          <relationshipAttribute from="wonum" to="refwo" primary="true" />
          <relationshipAttribute from="siteid" to="siteid" />
        </relationship>
        <relationship to="location" >
          <relationshipAttribute from="location" to="location" primary="true"/>
          <relationshipAttribute from="siteid" to="siteid" />
        </relationship>
        <relationship to="asset" >
          <relationshipAttribute from="assetnum" to="assetnum" primary="true"/>
          <relationshipAttribute from="siteid" to="siteid" />
        </relationship>
        <relationship to="failurecode" >
          <relationshipAttribute from="failurecode" to="failurecode" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid" />
        </relationship>
        <relationship to="worktype" >
          <relationshipAttribute from="worktype" to="worktype" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid" />
        </relationship>
        <relationship to="glcomponents">
          <relationshipAttribute from="glaccount" to="compvalue" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid" />
          <relationshipAttribute to="glorder" literal="0" quoteLiteral="true"/>
        </relationship>
        <!--COMSW 51 Reverse Lookup of Service Address (Lazy Fetch)-->
        <relationship to="woaddress" reverselookupattribute="addresscode" >
          <relationshipAttribute from="wonum" to="woserviceaddress_.wonum" primary="true"/>
        </relationship>
        <relationship to="woserviceaddress">
          <relationshipAttribute from="wonum" to="wonum" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid"/>
          <relationshipAttribute from="siteid" to="siteid"/>
        </relationship>
        <relationship to="synonymdomain" qualifier="synstatus">
          <relationshipAttribute from="status" to="value" primary="true"/>
          <relationshipAttribute to="domainid" literal="WOSTATUS" quoteLiteral="true" />
        </relationship>
        <relationship to="longdescription" >
          <relationshipAttribute from="workorderid" to="ldkey" primary="true"/>
          <relationshipAttribute to="ldownertable" literal="WORKORDER" quoteLiteral="true" />
          <relationshipAttribute to="ldownercol" literal="DESCRIPTION" quoteLiteral="true" />
        </relationship>
        <relationship to="DOCLINKS" qualifier="attachment" collection="true">
          <relationshipAttribute from="workorderid" to="ownerid" primary="true"/>
          <relationshipAttribute to="ownertable" literal="WORKORDER" quoteLiteral="true"/>
        </relationship>
        <relationship to="tooltrans" collection="true">
          <relationshipAttribute from="wonum" to="refwo" primary="true" />
          <relationshipAttribute from="siteid" to="siteid" />
        </relationship>
      </relationships>
      <connectorParameters>
        <connectorParameter key="integration_interface" value="SWWO" />
        <connectorParameter key="customconnector" value="softWrench.sW4.Data.Persistence.WS.Commons.BaseWorkOrderCrudConnector" />
      </connectorParameters>
    </entity>

    <entity name="labtrans" idAttribute="labtransid">
      <relationships>
        <relationship to="labor">
          <relationshipAttribute from="laborcode" to="laborcode" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid" />
        </relationship>
        <relationship to="laborcraftrate">
          <relationshipAttribute from="craft" to="craft" primary="true"/>
          <relationshipAttribute from="laborcode" to="laborcode"/>
          <relationshipAttribute from="orgid" to="orgid"/>
        </relationship>
        <relationship to="glcomponents">
          <relationshipAttribute from="gldebitacct" to="compvalue" primary="true"/>
          <relationshipAttribute to="glorder" literal="0" quoteLiteral="true"/>
        </relationship>
      </relationships>
    </entity>

    <entity name="matusetrans" idAttribute="matusetransid" >
      <relationships>
        <relationship to="inventory">
          <relationshipAttribute from="itemnum" to="itemnum" primary="true"/>
          <relationshipAttribute from="siteid" to="siteid" />
          <relationshipAttribute to="status" literal="ACTIVE"/>
        </relationship>
        <relationship to="item">
          <relationshipAttribute from="itemnum" to="itemnum" primary="true"/>
          <relationshipAttribute from="itemsetid" to="itemsetid"/>
          <relationshipAttribute to="itemtype" literal="ITEM" quoteLiteral="true"/>
          <relationshipAttribute to="status" literal="ACTIVE" quoteLiteral="true"/>
        </relationship>
        <relationship to="location" qualifier="storeroom">
          <relationshipAttribute from="siteid" to="siteid" primary="true" />
          <relationshipAttribute to="type" literal="STOREROOM" quoteLiteral="true" />
        </relationship>
        <relationship to="invbalances" qualifier="invbal" >
          <relationshipAttribute from="itemnum" to="itemnum" primary="true" />
          <relationshipAttribute from="location" to="location" />
          <relationshipAttribute from="siteid" to="siteid" />
        </relationship>
        <relationship to="glcomponents">
          <relationshipAttribute from="gldebitacct" to="compvalue" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid" />
          <relationshipAttribute to="glorder" literal="0" quoteLiteral="true"/>
        </relationship>
      </relationships>
    </entity>

    <entity name="tooltrans" idAttribute="tooltransid">
      <relationships>
        <relationship to="toolitem" qualifier="tool" >
          <relationshipAttribute from="itemnum" to="itemnum" primary="true" />
          <relationshipAttribute from="itemsetid" to="itemsetid" />
        </relationship>
        <relationship to="glcomponents">
          <relationshipAttribute from="gldebitacct" to="compvalue" primary="true"/>
          <relationshipAttribute from="orgid" to="orgid" />
          <relationshipAttribute to="glorder" literal="0" quoteLiteral="true"/>
        </relationship>
      </relationships>
    </entity>
  </entities>

  <applications>
    <application name="workorder" title="Work Order" entity="workorder">      
      <schemas>
        <schema id="editdetail" platform="web" redeclaring="false">
          <customization position="+wonum">
            <!--COMSW-2-->
            <association label="Division:" target="division" labelfield="division_.description" requiredexpression="true">
              <renderer type="lookup"/>
            </association>
          </customization>
          <customization position="classstructureid">
            <optionfield attribute="classstructureid" label="Classification:" providerattribute="_WOClassStructureType" requiredexpression="true">
              <renderer type="autocompleteclient" />
            </optionfield>
          </customization>
          <customization position="glaccount">
            <association label="GL Account:" target="glaccount" labelfield="glcomponents_.comptext">
              <renderer type="lookup"/>
            </association>
          </customization>
        </schema>
        
        <schema id="newdetail" platform="web" redeclaring="false">
          
        </schema>
      </schemas>
    </application>

    <application name="labtrans" entity="labtrans" title="Labor">
      <schemas>
        <list>
          <field attribute="labtransid" hidden="true"/>
          <field attribute="laborcode" label="Labor" qualifier="title"/>
          <field attribute="regularhrs" label="Regular Hours" qualifier="subtitle"/>
          <field attribute="gldebitacct" label="GL Debit Account" qualifier="subtitle"/>
        </list>

        <detail platform="web">
          <field attribute="labtransid" hidden="true"/>
          <field attribute="orgid" hidden="true"/>
          <field attribute="siteid" hidden="true"/>
          <field attribute="laborcode" hidden="true" />
          <field attribute="transtype" hidden="true" />
          <field attribute="refwo" hidden="true" />
          <field attribute="enterby" hidden="true" />
          <field attribute="payrate" hidden="true" />
          <field attribute="transtype" default="WORK" hidden="true"/>
          <association label="Labor:" requiredexpression="true" target="laborcode" labelfield="labor_.laborcode" defaultexpression="ctx:getUserData().login.toUpperCase()">
            <renderer type="lookup"/>
            <event type="afterchange" service="labtranService" method="afterlaborchange"/>
          </association>
          <association label="Craft:" requiredexpression="true" target="craft" labelfield="laborcraftrate_.craft" dependantfields="laborcode" extraprojectionvalues="defaultcraft, rate">
            <event type="afterchange" service="labtranService" method="aftercraftchange"/>
          </association>
          <field label="Start Date:" requiredexpression="true" attribute="startdate" default="@currentdatetime">
            <renderer type="datetime" params="format=MM/dd/yyyy;showtime=false;allowfuture=false" />
          </field>
          <field attribute="regularhrs" label="Regular Hours:" requiredexpression="true" default="8"/>
          <association label="GL Debit Account:" requiredexpression="true" target="gldebitacct" labelfield="glcomponents_.comptext">
            <renderer type="lookup"/>
          </association>
        </detail>
      </schemas>
    </application>

    <application name="matusetrans" title="Materials" entity="matusetrans" id="00000000-0000-0000-0000-000000000009">
      <properties>
        <property key ="icon.composition.tab" value="fa fa-suitcase"/>
      </properties>
      <schemas>
        <list>
          <field attribute="matusetransid" hidden="true" />
          <field attribute="itemnum" label="Item No." qualifier="title"/>
          <field attribute="description" label="Description" qualifier="subtitle"/>
          <field attribute="linetype" label="Type" qualifier="subtitle"/>
          <field attribute="storeloc" label="Storeroom" qualifier="subtitle"/>
          <field attribute="qtyrequested" label="Quantity" qualifier="subtitle"/>
        </list>

        <detail platform="web">
          <field attribute="matusetransid" hidden="true" />
          <field attribute="orgid" defaultexpression="$.previousdata.fields['orgid']" hidden="true" />
          <field attribute="siteid" defaultexpression="$.previousdata.fields['siteid']" hidden="true" />
          <field attribute="refwo" defaultexpression="$.previousdata.fields['wonum']" hidden="true" />
          <field attribute="description" hidden="true" />
          <field attribute="transdate" hidden="true" />

          <field attribute="lotnum" hidden="true" />
          <field attribute="binnum" hidden="true" />
          <field attribute="costtype" hidden="true" />
          <field attribute="unitcost" hidden="true" />

          <optionfield attribute="linetype" label="Type:">
            <renderer type="combo"/>
            <option label="ITEM" value="ITEM"/>
            <option label="MATERIAL" value="MATERIAL"/>
          </optionfield>
          <association label="Item:" target="itemnum" labelfield="item_.description" extraprojectionvalues="description" showexpression="@linetype == 'ITEM'">
            <dataprovider prefilterfunction="filterPlannedMaterials"/>
            <renderer type="lookup"/>
            <event type="afterchange" service="matusetranService" method="afteritemchange"/>
          </association>
          <association label="Storeroom:" target="storeloc" labelfield="0invbal_.location" dependantfields="itemnum" showexpression="@linetype == 'ITEM'">
            <dataprovider postfilterfunction="filterStoreLoc"/>
            <event type="afterchange" service="matusetranService" method="afterstorelocchange"/>
          </association>
          <association label="Bin:" target="binnum" labelfield="1invbal_.binnum" dependantfields="itemnum" showexpression="@linetype == 'ITEM'">
            <dataprovider postfilterfunction="filterBinnum"/>
            <event type="afterchange" service="matusetranService" method="afterchange"/>
          </association>
          <association label="Lot:" target="lotnum" labelfield="2invbal_.lotnum" dependantfields="itemnum" showexpression="@linetype == 'ITEM'">
            <dataprovider postfilterfunction="filterLotnum"/>
            <event type="afterchange" service="matusetranService" method="afterchange"/>
          </association>
          <field label="Available Balances:" attribute="curbal" readonly="true" showexpression="@linetype=='ITEM'"/>
          <field attribute="unitcost" label="Unit Cost:" qualifier="quantity" readonly="true" showexpression="@linetype == 'ITEM'"/>

          <field attribute="description" label="Material Description:" requiredexpression="true" showexpression="@linetype == 'MATERIAL'"/>
          <field attribute="unitcost" label="Unit Cost:" qualifier="quantity" requiredexpression="@linetype == 'MATERIAL'" showexpression="@linetype == 'MATERIAL'"/>

          <field attribute="qtyrequested" label="Quantity:" requiredexpression="true" qualifier="quantity">
            <renderer type="numericinput" params="min=1;max=100;decimals=0"/>
          </field>
          <association label="GL Debit Account:" target="gldebitacct" labelfield="glcomponents_.comptext">
            <renderer type="lookup"/>
          </association>
        </detail>
      </schemas>
    </application>

    <application name="tooltrans" entity="tooltrans" title="Tools">
      <properties>
        <property key ="icon.composition.tab" value="fa fa-wrench"/>
      </properties>
      <schemas>
        <list>
          <field attribute="tooltransid" hidden="true"/>
          <field attribute="itemnum" label="Item No." qualifier="title"/>
          <field attribute="tool_.description" label="Description" qualifier="subtitle"/>
          <field attribute="toolqty" label="Quantity" qualifier="subtitle"/>
          <field attribute="toolhrs" label="Hours" qualifier="subtitle"/>
          <field attribute="gldebitacct" label="GL Debit Account" qualifier="subtitle"/>
        </list>

        <detail platform="web">
          <field attribute="tooltransid" hidden="true" />
          <field attribute="orgid" hidden="true" />
          <field attribute="siteid" hidden="true" />
          <field attribute="refwo" hidden="true" />
          <field attribute="transdate" hidden="true" />
          <field attribute="toolrate" hidden="true" />

          <association label="Tool:" target="itemnum" labelfield="tool_.description" requiredexpression="true" extraprojectionvalues="itemnum, itemsetid">
            <renderer type="lookup"/>
            <event type="afterchange" service="tooltranService" method="aftertoolchange"/>
          </association>
          <field label="Quantity:" attribute="toolqty" requiredexpression="true">
            <renderer type="numericinput" params="min=1;max=100;decimals=0"/>
          </field>
          <field label="Hour:" attribute="toolhrs" requiredexpression="true" default="8">
            <renderer type="numericinput" params="min=1;max=100;decimals=0"/>
          </field>
          <field label="Rate:" attribute="toolrate" readonly="true"/>
          <association label="GL Debit Account:"  target="gldebitacct" labelfield="glcomponents_.comptext">
            <renderer type="lookup"/>
          </association>
        </detail>
      </schemas>
    </application>

    <application name="worklog" title="Work Logs"  entity="worklog" id="00000000-0000-0000-0000-000000000008">
      <properties>
        <property key="mobile.userInteractionEnabled" value="false"/>
        <property key="mobile.fetchlimit" value="300"/>
        <property key="list.schema.mode" value="input"/>
        <property key ="icon.composition.tab" value="fa fa-comment-o"/>
      </properties>
      <schemas>
        <detail stereotype="compositiondetail">
          <field attribute="description" label="Summary:" requiredexpression="true" />
          <field attribute="longdescription_.ldtext" label="Details:" >
            <renderer type="textarea"/>
          </field>
          <optionfield attribute="logtype" label="Log Type:" default="CLIENTNOTE" requiredexpression="true">
            <option label="Appointment Note" value="APPTNOTE"/>
            <option label="Client Note" value="CLIENTNOTE"/>
            <option label="Update" value="UPDATE"/>
            <option label="Work" value="WORK"/>
          </optionfield>
          <optionfield attribute="clientviewable" label="Client Viewable:" default="0" requiredexpression="true">
            <option label="Yes" value="1"/>
            <option label="No" value="0"/>
          </optionfield>
        </detail>
      </schemas>
    </application>

  </applications>
</metadata>